import"./modulepreload-polyfill-YP0FEG5d.js";import{f as e}from"./admin-app-shell-Cas55neG.js";import{a as t,c as n}from"./shared-utils-DEXrBstL.js";import{collectionGroup as s,query as a,orderBy as i,onSnapshot as o,doc as d,getDoc as r}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";let c=[],l=new Map,u=null;const m={devicesTableBody:document.getElementById("devices-table-body"),devicesEmptyState:document.getElementById("devices-empty-state"),devicesLoadingState:document.getElementById("devices-loading-state"),searchInput:document.getElementById("device-search-input"),totalDeviceCount:document.getElementById("total-device-count")};function v(e,t){m.devicesTableBody.innerHTML="";const n=e.filter(e=>e.name.toLowerCase().includes(t)||e.model.toLowerCase().includes(t)||e.ownerName.toLowerCase().includes(t));if(0===n.length)return m.devicesEmptyState.style.display="table-row",void m.devicesTableBody.appendChild(m.devicesEmptyState);m.devicesEmptyState.style.display="none",n.forEach(e=>{const t=document.createElement("tr");t.className="animate-fade-in";const{iconClass:n,colorClass:s,statusText:a}=function(e){const t={Phone:"bi-phone-fill",Tablet:"bi-tablet-landscape-fill",Laptop:"bi-laptop-fill",Watch:"bi-smartwatch"}[e.type]||"bi-question-circle-fill";let n="var(--color-success)",s="Online";switch(e.status){case"offline":n="var(--color-warning)",s="Offline";break;case"lost":n="var(--color-danger)",s="Lost Mode"}return{iconClass:t,colorClass:n,statusText:s}}(e),i=e.lastSeen?.toDate?e.lastSeen.toDate().toLocaleString():"Never";t.innerHTML=`\n            \x3c!-- Device Column --\x3e\n            <td>\n                <div class="flex items-center gap-3">\n                    <i class="bi ${n} text-2xl" style="color: ${s};"></i>\n                    <div class="flex-1 overflow-hidden">\n                        <div class="font-medium text-text-primary dark:text-dark-text-primary truncate">${e.name}</div>\n                        <div class="text-sm text-text-secondary dark:text-dark-text-secondary truncate">${e.model}</div>\n                    </div>\n                </div>\n            </td>\n            \x3c!-- Owner Column --\x3e\n            <td class="text-sm text-text-secondary dark:text-dark-text-secondary">\n                <div class="font-medium text-text-primary dark:text-dark-text-primary truncate">${e.ownerName}</div>\n                <div class="text-xs font-mono">${e.userId}</div>\n            </td>\n            \x3c!-- Status Column --\x3e\n            <td>\n                <span class="badge ${s.includes("danger")?"badge-danger":s.includes("warning")?"badge-warning":"badge-success"}">\n                    ${a}\n                </span>\n            </td>\n            \x3c!-- Last Seen Column --\x3e\n            <td class="text-sm text-text-secondary dark:text-dark-text-secondary">${i}</td>\n            \x3c!-- Actions Column --\x3e\n            <td>\n                <div class="flex gap-2">\n                    <button class="btn btn-secondary btn-sm btn-view-device" data-id="${e.id}" data-user="${e.userId}" title="View Details">\n                        <i class="bi bi-eye-fill"></i>\n                    </button>\n                    <button class="btn btn-secondary btn-sm btn-delete-device" data-id="${e.id}" data-user="${e.userId}" title="Delete Device">\n                        <i class="bi bi-trash-fill text-danger"></i>\n                    </button>\n                </div>\n            </td>\n        `,m.devicesTableBody.appendChild(t)})}function p(e){e?(m.devicesTableBody.innerHTML="",m.devicesLoadingState.style.display="table-row",m.devicesEmptyState.style.display="none"):m.devicesLoadingState.style.display="none"}!function(e){const t=()=>{window.currentUserIsAdmin?(console.log("Device Overview Logic: Auth is ready."),e(window.currentUserId)):(console.log("Device Overview logic waiting for admin authentication..."),requestAnimationFrame(t))};requestAnimationFrame(t)}(f=>{!function(){p(!0);const n=s(e,"devices"),f=a(n,i("lastSeen","desc"));u&&u();u=o(f,async t=>{if(p(!1),m.totalDeviceCount.textContent=t.size,t.empty)return m.devicesEmptyState.style.display="table-row",m.devicesTableBody.innerHTML="",void m.devicesTableBody.appendChild(m.devicesEmptyState);const n=new Set(t.docs.map(e=>e.ref.parent.parent.id)),s=[];n.forEach(t=>{l.has(t)||s.push(async function(t){if(l.has(t))return l.get(t);try{const n=d(e,"user_data",t,"profile","settings"),s=await r(n);if(s.exists()){const e=s.data();return l.set(t,e),e}{const e={fullName:"New User",email:"N/A"};return l.set(t,e),e}}catch(n){console.warn("Could not fetch profile for user:",t,n);const e={fullName:"Error Loading"};return l.set(t,e),e}}(t))}),await Promise.all(s),c=t.docs.map(e=>{const t=e.data(),n=e.ref.parent.parent.id,s=l.get(n)||{fullName:"Unknown User"};return{id:e.id,...t,userId:n,ownerName:s.fullName}}),v(c,m.searchInput.value.toLowerCase())},e=>{console.error("Error listening for all devices:",e),t("Error","Could not load device data.","error"),p(!1),m.devicesEmptyState.style.display="table-row"})}(),m.searchInput.addEventListener("input",e=>{v(c,e.target.value.toLowerCase())}),m.devicesTableBody.addEventListener("click",e=>{const s=e.target.closest("button");if(!s)return;const a=s.dataset.id,i=s.dataset.user;s.matches(".btn-delete-device")&&function(e,s){const a=c.find(t=>t.id===e),i=a?a.name:"this device";n(!0,"Delete Device?",`Are you sure you want to permanently delete <strong>${i}</strong>? This will remove it from the user's account. This action cannot be undone.`,"Delete Device","btn-danger",()=>{console.log(`Requesting deletion for device: ${e} from user ${s} (via Cloud Function)`),t("Deletion Requested",`A request to delete ${i} has been sent. This must be handled by a secure server function.`,"info")})}(a,i)})});
