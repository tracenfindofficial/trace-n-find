import{initializeApp as e}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import{getAuth as t,GoogleAuthProvider as n,onAuthStateChanged as r,browserLocalPersistence as s,browserSessionPersistence as a,setPersistence as o,signInWithEmailAndPassword as i,signInWithPopup as c,getAdditionalUserInfo as l,getMultiFactorResolver as d,PhoneMultiFactorGenerator as u,RecaptchaVerifier as m,PhoneAuthProvider as g,createUserWithEmailAndPassword as p,updateProfile as f,multiFactor as h,sendPasswordResetEmail as w}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import{getFirestore as y,doc as b,setDoc as E,serverTimestamp as v}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";const I=e({apiKey:"AIzaSyAokTU8XIKQcaFv9RBVWMs_8iGEcni6sY4",authDomain:"trace-n--find.firebaseapp.com",projectId:"trace-n--find",storageBucket:"trace-n--find.firebasestorage.app",messagingSenderId:"1000921948484",appId:"1:1000921948484:web:92d821bd2cf4f2e5a67711",measurementId:"G-6BFEZXMG57"}),B=t(I),S=y(I,"tracenfind"),L=new n,k={isSubmitting:!1,theme:"light",passwordVisible:!1,currentStep:1,registrationData:{username:"",email:"",password:"",phone:""}},x=document.getElementById("toastContainer"),T=document.getElementById("theme-toggle");let A={modal:null,close:null,cancel:null,verify:null,input:null};document.addEventListener("DOMContentLoaded",()=>{T&&T.addEventListener("click",V),$(),A.modal=document.getElementById("otpModal"),A.close=document.getElementById("otpModalClose"),A.cancel=document.getElementById("otpModalCancel"),A.verify=document.getElementById("otpModalVerify"),A.input=document.getElementById("otpInput"),A.close&&A.close.addEventListener("click",C),A.cancel&&A.cancel.addEventListener("click",C),document.getElementById("loginForm")?function(){const e={loginForm:document.getElementById("loginForm"),emailInput:document.getElementById("email"),passwordInput:document.getElementById("password"),passwordToggle:document.getElementById("passwordToggle"),rememberMe:document.getElementById("rememberMe"),loginButton:document.getElementById("loginButton"),googleBtn:document.getElementById("googleBtn")};if(!e.loginForm)return;async function t(t){if(t.preventDefault(),k.isSubmitting)return;k.isSubmitting=!0;const r=e.emailInput.value,l=e.passwordInput.value;if(!n()||!c())return O("Error","Please fix the errors in the form.","error"),void(k.isSubmitting=!1);j(!0,e.loginButton);try{await M("LOGIN");const t=e.rememberMe.checked?s:a;await o(B,t);const n=await i(B,r,l);e.rememberMe.checked?localStorage.setItem("rememberedEmail",r):localStorage.removeItem("rememberedEmail"),P(n.user)}catch(d){"auth/multi-factor-auth-required"===d.code?F(d):(N(d,"login"),j(!1,e.loginButton),k.isSubmitting=!1)}}function n(t=!1){const n=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return e.emailInput.value?n.test(e.emailInput.value)?!t||U(e.emailInput,"email-error"):H(e.emailInput,"email-error","Please enter a valid email address."):H(e.emailInput,"email-error","Email is required.")}function c(t=!1){return e.passwordInput.value?e.passwordInput.value.length<6?H(e.passwordInput,"password-error","Password must be at least 6 characters."):!t||U(e.passwordInput,"password-error"):H(e.passwordInput,"password-error","Password is required.")}e.loginForm.addEventListener("submit",t),e.passwordToggle.addEventListener("click",()=>R(e.passwordInput,e.passwordToggle)),e.googleBtn.addEventListener("click",()=>D()),e.emailInput.addEventListener("input",z(()=>n(!0),300)),e.passwordInput.addEventListener("input",z(()=>c(!0),300)),r(B,t=>{if(t&&!k.isSubmitting)localStorage.setItem("authToken",t.accessToken),window.location.replace("/app/dashboard.html");else if(t&&k.isSubmitting)console.log("Auth state changed, but login is in progress. Waiting for success handler.");else{const t=localStorage.getItem("rememberedEmail");t&&(e.emailInput.value=t,e.rememberMe.checked=!0)}})}():document.getElementById("registerFormStep1")?function(){const e={progressBar1:document.getElementById("progress-bar-1"),progressBar2:document.getElementById("progress-bar-2"),stepDots:{1:document.getElementById("step-dot-1"),2:document.getElementById("step-dot-2"),3:document.getElementById("step-dot-3")},step1:document.getElementById("step1"),username:document.getElementById("username"),email:document.getElementById("email"),password:document.getElementById("password"),togglePassword:document.getElementById("passwordToggle"),passwordStrengthBar:document.getElementById("passwordStrengthBar"),passwordStrengthText:document.getElementById("passwordStrengthText"),req:{length:document.getElementById("lengthReq"),uppercase:document.getElementById("uppercaseReq"),lowercase:document.getElementById("lowercaseReq"),number:document.getElementById("numberReq")},termsCheckbox:document.getElementById("termsCheckbox"),nextToStep2:document.getElementById("nextToStep2"),googleBtn:document.getElementById("googleBtn"),step2:document.getElementById("step2"),phone:document.getElementById("phone"),backToStep1:document.getElementById("backToStep1"),createAccountBtn:document.getElementById("createAccountBtn"),skipMfaBtn:document.getElementById("skipMfaBtn"),step3:document.getElementById("step3"),welcomeUsername:document.getElementById("welcome-username")};if(!e.step1)return;function t(t){k.currentStep=t;const n=[e.step1,e.step2,e.step3],r=[e.stepDots[1],e.stepDots[2],e.stepDots[3]];n.forEach((e,s)=>{const a=n[s];if(!a)return;const o=r[s];s+1===t?(a.classList.contains("active")||(a.classList.remove("exiting"),a.classList.add("active")),o.classList.add("bg-primary-600","text-white"),o.classList.remove("bg-slate-200","dark:bg-slate-700","text-slate-500","dark:text-slate-400","bg-success-500"),o.innerHTML=s+1===3?'<i class="bi bi-check"></i>':`${t}`):(a.classList.contains("active")&&(a.classList.add("exiting"),setTimeout(()=>a.classList.remove("active","exiting"),400)),s+1<t?(o.classList.add("bg-success-500","text-white"),o.classList.remove("bg-primary-600","bg-slate-200","dark:bg-slate-700"),o.innerHTML='<i class="bi bi-check"></i>'):(o.classList.remove("bg-success-500","bg-primary-600","text-white"),o.classList.add("bg-slate-200","dark:bg-slate-700","text-slate-500","dark:text-slate-400"),o.innerHTML=s+1===3?'<i class="bi bi-check"></i>':`${s+1}`))});[e.progressBar1,e.progressBar2].forEach((e,n)=>{n+1<t?(e.classList.add("border-primary-600"),e.classList.remove("border-slate-300","dark:border-slate-600")):(e.classList.remove("border-primary-600"),e.classList.add("border-slate-300","dark:border-slate-600"))})}function n(){a()?(k.registrationData.username=e.username.value,k.registrationData.email=e.email.value,k.registrationData.password=e.password.value,t(2)):O("Error","Please fix the errors in the form.","error")}async function r(n){if(n.preventDefault(),!k.isSubmitting){k.isSubmitting=!0,k.registrationData.phone=e.phone.value,j(!0,e.createAccountBtn),j(!0,e.skipMfaBtn);try{await M("REGISTER");const i=(await p(B,k.registrationData.email,k.registrationData.password)).user;if(await f(i,{displayName:k.registrationData.username,photoURL:`https://ui-avatars.com/api/?name=${encodeURIComponent(k.registrationData.username)}&background=4361ee&color=fff&size=128`}),await q(i,k.registrationData.username,k.registrationData.phone),k.registrationData.phone&&"skipMfaBtn"!==n.target.id)try{if(window.recaptchaVerifier){try{window.recaptchaVerifier.clear()}catch(r){}window.recaptchaVerifier=null}window.recaptchaVerifier=new m(B,"recaptcha-container",{size:"invisible"});const e=await new g(B).verifyPhoneNumber({phoneNumber:k.registrationData.phone,session:null},window.recaptchaVerifier),t=prompt(`MFA Setup: Enter the SMS code sent to ${k.registrationData.phone}`);if(t){const n=g.credential(e,t),r=u.assertion(n);await h(i).enroll(r,"My Phone Number"),O("Success","MFA Enabled Successfully!","success")}else O("Info","MFA setup skipped (no code entered).","warning")}catch(a){console.error("MFA Enrollment Error:",a),O("Warning","Account created, but MFA setup failed: "+a.message,"warning")}await o(B,s),e.welcomeUsername.textContent=k.registrationData.username,t(3),setTimeout(()=>window.location.replace("/app/dashboard.html"),2e3)}catch(i){N(i,"register"),j(!1,e.createAccountBtn),j(!1,e.skipMfaBtn),k.isSubmitting=!1,"auth/email-already-in-use"!==i.code&&"auth/weak-password"!==i.code||t(1)}}}function a(){const t=i(e.username,"username-error",c,!1),n=i(e.email,"email-error",l,!1),r=i(e.password,"password-error",d,!1),s=e.termsCheckbox.checked;return e.nextToStep2.disabled=!(t&&n&&r&&s),!1===e.nextToStep2.disabled}function i(e,t,n,r=!0){return n(e,t,r)}function c(e,t,n=!0){const r=e.value;return r.length<3?H(e,t,"Username must be at least 3 characters."):/^[a-zA-Z0-9_]+$/.test(r)?!n||U(e,t):H(e,t,"Only letters, numbers, and underscores allowed.")}function l(e,t,n=!0){const r=e.value;return r?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(r)?!n||U(e,t):H(e,t,"Please enter a valid email address."):H(e,t,"Email is required.")}function d(e,t,n=!0){const r=w(e.value);return Object.values(r).every(Boolean)?!n||U(e,t):H(e,t,"Password does not meet all requirements.")}function w(e){return{length:e.length>=8,uppercase:/[A-Z]/.test(e),lowercase:/[a-z]/.test(e),number:/[0-9]/.test(e)}}function y(e,t){const n=w(e),r=Object.values(n).filter(Boolean).length;let s="",a="";e.length>0&&(r<=2?(s="w-1/3 bg-danger-500",a="Weak"):3===r?(s="w-2/3 bg-warning-500",a="Medium"):(s="w-full bg-success-500",a="Strong")),t.passwordStrengthBar.className=`h-full transition-all duration-300 ${s}`,t.passwordStrengthText.textContent=a,t.passwordStrengthText.className="text-xs text-right mt-1 font-medium "+(r<=2?"text-danger-500":3===r?"text-warning-500":"text-success-500")}function b(e,t){const n=w(e);for(const r in n){const e=t.req[r];if(!e)continue;const s=e.querySelector("i");n[r]?(e.classList.add("text-success-500"),e.classList.remove("text-slate-500","invalid"),s.className="bi bi-check-circle-fill mr-1.5"):(e.classList.add("text-slate-500","invalid"),e.classList.remove("text-success-500"),s.className="bi bi-x-circle mr-1.5")}}e.password.addEventListener("input",()=>{const t=e.password.value;y(t,e),b(t,e),a()}),e.togglePassword.addEventListener("click",()=>R(e.password,e.togglePassword)),e.username.addEventListener("input",z(()=>{i(e.username,"username-error",c),a()},300)),e.email.addEventListener("input",z(()=>{i(e.email,"email-error",l),a()},300)),e.termsCheckbox.addEventListener("change",a),e.nextToStep2.addEventListener("click",n),e.backToStep1.addEventListener("click",()=>t(1)),e.createAccountBtn.addEventListener("click",r),e.skipMfaBtn.addEventListener("click",r),e.googleBtn.addEventListener("click",()=>D())}():document.getElementById("recoveryForm")&&function(){const e={stepEmail:document.getElementById("stepEmail"),recoveryForm:document.getElementById("recoveryForm"),emailInput:document.getElementById("email"),recoveryButton:document.getElementById("recoveryButton"),stepSuccess:document.getElementById("stepSuccess"),sentEmail:document.getElementById("sentEmail")};let t=1;if(!e.recoveryForm)return;function n(n){const r=1===t?e.stepEmail:e.stepSuccess,s=e.stepSuccess;r&&(r.classList.add("exiting"),setTimeout(()=>r.classList.remove("active","exiting"),400)),s&&setTimeout(()=>s.classList.add("active"),100),t=2}async function r(t){if(t.preventDefault(),k.isSubmitting)return;k.isSubmitting=!0;const r=e.emailInput.value;if(!s())return O("Error","Please enter a valid email address.","error"),void(k.isSubmitting=!1);j(!0,e.recoveryButton);try{await M("RECOVERY"),await w(B,r),e.sentEmail.textContent=r,n("success")}catch(a){"auth/user-not-found"===a.code?(e.sentEmail.textContent=r,n()):N(a,"recovery")}finally{j(!1,e.recoveryButton),k.isSubmitting=!1}}function s(t=!1){const n=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return e.emailInput.value?n.test(e.emailInput.value)?!t||U(e.emailInput,"email-error"):H(e.emailInput,"email-error","Please enter a valid email address."):H(e.emailInput,"email-error","Email is required.")}e.recoveryForm.addEventListener("submit",r),e.emailInput.addEventListener("input",z(()=>s(!0),300))}()});const M=e=>new Promise(t=>{if("undefined"==typeof grecaptcha||void 0===grecaptcha.enterprise)return console.warn("reCAPTCHA Enterprise not loaded. Skipping bot check."),void t(null);grecaptcha.enterprise.ready(async()=>{try{const n=await grecaptcha.enterprise.execute("6LdnxQcsAAAAAOQl5jTa-VhC4aek_xTzDqSTp6zI",{action:e});console.log(`reCAPTCHA (Bot Protection) Token for ${e}:`,n),t(n)}catch(n){console.warn("reCAPTCHA execution failed:",n),t(null)}})});function C(){A.modal&&A.modal.classList.remove("active"),A.verify&&(A.verify.onclick=null),k.isSubmitting=!1;const e=document.getElementById("loginButton"),t=document.getElementById("googleBtn");e&&j(!1,e),t&&j(!1,t)}async function D(e){if(k.isSubmitting)return;k.isSubmitting=!0,j(!0,document.getElementById("googleBtn"));const t=L;try{await M("SOCIAL_LOGIN"),await o(B,s);const e=await c(B,t),n=e.user,r=l(e);r?.isNewUser&&await q(n,n.displayName,n.phoneNumber),P(n)}catch(n){"auth/multi-factor-auth-required"===n.code?F(n):(N(n,"social"),j(!1,document.getElementById("googleBtn")),k.isSubmitting=!1)}}async function F(e){try{const n=d(B,e),r=n.hints.find(e=>e.factorId===u.FACTOR_ID);if(r){if(O("MFA Required","Sending verification code...","info"),window.recaptchaVerifier){try{window.recaptchaVerifier.clear()}catch(t){}window.recaptchaVerifier=null}window.recaptchaVerifier=new m(B,"recaptcha-container",{size:"invisible"});const e={multiFactorHint:r,session:n.session},s=new g(B),a=await s.verifyPhoneNumber(e,window.recaptchaVerifier);!function(e){if(!A.modal)return;A.input.value="",A.modal.classList.add("active"),A.verify.onclick=()=>{const t=A.input.value.trim();t?e(t):O("Error","Please enter the code.","error")}}(async e=>{try{const t=g.credential(a,e),r=u.assertion(t),s=await n.resolveSignIn(r);C(),P(s.user)}catch(t){O("Error","Verification failed: "+t.message,"error")}})}else O("Error","No supported MFA method found.","error"),k.isSubmitting=!1}catch(n){console.error("MFA Error:",n),O("Error","Authentication failed: "+n.message,"error"),k.isSubmitting=!1,j(!1,document.getElementById("loginButton")),j(!1,document.getElementById("googleBtn"))}}async function q(e,t,n=""){if(!e)return;const r=b(S,"user_data",e.uid,"profile","settings");try{await E(r,{userId:e.uid,fullName:t||"New User",email:e.email,phone:n||"",createdAt:v(),theme:"dark",role:"user"})}catch(s){console.error("Profile creation error",s)}}function P(e){O("Login Successful!",`Welcome, ${e.displayName||e.email}.`,"success"),localStorage.setItem("authToken",e.accessToken),setTimeout(()=>window.location.replace("/app/dashboard.html"),1e3)}function N(e,t){console.error(`Firebase Auth Error (${t}):`,e.code,e.message);let n="An error occurred.";"auth/wrong-password"===e.code||"auth/user-not-found"===e.code?n="Invalid email or password.":"auth/popup-closed-by-user"===e.code&&(n="Sign-in cancelled."),O("Error",n,"error")}function V(){const e=document.documentElement.classList.toggle("dark");k.theme=e?"dark":"light",document.documentElement.setAttribute("data-theme",k.theme),localStorage.setItem("theme",k.theme),$()}function $(){const e=document.documentElement.classList.contains("dark");document.querySelectorAll("#theme-toggle").forEach(t=>{const n=t?t.querySelector(".bi-moon-fill"):null,r=t?t.querySelector(".bi-sun-fill"):null;n&&(n.style.display=e?"block":"none"),r&&(r.style.display=e?"none":"block")})}function R(e,t){e.type="password"===e.type?"text":"password",t.querySelector("i").className="password"===e.type?"bi bi-eye-fill":"bi bi-eye-slash-fill"}function j(e,t){if(!t)return;const n=t.querySelector(".button-text"),r=t.querySelector(".button-spinner");t.disabled=e,n&&n.classList.toggle("hidden",e),r&&r.classList.toggle("hidden",!e)}function O(e,t,n="info"){if(!x)return;const r=document.createElement("div");r.className=`toast toast-${n} show`,r.innerHTML=`<div><b>${e}</b><br>${t}</div>`,x.appendChild(r),setTimeout(()=>r.remove(),3e3)}function z(e,t){let n;return function(...r){clearTimeout(n),n=setTimeout(()=>e.apply(this,r),t)}}function H(e,t,n){const r=document.getElementById(t);return!!e&&(e.classList.add("border-red-500","focus:ring-red-500"),e.classList.remove("border-green-500","focus:ring-green-500"),r&&(r.textContent=n,r.classList.remove("hidden")),!1)}function U(e,t){const n=document.getElementById(t);return!e||(e.classList.remove("border-red-500","focus:ring-red-500"),e.classList.add("border-green-500","focus:ring-green-500"),n&&(n.textContent="",n.classList.add("hidden")),!0)}
