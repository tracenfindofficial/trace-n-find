import"./modulepreload-polyfill-YP0FEG5d.js";import"./app-shell-CtSII-jN.js";import{getAuth as e,onAuthStateChanged as t,multiFactor as a,updateProfile as n,sendEmailVerification as i,signOut as r,RecaptchaVerifier as o,PhoneAuthProvider as l,PhoneMultiFactorGenerator as s}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import{getFirestore as d,doc as c,getDoc as p,setDoc as m,serverTimestamp as u}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import{getStorage as f,ref as g,uploadBytes as h,getDownloadURL as y}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";import{initializeApp as b}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"./shared-utils-DEXrBstL.js";const w=b({apiKey:"AIzaSyAokTU8XIKQcaFv9RBVWMs_8iGEcni6sY4",authDomain:"trace-n--find.firebaseapp.com",projectId:"trace-n--find",storageBucket:"trace-n--find.firebasestorage.app",messagingSenderId:"1000921948484",appId:"1:1000921948484:web:92d821bd2cf4f2e5a67711",measurementId:"G-6BFEZXMG57"}),v=e(w),I=d(w,"tracenfind"),E=f(w),B=async e=>{if("undefined"==typeof grecaptcha||void 0===grecaptcha.enterprise)return console.warn("reCAPTCHA Enterprise not loaded. Skipping bot check."),null;try{return await grecaptcha.enterprise.execute("6LdnxQcsAAAAAOQl5jTa-VhC4aek_xTzDqSTp6zI",{action:e})}catch(t){return console.warn("reCAPTCHA execution failed (Action: "+e+"):",t),null}};let M={},L=null;const A=()=>{M={profileForm:document.getElementById("profile-form"),displayNameInput:document.getElementById("profile-name"),emailInput:document.getElementById("profile-email"),phoneInput:document.getElementById("profile-phone"),bioInput:document.getElementById("profile-bio"),profileImage:document.getElementById("profile-avatar-img"),profileUpload:document.getElementById("profileUpload"),saveBtn:document.getElementById("save-profile-btn"),verifyEmailBtn:document.getElementById("verify-email-btn"),emailVerifiedBadge:document.getElementById("email-verified-badge"),emailUnverifiedBadge:document.getElementById("email-unverified-badge"),enableMfaBtn:document.getElementById("enable-mfa-btn"),disableMfaBtn:document.getElementById("disable-mfa-btn"),otpModal:document.getElementById("otpModal"),otpModalClose:document.getElementById("otpModalClose"),otpModalCancel:document.getElementById("otpModalCancel"),otpModalVerify:document.getElementById("otpModalVerify"),otpInput:document.getElementById("otpInput"),recaptchaContainer:document.getElementById("recaptcha-container-profile")},t(v,async e=>{e?(L=e,await async function(e){try{M.displayNameInput&&(M.displayNameInput.value=e.displayName||""),M.emailInput&&(M.emailInput.value=e.email||""),e.photoURL&&M.profileImage&&(M.profileImage.src=e.photoURL),t=e.emailVerified,M.emailVerifiedBadge&&(t?(M.emailVerifiedBadge.classList.remove("hidden"),M.emailUnverifiedBadge&&M.emailUnverifiedBadge.classList.add("hidden"),M.verifyEmailBtn&&M.verifyEmailBtn.classList.add("hidden")):(M.emailVerifiedBadge.classList.add("hidden"),M.emailUnverifiedBadge&&M.emailUnverifiedBadge.classList.remove("hidden"),M.verifyEmailBtn&&M.verifyEmailBtn.classList.remove("hidden")));const n=a(e).enrolledFactors.length>0;n?(M.enableMfaBtn&&(M.enableMfaBtn.innerHTML='<i class="bi bi-shield-check text-lg"></i> <span>Two-Factor Authentication is Active</span>',M.enableMfaBtn.className="w-full bg-emerald-500/10 text-emerald-500 border border-emerald-500/20 cursor-default font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-2",M.enableMfaBtn.disabled=!0),M.disableMfaBtn&&M.disableMfaBtn.classList.remove("hidden")):(M.enableMfaBtn&&(M.enableMfaBtn.innerHTML='<i class="bi bi-shield-lock-fill"></i> <span>Enable 2FA</span>',M.enableMfaBtn.className="w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-3 px-4 rounded-xl transition-all duration-300 flex items-center justify-center gap-2 shadow-lg shadow-primary-600/20",M.enableMfaBtn.disabled=!1),M.disableMfaBtn&&M.disableMfaBtn.classList.add("hidden"));const i=c(I,"user_data",e.uid,"profile","settings"),r=await p(i);if(r.exists()){const e=r.data();M.phoneInput&&(M.phoneInput.value=e.phone||""),M.bioInput&&(M.bioInput.value=e.bio||""),e.mfa_enabled&&!n&&await m(i,{mfa_enabled:!1},{merge:!0})}}catch(n){console.error("Error loading profile:",n)}var t}(e),M.profileForm&&M.profileForm.addEventListener("submit",x),M.profileUpload&&M.profileUpload.addEventListener("change",S),M.verifyEmailBtn&&M.verifyEmailBtn.addEventListener("click",T),M.enableMfaBtn&&M.enableMfaBtn.addEventListener("click",V),M.disableMfaBtn&&M.disableMfaBtn.addEventListener("click",handleDisableMFA),M.otpModalClose&&M.otpModalClose.addEventListener("click",C),M.otpModalCancel&&M.otpModalCancel.addEventListener("click",C)):window.location.replace("/public/auth/login.html")})};function C(){M.otpModal.classList.remove("active"),M.otpModalVerify.onclick=null}async function T(e){if(e.preventDefault(),!L)return;const t=M.verifyEmailBtn,a=t.textContent;t.disabled=!0,t.textContent="Sending...";try{await B("VERIFY_EMAIL"),await i(L),k("Success","Verification email sent!","success"),t.textContent="Sent!"}catch(n){console.error("Verification Email Error:",n),"auth/too-many-requests"===n.code?k("Warning","Too many requests. Try again later.","warning"):k("Error","Failed to send email.","error"),t.textContent=a,t.disabled=!1}}async function S(e){const t=e.target.files[0];if(!t)return;if(!t.type.startsWith("image/"))return void k("Error","Please select an image.","error");const a=new FileReader;a.onload=e=>{M.profileImage&&(M.profileImage.src=e.target.result)},a.readAsDataURL(t);try{k("Info","Uploading...","info");const e=g(E,`users/${L.uid}/profile_${Date.now()}.jpg`),a=await h(e,t),i=await y(a.ref);await n(L,{photoURL:i});const r=c(I,"user_data",L.uid,"profile","settings");await m(r,{photoURL:i,updatedAt:u()},{merge:!0}),k("Success","Profile picture updated!","success")}catch(i){console.error("Image Upload Error:",i),k("Error","Failed to upload.","error")}}async function x(e){if(e.preventDefault(),!L)return;F(!0);const t=M.displayNameInput?M.displayNameInput.value.trim():"",a=M.phoneInput?M.phoneInput.value.trim():"",i=M.bioInput?M.bioInput.value.trim():"";try{await B("UPDATE_PROFILE");const e=[];t&&t!==L.displayName&&e.push(n(L,{displayName:t}));const r=c(I,"user_data",L.uid,"profile","settings");e.push(m(r,{fullName:t,phone:a,bio:i,updatedAt:u()},{merge:!0})),await Promise.all(e),k("Success","Profile updated!","success")}catch(r){console.error("Save Profile Error:",r),k("Error","Failed to save: "+r.message,"error")}finally{F(!1)}}async function V(){if(!L)return;const e=new Date(L.metadata.lastSignInTime).getTime();if(Date.now()-e>3e5)return k("Security Update","Please log in again to enable 2FA.","warning"),void setTimeout(async()=>{await r(v),window.location.replace("/public/auth/login.html")},2e3);const t=M.phoneInput?M.phoneInput.value.trim():"";if(!t)return k("Error","Please enter your phone number first.","error"),void(M.phoneInput&&M.phoneInput.focus());try{if(window.recaptchaVerifier){try{window.recaptchaVerifier.clear()}catch(i){console.log("Verifier clear warning",i)}window.recaptchaVerifier=null}if(!document.getElementById("recaptcha-container-profile"))return console.error("CRITICAL: #recaptcha-container-profile missing in HTML."),void k("System Error","MFA setup container missing. Refresh page.","error");window.recaptchaVerifier=new o(v,"recaptcha-container-profile",{size:"invisible",callback:e=>{console.log("MFA reCAPTCHA Solved")},"expired-callback":()=>{k("Warning","Security check expired. Try again.","warning")}}),k("Info","Sending verification code...","info");const e={phoneNumber:t,session:await a(L).getSession()},r=await new l(v).verifyPhoneNumber(e,window.recaptchaVerifier);n=async e=>{try{const t=l.credential(r,e),n=s.assertion(t);await a(L).enroll(n,"My Phone Number");try{const e=c(I,"user_data",L.uid,"profile","settings");await m(e,{mfa_enabled:!0},{merge:!0})}catch(i){}k("Success","MFA Enabled Successfully!","success"),C(),await L.reload(),window.location.reload()}catch(t){k("Error","Invalid code: "+t.message,"error")}},M.otpInput.value="",M.otpModal.classList.add("active"),setTimeout(()=>M.otpInput.focus(),100),M.otpModalVerify.onclick=()=>{const e=M.otpInput.value.trim();e?n(e):k("Error","Please enter the code.","error")}}catch(d){if(console.error("MFA Enrollment Error:",d),window.recaptchaVerifier){try{window.recaptchaVerifier.clear()}catch(i){}window.recaptchaVerifier=null}let e=d.message;"auth/requires-recent-login"===d.code?(e="You must log in again to enable 2FA. Redirecting...",setTimeout(async()=>{await r(v),window.location.replace("/public/auth/login.html")},2e3)):"auth/captcha-check-failed"===d.code&&(e="Browser blocked the security check. Please try a different browser or disable ad-blockers."),k("Error",e,"error")}var n}function F(e){const t=M.saveBtn;if(!t)return;const a=t.querySelector(".button-spinner"),n=t.querySelector(".button-text");e?(t.disabled=!0,a&&a.classList.remove("hidden"),n&&(n.textContent="Saving...")):(t.disabled=!1,a&&a.classList.add("hidden"),n&&(n.textContent="Save Changes"))}function k(e,t,a="info"){if("function"==typeof window.showToast)window.showToast(e,t,a);else{const n=document.getElementById("toastContainer");if(n){const i=document.createElement("div");i.className=`toast toast-${a} show`,i.innerHTML=`<div><b>${e}</b><br>${t}</div>`,n.appendChild(i),setTimeout(()=>i.remove(),3e3)}else alert(`${e}: ${t}`)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",A):A();
