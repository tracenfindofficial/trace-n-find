import"./modulepreload-polyfill-YP0FEG5d.js";import{f as e}from"./app-shell-CtSII-jN.js";import{a as t,j as s,g as i,e as a,h as n,d,c as r}from"./shared-utils-DEXrBstL.js";import{collection as l,query as o,orderBy as c,onSnapshot as m,doc as h,deleteDoc as p}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";!function(e){const t=()=>{window.currentUserId?(console.log("Devices logic: Auth is ready."),e()):(console.log("Devices logic waiting for authentication..."),requestAnimationFrame(t))};window.currentUserId?e():requestAnimationFrame(t)}(()=>{console.log(`Device logic initializating for user: ${window.currentUserId}`);new b(window.currentUserId).init()});class b{constructor(e){this.userId=e,this.elements={loadingSkeleton:document.getElementById("loadingSkeleton"),devicesContainer:document.getElementById("devicesContainer"),gridView:document.getElementById("gridView"),tableView:document.getElementById("tableView"),emptyState:document.getElementById("emptyState"),searchInput:document.getElementById("searchInput"),statusFilter:document.getElementById("statusFilter"),typeFilter:document.getElementById("typeFilter"),gridViewBtn:document.getElementById("gridViewBtn"),tableViewBtn:document.getElementById("tableViewBtn")},this.state={viewMode:"grid",allDevices:[],filteredDevices:[],filter:{search:"",status:"all",type:"all"}},this.deviceListener=null}init(){this.setupEventListeners(),this.setLoading(!0),this.listenForDevices(),this.setViewMode(localStorage.getItem("deviceViewMode")||"grid")}listenForDevices(){const s=l(e,"user_data",this.userId,"devices"),i=o(s,c("name","asc"));this.deviceListener=m(i,e=>{const t=e.docs.map(e=>({id:e.id,...e.data()}));this.handleDevicesLoaded(t)},e=>{console.error("Error listening for devices:",e),t("Error","Could not load devices.","error"),this.setLoading(!1),this.handleDevicesLoaded([])})}setupEventListeners(){this.elements.gridViewBtn.addEventListener("click",()=>this.setViewMode("grid")),this.elements.tableViewBtn.addEventListener("click",()=>this.setViewMode("table")),this.elements.searchInput.addEventListener("input",s(()=>{this.state.filter.search=this.elements.searchInput.value.toLowerCase(),this.applyFilters()},300)),this.elements.statusFilter.addEventListener("change",e=>{this.state.filter.status=e.target.value,this.applyFilters()}),this.elements.typeFilter.addEventListener("change",e=>{this.state.filter.type=e.target.value,this.applyFilters()}),this.elements.devicesContainer.addEventListener("click",e=>{const t=e.target.closest(".action-btn");if(!t)return;const s=t.dataset.id,i=t.dataset.action;"edit"===i?this.handleEdit(s):"delete"===i&&this.handleDelete(s)})}handleDevicesLoaded(e){this.state.allDevices=e,this.applyFilters(),this.setLoading(!1)}setViewMode(e){this.state.viewMode=e,localStorage.setItem("deviceViewMode",e);const t=this.elements.gridViewBtn,s=this.elements.tableViewBtn,i=this.elements.gridView,a=this.elements.tableView,n=["active","bg-bg-card","dark:bg-dark-bg-card","shadow","text-primary-600","dark:text-primary-400"],d=["text-text-secondary","dark:text-dark-text-secondary"];"grid"===e?(i.classList.remove("hidden"),a.classList.add("hidden"),t.classList.add(...n),t.classList.remove(...d),s.classList.add(...d),s.classList.remove(...n)):(i.classList.add("hidden"),a.classList.remove("hidden"),t.classList.add(...d),t.classList.remove(...n),s.classList.add(...n),s.classList.remove(...d))}applyFilters(){const{search:e,status:t,type:s}=this.state.filter;this.state.filteredDevices=this.state.allDevices.filter(i=>{const a=i.name||"",n=i.model||"",d=i.status||"",r=i.type||"",l="all"===t||d===t,o="all"===s||r.toLowerCase()===s.toLowerCase(),c=!e||a.toLowerCase().includes(e)||n.toLowerCase().includes(e);return l&&o&&c}),this.renderDeviceViews()}setLoading(e){e?(this.elements.loadingSkeleton.classList.remove("hidden"),this.elements.gridView.classList.add("hidden"),this.elements.tableView.classList.add("hidden"),this.elements.emptyState.classList.add("hidden")):this.elements.loadingSkeleton.classList.add("hidden")}renderDeviceViews(){this.elements.gridView.innerHTML="";const e=this.elements.tableView.querySelector("tbody");e&&(e.innerHTML=""),0===this.state.filteredDevices.length?(this.elements.emptyState.classList.remove("hidden"),this.elements.gridView.classList.add("hidden"),this.elements.tableView.classList.add("hidden")):(this.elements.emptyState.classList.add("hidden"),"grid"===this.state.viewMode?(this.elements.gridView.classList.remove("hidden"),this.elements.tableView.classList.add("hidden")):(this.elements.gridView.classList.add("hidden"),this.elements.tableView.classList.remove("hidden")),this.state.filteredDevices.forEach((t,s)=>{this.elements.gridView.appendChild(this.createGridCard(t,s)),e&&e.appendChild(this.createTableRow(t,s))}))}createGridCard(e,t){const s=document.createElement("div");s.className="bg-bg-card dark:bg-dark-bg-card rounded-xl shadow-soft p-6 border border-border-color dark:border-dark-border-color transition-all duration-300 hover:-translate-y-1 hover:shadow-lg animation-fade-in",s.style.animationDelay=50*t+"ms";const r=i(e.status),l=e.status?e.status.charAt(0).toUpperCase()+e.status.slice(1):"Unknown",o=e.lastSeen&&"function"==typeof e.lastSeen.toDate?a(e.lastSeen.toDate()):"Never",c=n(e.battery);return s.innerHTML=`\n            <div class="flex justify-between items-start mb-4">\n                <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background-color: ${r}20;">\n                    <i class="bi ${d(e.type)} text-2xl" style="color: ${r};"></i>\n                </div>\n                <span class="text-xs font-semibold uppercase px-3 py-1 rounded-full" style="background-color: ${r}20; color: ${r};">\n                    ${l}\n                </span>\n            </div>\n            <h3 class="font-heading font-semibold text-xl text-text-primary dark:text-dark-text-primary truncate mb-1">${e.name||"Unnamed Device"}</h3>\n            <p class="text-sm text-text-secondary dark:text-dark-text-secondary mb-4 truncate">${e.model||"No model info"}></p>\n            \n            <div class="space-y-3 text-sm">\n                <div class="flex justify-between">\n                    <span class="text-text-secondary dark:text-dark-text-secondary font-medium">Battery</span>\n                    <span class="font-semibold text-text-primary dark:text-dark-text-primary flex items-center gap-1.5">\n                        <i class="bi ${c}" style="color: ${i(e.battery>20?"online":"danger")};"></i>\n                        ${null!==e.battery&&void 0!==e.battery?e.battery+"%":"N/A"}\n                    </span>\n                </div>\n                <div class="flex justify-between">\n                    <span class="text-text-secondary dark:text-dark-text-secondary font-medium">Last Seen</span>\n                    <span class="font-semibold text-text-primary dark:text-dark-text-primary">${o}</span>\n                </div>\n            </div>\n\n            <div class="border-t border-border-color dark:border-dark-border-color mt-5 pt-5 flex gap-2">\n                <a href="/app/device-details.html?id=${e.id}" class="btn flex-1 bg-primary-600 text-white hover:bg-primary-700 text-sm py-2 px-3">\n                    <i class="bi bi-eye mr-1.5"></i> Details\n                </a>\n                <button data-action="delete" data-id="${e.id}" class="action-btn btn bg-red-100 dark:bg-red-900/30 text-danger hover:bg-red-200 dark:hover:bg-red-900/50 text-sm py-2 px-3">\n                    <i class="bi bi-trash"></i>\n                </button>\n            </div>\n        `,s}createTableRow(e,t){const s=document.createElement("tr");s.className="animation-fade-in",s.style.animationDelay=50*t+"ms";const r=i(e.status),l=e.status?e.status.charAt(0).toUpperCase()+e.status.slice(1):"Unknown",o=e.lastSeen&&"function"==typeof e.lastSeen.toDate?a(e.lastSeen.toDate()):"Never",c=n(e.battery);return s.innerHTML=`\n            <td class="w-1/3">\n                <div class="flex items-center gap-3">\n                    <div class="w-10 h-10 rounded-lg flex-shrink-0 flex items-center justify-center" style="background-color: ${r}20;">\n                        <i class="bi ${d(e.type)} text-xl" style="color: ${r};"></i>\n                    </div>\n                    <div>\n                        <a href="/app/device-details.html?id=${e.id}" class="font-semibold text-text-primary dark:text-dark-text-primary hover:text-primary-600 dark:hover:text-primary-400 no-underline">${e.name||"Unnamed Device"}</a>\n                        <div class="text-sm text-text-secondary dark:text-dark-text-secondary">${e.model||"No model info"}</div>\n                    </div>\n                </div>\n            </td>\n            <td>\n                <span class="text-xs font-semibold uppercase px-3 py-1 rounded-full" style="background-color: ${r}20; color: ${r};">\n                    ${l}\n                </span>\n            </td>\n            <td>\n                <span class="font-semibold text-text-primary dark:text-dark-text-primary flex items-center gap-1.5">\n                    <i class="bi ${c}" style="color: ${i(e.battery>20?"online":"danger")};"></i>\n                    ${null!==e.battery&&void 0!==e.battery?e.battery+"%":"N/A"}\n                </span>\n            </td>\n            <td>\n                <span class="text-text-secondary dark:text-dark-text-secondary">${o}</span>\n            </td>\n            <td class="text-right">\n                <a href="/app/device-details.html?id=${e.id}" class="btn bg-primary-600 text-white hover:bg-primary-700 text-xs py-1.5 px-3">\n                    <i class="bi bi-eye"></i>\n                </a>\n                <button data-action="edit" data-id="${e.id}" class="action-btn btn bg-slate-100 dark:bg-slate-700 text-text-primary dark:text-dark-text-primary hover:bg-slate-200 dark:hover:bg-slate-600 text-xs py-1.5 px-3">\n                    <i class="bi bi-pencil"></i>\n                </button>\n                <button data-action="delete" data-id="${e.id}" class="action-btn btn bg-red-100 dark:bg-red-900/30 text-danger hover:bg-red-200 dark:hover:bg-red-900/50 text-xs py-1.5 px-3">\n                    <i class="bi bi-trash"></i>\n                </button>\n            </td>\n        `,s}handleEdit(e){t("Edit Device","Redirecting to device editor...","info"),setTimeout(()=>{window.location.href=`/app/add-device.html?edit=true&id=${e}`},1e3)}handleDelete(s){const i=this.state.allDevices.find(e=>e.id===s);i&&r("Delete Device?",`Are you sure you want to delete <strong>${i.name}</strong>? This action cannot be undone.`,"danger",async()=>{try{const a=h(e,"user_data",this.userId,"devices",s);await p(a),t("Device Deleted",`${i.name} has been successfully deleted.`,"success")}catch(a){console.error("Error deleting device:",a),t("Error","Could not delete device. Please try again.","error")}},null,{isHTML:!0})}}
