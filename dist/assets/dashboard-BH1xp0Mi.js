import"./modulepreload-polyfill-YP0FEG5d.js";import{S as t,f as e}from"./app-shell-CtSII-jN.js";import{m as s}from"./map-tiles-D1fw3GxV.js";import{j as i,f as n,s as a,c as o,a as r,i as l,e as d,d as c,g as m}from"./shared-utils-DEXrBstL.js";import{collection as h,query as g,orderBy as p,getDocs as u,onSnapshot as f,limit as v,doc as w,setDoc as y,serverTimestamp as I,addDoc as b}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";!function(t){const e=()=>{window.currentUserId&&window.librariesLoaded&&"undefined"!=typeof google&&"undefined"!=typeof Chart&&s?t(window.currentUserId):requestAnimationFrame(e)};window.currentUserId&&window.librariesLoaded&&"undefined"!=typeof google?t(window.currentUserId):requestAnimationFrame(e)}(t=>{new L(t).init()});class L{constructor(t){this.userId=t,this.browsing={photoList:[],photoIndex:0,messageList:[],messageIndex:0},this.elements={statCards:{total:document.getElementById("totalDevices"),online:document.getElementById("onlineDevices"),warning:document.getElementById("warningDevices"),offline:document.getElementById("offlineDevices"),lost:document.getElementById("lostDevices")},devicesList:document.getElementById("devicesList"),notificationsList:document.getElementById("notificationsList"),map:document.getElementById("map"),filterButtons:document.querySelectorAll(".filter-btn"),searchInput:document.getElementById("searchInput"),actionsContainer:document.getElementById("dashboard-actions-container"),actionsPrompt:document.getElementById("actions-prompt"),actions:{},deviceStatusChart:document.getElementById("deviceStatusChart"),photoModal:{overlay:document.getElementById("viewPhotoModal"),img:document.getElementById("finderPhotoImg"),placeholder:document.getElementById("photoPlaceholder"),timestamp:document.getElementById("photoTimestamp"),indicator:document.getElementById("photoIndexIndicator"),prevBtn:document.getElementById("prevPhotoBtn"),nextBtn:document.getElementById("nextPhotoBtn"),closeBtns:[document.getElementById("viewPhotoClose"),document.getElementById("viewPhotoDone")]},msgModal:{overlay:document.getElementById("viewMessageModal"),text:document.getElementById("finderMessageText"),placeholder:document.getElementById("msgPlaceholder"),timestamp:document.getElementById("msgTimestamp"),indicator:document.getElementById("msgIndexIndicator"),prevBtn:document.getElementById("prevMsgBtn"),nextBtn:document.getElementById("nextMsgBtn"),closeBtns:[document.getElementById("viewMsgClose"),document.getElementById("viewMsgDone")]}},this.state={currentFilter:"all",currentDeviceId:null,allDevices:[],filteredDevices:[],map:null,markers:{},markerCluster:null,charts:{},lastCounts:{online:-1,warning:-1,offline:-1,lost:-1}}}init(){this.elements.actionsContainer&&t&&(this.elements.actionsContainer.innerHTML=t.map(t=>`\n                <button id="${t.id}" class="action-button" disabled>\n                    <i class="bi ${t.icon} ${t.textClass}"></i>\n                    <span>${t.label}</span>\n                </button>\n            `).join(""),this.elements.actions={ring:document.getElementById("action-ring"),viewPhotos:document.getElementById("action-view-photos"),viewMessages:document.getElementById("action-view-messages"),lost:document.getElementById("action-lost")}),this.setupEventListeners(),this.initMap(),this.listenForDevices(),this.listenForNotifications()}setupEventListeners(){this.elements.filterButtons.forEach(t=>{t.addEventListener("click",()=>{this.state.currentFilter=t.dataset.filter,this.elements.filterButtons.forEach(t=>t.classList.toggle("active",t.dataset.filter===this.state.currentFilter)),this.applyFilters()})}),this.elements.searchInput.addEventListener("input",i(()=>this.applyFilters(),300)),this.elements.actions.ring&&this.elements.actions.ring.addEventListener("click",()=>this.onSecurityAction("ring")),this.elements.actions.lost&&this.elements.actions.lost.addEventListener("click",()=>{const t=this.state.allDevices.find(t=>t.id===this.state.currentDeviceId)?.status;this.onSecurityAction("lost"===t?"found":"lost")}),this.elements.actions.viewPhotos&&this.elements.actions.viewPhotos.addEventListener("click",()=>this.openPhotoViewer()),this.elements.actions.viewMessages&&this.elements.actions.viewMessages.addEventListener("click",()=>this.openMessageViewer()),this.elements.photoModal.prevBtn&&this.elements.photoModal.prevBtn.addEventListener("click",()=>this.changePhoto(-1)),this.elements.photoModal.nextBtn&&this.elements.photoModal.nextBtn.addEventListener("click",()=>this.changePhoto(1)),this.elements.photoModal.closeBtns.forEach(t=>t?.addEventListener("click",()=>this.elements.photoModal.overlay.classList.remove("active"))),this.elements.msgModal.prevBtn&&this.elements.msgModal.prevBtn.addEventListener("click",()=>this.changeMessage(-1)),this.elements.msgModal.nextBtn&&this.elements.msgModal.nextBtn.addEventListener("click",()=>this.changeMessage(1)),this.elements.msgModal.closeBtns.forEach(t=>t?.addEventListener("click",()=>this.elements.msgModal.overlay.classList.remove("active"))),window.addEventListener("themeChanged",t=>this.updateTheme(t.detail.theme))}async openPhotoViewer(){const t=this.state.currentDeviceId;if(!t)return;const s=this.state.allDevices.find(e=>e.id===t);this.browsing.photoList=[],this.browsing.photoIndex=0,s.finder_photo_url&&this.browsing.photoList.push({url:s.finder_photo_url,time:s.finder_data_timestamp?s.finder_data_timestamp.toDate():new Date});try{const i=h(e,"user_data",this.userId,"devices",t,"evidence_logs"),n=g(i,p("timestamp","desc"));(await u(n)).forEach(t=>{const e=t.data();e.photo_url&&e.photo_url!==s.finder_photo_url&&this.browsing.photoList.push({url:e.photo_url,time:e.timestamp?e.timestamp.toDate():new Date})})}catch(i){console.error("Error fetching photos",i)}this.updatePhotoUI(),this.elements.photoModal.overlay.classList.add("active")}updatePhotoUI(){const t=this.elements.photoModal,e=this.browsing.photoList,s=this.browsing.photoIndex;if(e.length>0){const i=e[s];t.img.src=i.url,t.img.classList.remove("hidden"),t.placeholder.classList.add("hidden"),t.timestamp.textContent=`Captured: ${n(i.time)}`,t.indicator.textContent=`${s+1} / ${e.length}`,t.prevBtn.disabled=0===s,t.nextBtn.disabled=s===e.length-1}else t.img.classList.add("hidden"),t.placeholder.classList.remove("hidden"),t.timestamp.textContent="No photos available",t.indicator.textContent=""}changePhoto(t){-1===t&&this.browsing.photoIndex>0&&this.browsing.photoIndex--,1===t&&this.browsing.photoIndex<this.browsing.photoList.length-1&&this.browsing.photoIndex++,this.updatePhotoUI()}async openMessageViewer(){const t=this.state.currentDeviceId;if(!t)return;const s=this.state.allDevices.find(e=>e.id===t);this.browsing.messageList=[],this.browsing.messageIndex=0,s.finder_message&&this.browsing.messageList.push({text:s.finder_message,time:s.finder_data_timestamp?s.finder_data_timestamp.toDate():new Date});try{const i=h(e,"user_data",this.userId,"devices",t,"evidence_logs"),n=g(i,p("timestamp","desc"));(await u(n)).forEach(t=>{const e=t.data();e.message&&e.message!==s.finder_message&&this.browsing.messageList.push({text:e.message,time:e.timestamp?e.timestamp.toDate():new Date})})}catch(i){console.error("Error fetching messages",i)}this.updateMessageUI(),this.elements.msgModal.overlay.classList.add("active")}updateMessageUI(){const t=this.elements.msgModal,e=this.browsing.messageList,s=this.browsing.messageIndex;if(e.length>0){const i=e[s];t.text.textContent=`"${i.text}"`,t.text.classList.remove("hidden"),t.placeholder.classList.add("hidden"),t.timestamp.textContent=`Received: ${n(i.time)}`,t.indicator.textContent=`${s+1} / ${e.length}`,t.prevBtn.disabled=0===s,t.nextBtn.disabled=s===e.length-1}else t.text.classList.add("hidden"),t.placeholder.classList.remove("hidden"),t.timestamp.textContent="No messages available",t.indicator.textContent=""}changeMessage(t){-1===t&&this.browsing.messageIndex>0&&this.browsing.messageIndex--,1===t&&this.browsing.messageIndex<this.browsing.messageList.length-1&&this.browsing.messageIndex++,this.updateMessageUI()}listenForDevices(){const t=h(e,"user_data",this.userId,"devices"),s=g(t,p("name","asc"));f(s,t=>{if(this.state.allDevices=t.docs.map(t=>({id:t.id,...t.data()})),this.updateStats(),this.applyFilters(),this.state.currentDeviceId){const t=this.state.allDevices.find(t=>t.id===this.state.currentDeviceId);t?this.updateActionButtons(t):this.selectDevice(null)}})}listenForNotifications(){const t=h(e,"user_data",this.userId,"notifications"),s=g(t,p("timestamp","desc"),v(5));f(s,t=>{const e=t.docs.map(t=>({id:t.id,...t.data()}));this.renderNotificationsList(e)})}updateStats(){const t=this.state.allDevices.length,e=this.state.allDevices.filter(t=>"online"===t.status).length,s=this.state.allDevices.filter(t=>"offline"===t.status).length,i=this.state.allDevices.filter(t=>"lost"===t.status).length,n=this.state.allDevices.filter(t=>parseInt(t.battery||0,10)<20||"warning"===t.status).length;this.animateValue(this.elements.statCards.total,t),this.animateValue(this.elements.statCards.online,e),this.animateValue(this.elements.statCards.warning,n),this.animateValue(this.elements.statCards.offline,s),this.elements.statCards.lost&&this.animateValue(this.elements.statCards.lost,i);const a=this.state.lastCounts;(e!==a.online||n!==a.warning||s!==a.offline||i!==a.lost)&&(this.state.lastCounts={online:e,warning:n,offline:s,lost:i},this.updateDashboardCharts({online:e,warning:n,offline:s,lost:i}))}updateDashboardCharts(t){if(!this.elements.deviceStatusChart)return;const e=getComputedStyle(document.documentElement),s=e.getPropertyValue("--color-text-secondary"),i=e.getPropertyValue("--color-success"),n=e.getPropertyValue("--color-warning"),a=e.getPropertyValue("--color-danger"),o={labels:[`Online (${t.online})`,`Low Batt (${t.warning})`,`Offline (${t.offline})`,`Lost (${t.lost})`],datasets:[{data:[t.online,t.warning,t.offline,t.lost],backgroundColor:[i,n,"#64748b",a],borderColor:e.getPropertyValue("--color-bg-card"),borderWidth:4,cutout:"75%"}]};this.state.charts.deviceStatus?(this.state.charts.deviceStatus.data=o,this.state.charts.deviceStatus.update()):this.state.charts.deviceStatus=new Chart(this.elements.deviceStatusChart,{type:"doughnut",data:o,options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{color:s,boxWidth:12,padding:20}}}}})}initMap(){if(!this.elements.map)return;const t="dark"===document.documentElement.getAttribute("data-theme")?s.dark:s.light;this.state.map=new google.maps.Map(this.elements.map,{center:{lat:2.9436,lng:101.7949},zoom:12,disableDefaultUI:!0,zoomControl:!0,styles:t}),this.state.markerCluster=new markerClusterer.MarkerClusterer({map:this.state.map,markers:[]})}updateTheme(t){if(this.state.map&&s){const e="dark"===t?s.dark:s.light;this.state.map.setOptions({styles:e})}}applyFilters(){const t=this.elements.searchInput.value.toLowerCase();this.state.filteredDevices=this.state.allDevices.filter(e=>{const s="all"===this.state.currentFilter||e.status===this.state.currentFilter,i=!t||e.name&&e.name.toLowerCase().includes(t);return s&&i}),this.renderDeviceList(),this.renderMapMarkers()}selectDevice(t,e=!0){this.state.currentDeviceId=t;const s=this.state.allDevices.find(e=>e.id===t);if(this.renderDeviceList(),s&&s.location&&this.state.map&&this.state.markers[t]){const s=this.state.markers[t];e&&(this.state.map.panTo(s.getPosition()),this.state.map.setZoom(16),new google.maps.event.trigger(s,"click"))}this.updateActionButtons(s)}updateActionButtons(t){const e=this.elements.actions;if(t){e.ring&&(e.ring.disabled=!1),e.viewPhotos&&(e.viewPhotos.disabled=!1),e.viewMessages&&(e.viewMessages.disabled=!1),e.lost&&(e.lost.disabled=!1),this.elements.actionsPrompt.classList.add("hidden");const s=e.lost;if(s){const e=s.querySelector("i"),i=s.querySelector("span");"lost"===t.status?(e.className="bi bi-check-circle-fill text-green-500",i.textContent="Mark as Found"):(e.className="bi bi-exclamation-diamond-fill text-red-500",i.textContent="Mark as Lost")}}else e.ring&&(e.ring.disabled=!0),e.viewPhotos&&(e.viewPhotos.disabled=!0),e.viewMessages&&(e.viewMessages.disabled=!0),e.lost&&(e.lost.disabled=!0),this.elements.actionsPrompt.classList.remove("hidden")}async onSecurityAction(t){const s=this.state.allDevices.find(t=>t.id===this.state.currentDeviceId);if(!s)return;const i=a(s.name),n={ring:{title:"Sound Alarm?",message:`Sound a loud alarm on <strong>${i}</strong>?`,type:"info"},lost:{title:"Mark as Lost?",message:`Enable tracking and lock <strong>${i}</strong>?`,type:"danger"},found:{title:"Mark as Found?",message:`Mark <strong>${i}</strong> as found?`,type:"success"},wipe:{title:"Wipe Device?",message:`Irreversibly erase <strong>${i}</strong>?`,type:"danger"}}[t];n&&o(n.title,n.message,n.type,async()=>{try{const n=w(e,"user_data",this.userId,"devices",s.id);if("lost"===t||"found"===t){const e="lost"===t?"lost":"online";await y(n,{status:e},{merge:!0})}else await y(n,{pending_action:t,action_timestamp:I()},{merge:!0});const a=h(e,"user_data",this.userId,"notifications");let o="Security Action",r=`Command "${t}" sent to ${i}.`,l="info";"ring"===t?(o="Alarm Triggered",l="warning"):"lost"===t?(o="Device Marked Lost",l="lost-mode",r=`${i} is now in Lost Mode.`):"found"===t?(o="Device Found",l="success",r=`${i} marked as found.`):"wipe"===t&&(o="Wipe Command Sent",l="security",r=`Remote wipe initiated for ${i}.`),await b(a,{title:o,message:r,type:l,read:!1,timestamp:I()})}catch(n){console.error("Error executing security action:",n),r("Error","Could not send command.","error")}},null,{isHTML:!0})}renderMapMarkers(){if(!this.state.map||!this.state.markerCluster)return;const t=new Set,e=new google.maps.LatLngBounds;let s=!1;this.state.filteredDevices.forEach(i=>{t.add(i.id);let n=i.location?.lat??i.location?.latitude,a=i.location?.lng??i.location?.longitude;if(n=parseFloat(n),a=parseFloat(a),isNaN(n)||isNaN(a))return;const o={lat:n,lng:a};s=!0,e.extend(o);const r={online:"#10b981",found:"#10b981",offline:"#64748b",lost:"#ef4444",warning:"#f59e0b"}[i.status]||"#64748b",d=`\n                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 80 80">\n                    ${"offline"!==i.status?'\n                    <circle cx="40" cy="40" r="18" fill="#4361ee" stroke="#4361ee" stroke-width="2" opacity="0.6">\n                        <animate attributeName="r" from="18" to="40" dur="1.5s" repeatCount="indefinite" />\n                        <animate attributeName="opacity" from="0.8" to="0" dur="1.5s" repeatCount="indefinite" />\n                    </circle>':""}\n                    <circle cx="40" cy="40" r="18" fill="${r}" stroke="white" stroke-width="3" />\n                    <g transform="translate(28, 28)">\n                        <path fill="white" d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/>\n                    </g>\n                </svg>`,c={url:"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(d),scaledSize:new google.maps.Size(48,48),anchor:new google.maps.Point(24,24)};if(this.state.markers[i.id]){const t=this.state.markers[i.id];t.setIcon(c),l(t,o),google.maps.event.clearListeners(t,"click"),this.attachInfoWindow(t,i)}else{const t=new google.maps.Marker({position:o,title:i.name,icon:c,optimized:!1,map:this.state.map});this.attachInfoWindow(t,i),this.state.markerCluster.addMarker(t),this.state.markers[i.id]=t}}),Object.keys(this.state.markers).forEach(e=>{if(!t.has(e)){const t=this.state.markers[e];this.state.markerCluster.removeMarker(t),t.setMap(null),delete this.state.markers[e]}}),this.state.markerCluster.repaint(),!s||this.state.currentDeviceId||this.mapBoundsInitialized||(this.state.map.fitBounds(e),this.mapBoundsInitialized=!0)}attachInfoWindow(t,e){const s=`\n            <div style="color: black; padding: 5px;">\n                <h3 style="margin: 0 0 5px 0; font-size: 16px;">${a(e.name)}</h3>\n                <p style="margin: 0;">Status: <strong>${e.status}</strong></p>\n                <p style="margin: 0;">Battery: ${e.battery}%</p>\n            </div>`,i=new google.maps.InfoWindow({content:s});t.addListener("click",()=>{i.open(this.state.map,t),this.selectDevice(e.id,!1)})}attachInfoWindow(t,e){const s=e.lastSeen&&"function"==typeof e.lastSeen.toDate?d(e.lastSeen.toDate()):"Never",i=`\n            <div style="color: black; padding: 5px;">\n                <h3 style="margin: 0 0 5px 0; font-size: 16px;">${a(e.name)}</h3>\n                <p style="margin: 0;">Status: <strong>${e.status}</strong></p>\n                <p style="margin: 0;">Battery: ${e.battery}%</p>\n                <p style="margin: 0; font-size: 12px; color: #666;">Seen: ${s}</p>\n            </div>`,n=new google.maps.InfoWindow({content:i});t.addListener("click",()=>{n.open(this.state.map,t),this.selectDevice(e.id,!1)})}animateMarkerTo(t,e){const s=t.getPosition(),i=s.lat(),n=s.lng(),a=e.lat-i,o=e.lng-n;if(Math.abs(a)>.1||Math.abs(o)>.1)return void t.setPosition(e);if(Math.abs(a)<1e-5&&Math.abs(o)<1e-5)return;const r=performance.now(),l=e=>{const s=e-r,d=Math.min(s/1e3,1),c=d*(2-d),m=i+a*c,h=n+o*c;t.setPosition({lat:m,lng:h}),d<1&&requestAnimationFrame(l)};requestAnimationFrame(l)}renderDeviceList(){this.elements.devicesList.innerHTML="",this.state.filteredDevices.forEach(t=>{const e=document.createElement("div");e.className="device-item "+(t.id===this.state.currentDeviceId?"active":""),e.onclick=()=>this.selectDevice(t.id),e.innerHTML=`\n                <i class="bi ${c(t.type)} text-2xl" style="color: ${m(t.status)}"></i>\n                <div class="flex-1 overflow-hidden"><div class="font-medium truncate">${a(t.name)}</div></div>\n                <div class="text-sm text-right" style="color: ${m(t.status)}">${t.status}</div>\n            `,this.elements.devicesList.appendChild(e)})}renderNotificationsList(t){this.elements.notificationsList.innerHTML="",t.forEach(t=>{const e=document.createElement("div");e.className="notification-item";let s=t.timestamp||t.time,i="Just now";i=s&&"function"==typeof s.toDate?d(s.toDate()):d(new Date),e.innerHTML=`\n                <i class="bi bi-info-circle text-blue-500"></i>\n                <div class="flex-1">\n                    <p class="text-sm">${a(t.message||"")}</p>\n                    <p class="text-xs text-gray-500">${i}</p>\n                </div>\n            `,this.elements.notificationsList.appendChild(e)})}animateValue(t,e){t&&(t.innerHTML=e)}}
