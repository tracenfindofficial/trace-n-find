import"./modulepreload-polyfill-YP0FEG5d.js";import{a as e,f as t,b as r}from"./app-shell-CtSII-jN.js";import{b as s,s as n,a as o,c as a}from"./shared-utils-DEXrBstL.js";import{doc as i,setDoc as c,updateDoc as l}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import{updateProfile as u,multiFactor as m,RecaptchaVerifier as d,PhoneAuthProvider as f,PhoneMultiFactorGenerator as p}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";const g={profileForm:document.getElementById("profile-settings-form"),profileName:document.getElementById("profile-name"),profileEmail:document.getElementById("profile-email"),saveProfileBtn:document.getElementById("save-profile-btn"),preferencesForm:document.getElementById("preferences-form"),themeToggleSwitch:document.getElementById("theme-toggle-switch"),savePreferencesBtn:document.getElementById("save-preferences-btn"),deleteAccountBtn:document.getElementById("delete-account-btn"),allUserNames:document.querySelectorAll(".user-name-display"),sidebarUserEmail:document.getElementById("userEmail"),allUserAvatars:document.querySelectorAll(".user-avatar-display")};async function h(){const e=r.currentUser;if(e)if(m(e).enrolledFactors.length>0)a("Disable MFA?","Are you sure you want to disable Multi-Factor Authentication? Your account will be less secure.","warning",async()=>{try{const s=m(e).enrolledFactors[0];await m(e).unenroll(s);try{const r=i(t,"user_data",e.uid,"profile","settings");await l(r,{mfa_enabled:!1})}catch(r){console.log("Profile sync skipped")}o("Success","MFA has been disabled.","warning"),setTimeout(()=>location.reload(),1e3)}catch(r){o("Error",r.message,"error")}});else try{window.recaptchaVerifier||(window.recaptchaVerifier=new d(r,"recaptcha-container",{size:"invisible"}));let n=e.phoneNumber;if(n||(n=prompt("Please enter your phone number for MFA (e.g., +60123456789):")),!n)return;o("Info","Sending verification code...","info");const a=await new f(r).verifyPhoneNumber({phoneNumber:n,session:null},window.recaptchaVerifier),c=prompt(`Enter the SMS code sent to ${n}:`);if(!c)return;const u=f.credential(a,c),g=p.assertion(u);await m(e).enroll(g,"My Phone Number");try{const r=i(t,"user_data",e.uid,"profile","settings");await l(r,{mfa_enabled:!0})}catch(s){console.log("Profile update skipped")}o("Success","MFA Enabled! Please login again.","success"),setTimeout(()=>location.reload(),1500)}catch(n){if(console.error(n),o("Error","MFA Setup Failed: "+n.message,"error"),window.recaptchaVerifier){try{window.recaptchaVerifier.clear()}catch(s){}window.recaptchaVerifier=null}}}!function(t){const r=()=>{e.currentUser?(console.log("Settings Logic: Auth is ready."),t(e.currentUser)):(console.log("Settings logic waiting for authentication..."),requestAnimationFrame(r))};requestAnimationFrame(r)}(l=>{!async function(e){e.email&&(g.profileEmail.value=e.email);g.profileName.value=e.displayName||"New User";const t=e.theme||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");g.themeToggleSwitch&&(g.themeToggleSwitch.checked="dark"===t)}(l),function(l){g.profileForm.addEventListener("submit",a=>async function(a,l){a.preventDefault(),s(g.saveProfileBtn,!0);const m=n(g.profileName.value.trim());if(m.length<2)return o("Error","Name must be at least 2 characters.","error"),void s(g.saveProfileBtn,!1);try{const s=i(t,"user_data",l,"profile","settings");await c(s,{fullName:m},{merge:!0}),r.currentUser&&await u(r.currentUser,{displayName:m}),e.currentUser.displayName=m,e.currentUser.fullName=m;const n=`https://ui-avatars.com/api/?name=${encodeURIComponent(m)}&background=4361ee&color=fff&size=40`;e.currentUser.photoURL=n,g.allUserNames&&g.allUserNames.forEach(e=>e.textContent=m),g.allUserAvatars.forEach(e=>e.src=n),o("Success","Profile updated successfully!","success")}catch(d){console.error("Error saving profile:",d),o("Error","Could not save profile.","error")}finally{s(g.saveProfileBtn,!1)}}(a,l)),g.preferencesForm&&g.preferencesForm.addEventListener("submit",r=>async function(r,n){r.preventDefault(),s(g.savePreferencesBtn,!0);const a=g.themeToggleSwitch.checked?"dark":"light";try{const r=i(t,"user_data",n,"profile","settings");await c(r,{theme:a},{merge:!0}),e.currentUser.theme=a,localStorage.setItem("theme",a),document.documentElement.setAttribute("data-theme",a),document.documentElement.classList.toggle("dark","dark"===a);const s=document.querySelector("#themeToggle i");s&&(s.className="dark"===a?"bi bi-sun-fill":"bi bi-moon-fill"),o("Success","Preferences saved!","success")}catch(l){console.error("Error saving preferences:",l),o("Error","Could not save preferences.","error")}finally{s(g.savePreferencesBtn,!1)}}(r,l));g.deleteAccountBtn.addEventListener("click",()=>function(e){a("Delete Your Account?","This is permanent. All your devices, geofences, and settings will be erased. <strong>This action cannot be undone.</strong> Are you absolutely sure?","danger",async()=>{console.log(`User ${e} confirmed account deletion. Triggering Cloud Function (demo)...`),o("Request Sent","Account deletion request sent. This must be handled by a secure server function.","info")},null,{isHTML:!0})}(l))}(l.uid),function(e){const t=document.getElementById("mfa-toggle-btn");t&&(m(e).enrolledFactors.length>0&&(t.textContent="Disable MFA",t.classList.remove("btn-primary"),t.classList.add("btn-danger")),t.addEventListener("click",h))}(l)});
