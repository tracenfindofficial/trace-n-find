import"./modulepreload-polyfill-YP0FEG5d.js";import{f as t}from"./app-shell-CtSII-jN.js";import{m as e}from"./map-tiles-D1fw3GxV.js";import{a as o,s as n}from"./shared-utils-DEXrBstL.js";import{collection as i,query as a,orderBy as r,getDocs as s,doc as l,getDoc as c}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";let d=null,m=null,g=[],p={};const u={mapContainer:document.getElementById("map"),deviceFilter:document.getElementById("deviceFilter"),dateFilter:document.getElementById("dateFilter"),refreshButton:document.getElementById("refreshButton"),timelineList:document.getElementById("timeline-list"),timelineEmpty:document.getElementById("timeline-empty"),historyTitleHeader:document.getElementById("history-title-header"),statTotalPoints:document.getElementById("stat-total-points"),statTotalDistance:document.getElementById("stat-total-distance"),statMostVisited:document.getElementById("stat-most-visited"),statDuration:document.getElementById("stat-duration")};async function f(e){const n=u.deviceFilter.value,i=u.dateFilter.value;if(n&&i){if(u.historyTitleHeader){const t=new Date(i).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",timeZone:"UTC"});u.historyTitleHeader.textContent=`History of ${t}`}try{const a=l(t,"user_data",e,"devices",n,"location_history",i),r=await c(a);if(!r.exists())return console.log("No history document found."),h(0,0,"0h 0m"),y([],n),x([]),void o("Info","No history found for this date.","info");let s=r.data().route||[];s.sort((t,e)=>(b(t)?.getTime()||0)-(b(e)?.getTime()||0)),console.log(`Found ${s.length} sorted history points.`);const d=function(t){if(!t||t.length<2)return 0;let e=0;if("undefined"!=typeof google&&google.maps.geometry)for(let o=0;o<t.length-1;o++){const n=v(t[o]),i=v(t[o+1]);n&&i&&(e+=google.maps.geometry.spherical.computeDistanceBetween(n,i))}return e/1e3}(s),m=function(t){if(!t||t.length<2)return"0h 0m";const e=t[0],o=t[t.length-1],n=b(e),i=b(o);if(!n||!i)return"N/A";const a=Math.abs(i-n),r=Math.floor(a/6e4),s=Math.floor(r/60);return`${s}h ${r%60}m`}(s);h(s.length,d,m),y(s,n),x(s)}catch(a){console.error("Error loading history:",a),o("Error","Could not load history.","error")}}}function h(t,e,o){u.statTotalPoints&&(u.statTotalPoints.textContent=t),u.statTotalDistance&&(u.statTotalDistance.textContent=`${e.toFixed(2)} km`),u.statDuration&&o&&(u.statDuration.textContent=o)}function y(t,e){if(!d)return;m&&(m.setMap(null),m=null),g.forEach(t=>t.setMap(null)),g=[];const o=p[e];if(!o)return;if(!t||0===t.length){if(o.location){const t=v(o.location);if(t){const e=new google.maps.Marker({position:t,map:d,title:"Current Location",animation:google.maps.Animation.DROP}),i=new google.maps.InfoWindow({content:`<b>${n(o.name)}</b><br>Current Location<br><small>No history for this date</small>`});e.addListener("click",()=>i.open(d,e)),d.setCenter(t),d.setZoom(15),g.push(e)}}return}const i=new google.maps.LatLngBounds,a=[];if(t.forEach(t=>{const e=v(t);e&&(a.push(e),i.extend(e))}),a.length>1){!function(t){const e={path:google.maps.SymbolPath.FORWARD_CLOSED_ARROW,scale:3,strokeColor:"#4361ee",fillColor:"#4361ee",fillOpacity:1};m=new google.maps.Polyline({path:t,geodesic:!0,strokeColor:"#4361ee",strokeOpacity:.8,strokeWeight:5,icons:[{icon:e,offset:"0",repeat:"100px"}]}),m.setMap(d)}(a),d.fitBounds(i);const t={top:50,right:50,bottom:50,left:50};d.fitBounds(i,t)}else 1===a.length&&(d.setCenter(a[0]),d.setZoom(16));if(t.length>0){if(w(t[0],"Start Point",!1,o),t.length>2)for(let e=1;e<t.length-1;e++){const o=t[e],n=v(o);if(n){const t=new google.maps.Marker({position:n,map:d,icon:{path:google.maps.SymbolPath.CIRCLE,scale:3,fillColor:"#4361ee",fillOpacity:.8,strokeWeight:0},title:b(o)?.toLocaleTimeString()||"History Point",zIndex:1});g.push(t)}}w(t[t.length-1],"End Point (Latest)",!0,o)}}function w(t,e,o,n){const i=v(t);if(!i)return;let a=null;if(o){const t={online:"#10b981",found:"#10b981",offline:"#ef4444",lost:"#ef4444",warning:"#f59e0b"}[n.status]||"#64748b";a={url:"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(`\n            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 80 80">\n                <circle cx="40" cy="40" r="18" fill="${t}" stroke="white" stroke-width="3" />\n                <g transform="translate(28, 28)">\n                    <path fill="white" d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/>\n                </g>\n            </svg>`),scaledSize:new google.maps.Size(48,48),anchor:new google.maps.Point(24,24)}}else a={path:google.maps.SymbolPath.CIRCLE,scale:7,fillColor:"#10b981",fillOpacity:1,strokeWeight:2,strokeColor:"white"};const r=new google.maps.Marker({position:i,map:d,icon:a,title:e,zIndex:o?1e3:900,animation:o?google.maps.Animation.DROP:null});let s="N/A";const l=b(t);l&&(s=l.toLocaleTimeString());const c=new google.maps.InfoWindow({content:`\n            <div style="text-align:center; color:black; padding:5px;">\n                <div style="font-weight:bold; color:#4361ee; margin-bottom:2px;">${e}</div>\n                <div style="font-size:12px; color:#333">${s}</div>\n                <div style="font-size:10px; color:#666; margin-top:2px;">${i.lat().toFixed(5)}, ${i.lng().toFixed(5)}</div>\n            </div>\n        `});r.addListener("click",()=>c.open(d,r)),g.push(r)}function v(t){if(!t)return null;let e=t.lat??t.latitude,o=t.lng??t.longitude;return e=parseFloat(e),o=parseFloat(o),isNaN(e)||isNaN(o)?null:new google.maps.LatLng(e,o)}function b(t){if(!t)return null;if(t.timestamp&&"function"==typeof t.timestamp.toDate)return t.timestamp.toDate();if(t.time&&"function"==typeof t.time.toDate)return t.time.toDate();if("string"==typeof t.time){let e=t.time.replace("at","").replace("UTC+8","").trim();const o=new Date(e);if(!isNaN(o))return o}return null}function x(t){const e=u.timelineList;if(!e)return;if(e.innerHTML="",!t||0===t.length)return void(u.timelineEmpty&&u.timelineEmpty.classList.remove("hidden"));u.timelineEmpty&&u.timelineEmpty.classList.add("hidden");const o=document.createElement("div");o.className="p-4 space-y-0";const n=[...t].reverse();n.forEach((e,i)=>{const a=t.length-i,r=parseFloat(e.lat||e.latitude),s=parseFloat(e.lng||e.longitude);let l="N/A";const c=b(e);c&&(l=c.toLocaleTimeString());const d=document.createElement("div");d.className="flex gap-4 pb-4 relative";const m=i===n.length-1?"":"h-full";d.innerHTML=`\n            <div class="flex flex-col items-center relative">\n                <div class="w-6 h-6 bg-primary-600 text-white text-[10px] font-bold rounded-full z-10 ring-4 ring-white dark:ring-gray-800 flex items-center justify-center shadow-sm">\n                    ${a}\n                </div>\n                <div class="w-0.5 bg-gray-200 dark:bg-gray-700 absolute top-3 ${m}" style="height: calc(100% + 1rem);"></div>\n            </div>\n            <div class="flex-1 pb-2 border-b border-gray-100 dark:border-gray-700 last:border-0">\n                <div class="flex justify-between items-center">\n                    <p class="text-sm font-semibold text-gray-800 dark:text-white">${l}</p>\n                </div>\n                <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 font-mono">\n                    ${r.toFixed(5)}, ${s.toFixed(5)}\n                </p>\n                <button class="text-xs text-primary-600 mt-1 hover:underline flex items-center gap-1" \n                    onclick="window.focusMapOnPoint(${r}, ${s})">\n                    <i class="bi bi-crosshair"></i> View on Map\n                </button>\n            </div>\n        `,o.appendChild(d)}),e.appendChild(o)}!function(t){const o=()=>{window.currentUserId&&window.librariesLoaded&&"undefined"!=typeof google&&e?t(window.currentUserId):requestAnimationFrame(o)};window.currentUserId&&window.librariesLoaded&&"undefined"!=typeof google?t(window.currentUserId):requestAnimationFrame(o)}(n=>{!function(){if(!u.mapContainer)return;const t="dark"===document.documentElement.getAttribute("data-theme")?e.dark:e.light;d=new google.maps.Map(u.mapContainer,{center:{lat:2.9436,lng:101.7949},zoom:13,disableDefaultUI:!0,zoomControl:!0,styles:t,mapTypeId:"roadmap"})}(),function(t){u.refreshButton&&u.refreshButton.addEventListener("click",()=>f(t));u.deviceFilter&&u.deviceFilter.addEventListener("change",()=>f(t));u.dateFilter&&u.dateFilter.addEventListener("change",()=>f(t));window.addEventListener("themeChanged",t=>{if(d&&e){const o="dark"===t.detail.theme?e.dark:e.light;d.setOptions({styles:o})}})}(n),function(){const t=document.getElementById("dateFilter");if(t&&!t.value){const e=new Date,o=new Date(e.getTime()-6e4*e.getTimezoneOffset()).toISOString().split("T")[0];return t.value=o,o}t&&t.value}(),async function(e){const n=i(t,"user_data",e,"devices"),l=a(n,r("name","asc"));try{const t=await s(l);if(u.deviceFilter&&(u.deviceFilter.innerHTML=""),p={},t.empty)return void(u.deviceFilter&&(u.deviceFilter.innerHTML='<option value="">No Devices</option>'));let o=null,n=!0;t.forEach(t=>{const e=t.data();p[t.id]=e,n&&(o=t.id,n=!1);const i=document.createElement("option");i.value=t.id,i.textContent=e.name||e.model||"Unnamed Device",u.deviceFilter&&u.deviceFilter.appendChild(i)}),o&&u.deviceFilter&&(u.deviceFilter.value=o,f(e))}catch(c){console.error("Error loading devices:",c),o("Error","Could not load devices.","error")}}(n)}),window.focusMapOnPoint=(t,e)=>{if(d&&!isNaN(t)&&!isNaN(e)){const o={lat:t,lng:e};d.panTo(o),d.setZoom(18);const n=new google.maps.Marker({position:o,map:d,animation:google.maps.Animation.BOUNCE,icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:"#f59e0b",fillOpacity:1,strokeWeight:2,strokeColor:"white"}});setTimeout(()=>n.setMap(null),2e3)}};
