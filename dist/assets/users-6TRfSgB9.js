import"./modulepreload-polyfill-YP0FEG5d.js";import{f as e}from"./admin-app-shell-Cas55neG.js";import{a as t,c as s}from"./shared-utils-DEXrBstL.js";import{collection as n,query as a,onSnapshot as r,doc as o,getDoc as i}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";let d=[],l=null;const u={usersTableBody:document.getElementById("users-table-body"),usersEmptyState:document.getElementById("users-empty-state"),usersLoadingState:document.getElementById("users-loading-state"),searchInput:document.getElementById("user-search-input")};function c(e,t){u.usersTableBody.innerHTML="";const s=e.filter(e=>e.fullName.toLowerCase().includes(t)||e.email.toLowerCase().includes(t)||e.id.toLowerCase().includes(t));if(0===s.length)return u.usersEmptyState.style.display="table-row",void u.usersTableBody.appendChild(u.usersEmptyState);u.usersEmptyState.style.display="none",s.forEach(e=>{const t=document.createElement("tr");t.className="animate-fade-in";const s=`https://ui-avatars.com/api/?name=${encodeURIComponent(e.fullName)}&background=4361ee&color=fff&size=40`,n="Active"===e.status?"badge-success":"badge-danger";t.innerHTML=`\n            \x3c!-- User Column --\x3e\n            <td>\n                <div class="flex items-center gap-3">\n                    <img src="${s}" alt="${e.fullName}" class="w-10 h-10 rounded-full flex-shrink-0">\n                    <div class="flex-1 overflow-hidden">\n                        <div class="font-medium text-text-primary dark:text-dark-text-primary truncate">${e.fullName}</div>\n                        <div class="text-sm text-text-secondary dark:text-dark-text-secondary truncate">${e.email}</div>\n                    </div>\n                </div>\n            </td>\n            \x3c!-- User ID Column --\x3e\n            <td class="text-sm text-text-secondary dark:text-dark-text-secondary font-mono">${e.id}</td>\n            \x3c!-- Devices Column --\x3e\n            <td class="text-sm text-text-secondary dark:text-dark-text-secondary">${e.deviceCount}</td>\n            \x3c!-- Status Column --\x3e\n            <td>\n                <span class="badge ${n}">${e.status}</span>\n            </td>\n            \x3c!-- Actions Column --\x3e\n            <td>\n                <div class="flex gap-2">\n                    <button class="btn btn-secondary btn-sm btn-edit-user" data-id="${e.id}" title="Edit User">\n                        <i class="bi bi-pencil-fill"></i>\n                    </button>\n                    <button class="btn btn-secondary btn-sm btn-delete-user" data-id="${e.id}" title="Delete User">\n                        <i class="bi bi-trash-fill text-danger"></i>\n                    </button>\n                </div>\n            </td>\n        `,u.usersTableBody.appendChild(t)})}function m(e){e?(u.usersTableBody.innerHTML="",u.usersLoadingState.style.display="table-row",u.usersEmptyState.style.display="none"):u.usersLoadingState.style.display="none"}!function(e){const t=()=>{window.currentUserIsAdmin?(console.log("User Management Logic: Auth is ready."),e(window.currentUserId)):(console.log("User Management logic waiting for admin authentication..."),requestAnimationFrame(t))};requestAnimationFrame(t)}(f=>{!function(){m(!0);const s=n(e,"user_data"),f=a(s);l&&l();l=r(f,t=>{if(m(!1),t.empty)return u.usersEmptyState.style.display="table-row",u.usersTableBody.innerHTML="",void u.usersTableBody.appendChild(u.usersEmptyState);const s=t.docs.map(t=>async function(t){try{const s=o(e,"user_data",t,"profile","settings"),n=await i(s);if(n.exists()){const e=n.data();return{id:t,fullName:e.fullName||"New User",email:e.email||"No Email Provided",deviceCount:e.deviceCount||"N/A",status:e.status||"Active"}}return{id:t,fullName:"New User",email:"Email not found",deviceCount:"N/A",status:"Active"}}catch(s){return console.warn("Could not fetch profile for user:",t,s),{id:t,fullName:"Error Loading",email:"",deviceCount:"N/A",status:"Error"}}}(t.id));Promise.all(s).then(e=>{d=e,c(d,u.searchInput.value.toLowerCase())})},e=>{console.error("Error listening for users:",e),t("Error","Could not load user data.","error"),m(!1),u.usersEmptyState.style.display="table-row"})}(),u.searchInput.addEventListener("input",e=>{c(d,e.target.value.toLowerCase())}),u.usersTableBody.addEventListener("click",e=>{const n=e.target.closest("button");if(!n)return;const a=n.dataset.id;n.matches(".btn-delete-user")&&function(e){const n=d.find(t=>t.id===e),a=n?n.fullName:"this user";s(!0,"Delete User?",`Are you sure you want to permanently delete <strong>${a}</strong>? This will erase all their associated data (devices, geofences, etc.) and cannot be undone.`,"Delete User","btn-danger",()=>{console.log(`Requesting deletion for user: ${e} (via Cloud Function)`),t("Deletion Requested",`A request to delete ${a} has been sent. This must be handled by a secure server function.`,"info")})}(a)})});
