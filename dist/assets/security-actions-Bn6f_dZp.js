import"./modulepreload-polyfill-YP0FEG5d.js";import{S as e,a as t,f as s}from"./app-shell-CtSII-jN.js";import{g as n,d as o,c as i,a,f as d}from"./shared-utils-DEXrBstL.js";import{writeBatch as c,doc as l,serverTimestamp as r,collection as m,addDoc as u,query as g,orderBy as h,getDocs as p}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";let v=[],y=new Set,f=[],b=0,w=[],x=0;const E={deviceList:document.getElementById("device-list"),deviceListEmpty:document.getElementById("device-list-empty"),selectAllCheckbox:document.getElementById("select-all"),selectedCount:document.getElementById("selected-count"),actionButtons:{ring:document.getElementById("action-ring"),viewPhotos:document.getElementById("action-view-photos"),viewMessages:document.getElementById("action-view-messages"),lost:document.getElementById("action-lost")},photoModal:document.getElementById("viewPhotoModal"),photoImg:document.getElementById("finderPhotoImg"),photoPlaceholder:document.getElementById("photoPlaceholder"),photoTimestamp:document.getElementById("photoTimestamp"),photoIndexIndicator:document.getElementById("photoIndexIndicator"),btnPrevPhoto:document.getElementById("prevPhotoBtn"),btnNextPhoto:document.getElementById("nextPhotoBtn"),photoCloseBtns:[document.getElementById("viewPhotoClose"),document.getElementById("viewPhotoDone")],msgModal:document.getElementById("viewMessageModal"),msgText:document.getElementById("finderMessageText"),msgPlaceholder:document.getElementById("msgPlaceholder"),msgTimestamp:document.getElementById("msgTimestamp"),msgIndexIndicator:document.getElementById("msgIndexIndicator"),btnPrevMsg:document.getElementById("prevMsgBtn"),btnNextMsg:document.getElementById("nextMsgBtn"),msgCloseBtns:[document.getElementById("viewMsgClose"),document.getElementById("viewMsgDone")]};function B(e){v=e||[];const t=new Set(v.map(e=>e.id));y.forEach(e=>{t.has(e)||y.delete(e)}),I(),L()}function I(){E.deviceList.innerHTML="",v&&0!==v.length?(E.deviceListEmpty&&E.deviceListEmpty.classList.add("hidden"),v.forEach((e,t)=>{const s=document.createElement("div");s.className="device-list-item",s.style.animationDelay=50*t+"ms";const i=y.has(e.id),a=n(e.status),d=e.status?e.status.charAt(0).toUpperCase()+e.status.slice(1):"Unknown",c=o(e.type||"phone");s.innerHTML=`\n            <input type="checkbox" id="device-${e.id}" data-id="${e.id}" class="device-checkbox h-5 w-5 text-primary rounded border-gray-300 focus:ring-primary cursor-pointer" ${i?"checked":""}>\n            \n            <label for="device-${e.id}" class="device-icon-wrapper flex items-center justify-center rounded-lg cursor-pointer flex-shrink-0" style="width: 40px; height: 40px; background-color: ${a}20; margin-left: 12px;">\n                <i class="bi ${c}" style="color: ${a}; font-size: 1.25rem;"></i>\n            </label>\n            \n            <label for="device-${e.id}" class="flex-1 ml-4 cursor-pointer">\n                <div class="font-semibold text-text-primary dark:text-dark-text-primary">${e.name}</div>\n                ${e.model?`<div class="text-sm text-text-secondary dark:text-dark-text-secondary">${e.model}</div>`:""}\n            </label>\n            \n            <div class="text-sm font-medium" style="color: ${a};">\n                ${d}\n            </div>\n        `,E.deviceList.appendChild(s)})):E.deviceListEmpty&&E.deviceListEmpty.classList.remove("hidden")}function L(){const e=y.size;E.selectedCount.textContent=0===e?"0 devices selected":1===e?"1 device selected":`${e} devices selected`,v.length>0?(E.selectAllCheckbox.checked=e===v.length,E.selectAllCheckbox.indeterminate=e>0&&e<v.length):(E.selectAllCheckbox.checked=!1,E.selectAllCheckbox.indeterminate=!1);const t=v.filter(e=>y.has(e.id)),s=t.some(e=>"offline"===e.status);E.actionButtons.ring&&(E.actionButtons.ring.disabled=0===e||s);const n=1===e;E.actionButtons.viewPhotos&&(E.actionButtons.viewPhotos.disabled=!n),E.actionButtons.viewMessages&&(E.actionButtons.viewMessages.disabled=!n);const o=E.actionButtons.lost;if(o&&(o.disabled=0===e,e>0)){t.every(e=>"lost"===e.status)?(o.dataset.currentAction="found",o.classList.remove("danger"),o.classList.add("success"),o.innerHTML='<i class="bi bi-check-circle-fill"></i><span>Mark as Found</span>'):(o.dataset.currentAction="lost",o.classList.remove("success"),o.classList.add("danger"),o.innerHTML='<i class="bi bi-exclamation-diamond-fill"></i><span>Mark as Lost</span>')}}async function P(e){const t=y.size;if(0===t)return;const n=y.values().next().value,o=v.find(e=>e.id===n),d=1===t?`<strong>${o?o.name:"Device"}</strong>`:`<strong>${t} devices</strong>`,g={ring:{title:"Sound Alarm?",message:`Sound an alarm on ${d}?`,btn:"Alarm",type:"info"},lost:{title:"Mark as Lost?",message:`Enable tracking and lock ${d}?`,btn:"Mark Lost",type:"danger"},found:{title:"Mark as Found?",message:`Restore normal status for ${d}?`,btn:"Mark Found",type:"success"},wipe:{title:"Wipe Devices?",message:`PERMANENTLY erase all data on ${d}? This action cannot be undone.`,btn:"Erase Data",type:"danger"}}[e];g&&i(g.title,g.message,g.type,async()=>{let n={};n="lost"===e||"found"===e?{status:"lost"===e?"lost":"online"}:{pending_action:e},await async function(e,t,n,o){const i=c(s),d=window.currentUserId,g=[];y.forEach(n=>{const o=l(s,"user_data",d,"devices",n),a={...t,action_timestamp:r()};i.update(o,a);const c=m(s,"user_data",d,"devices",n,"activity");let h="info",p=`Command '${e}' executed.`;"ring"===e?(h="warning",p="Remote alarm triggered manually."):"lost"===e?(h="lost-mode",p="Device marked as Lost."):"found"===e?(h="security",p="Device marked as Found."):"wipe"===e?(h="security",p="Remote wipe command sent."):"lock"===e&&(h="security",p="Remote lock command sent."),g.push(u(c,{type:h,message:p,timestamp:r()}))});try{if(await i.commit(),await Promise.all(g),"lost"!==e&&"found"!==e){const t=m(s,"user_data",d,"notifications");let i="Security Action",a=`Command "${e}" sent successfully.`,c="security";"ring"===e?(i="Alarm Triggered",a=`Alarm sound sent to ${n>1?n+" devices":o}.`,c="security"):"wipe"===e&&(i="Wipe Initiated",a=`Wipe command sent to ${n>1?n+" devices":o}.`,c="danger"),await u(t,{title:i,message:a,type:c,read:!1,timestamp:r()})}"wipe"===e&&(y.clear(),I(),L())}catch(h){console.error("Error executing action:",h),a("Error","Could not send command.","error")}}(e,n,t,o?.name||"Device")},null,{isHTML:!0})}async function k(){if(1!==y.size)return;const e=y.values().next().value,t=v.find(t=>t.id===e),n=window.currentUserId;f=[],b=0,t.finder_photo_url&&f.push({url:t.finder_photo_url,time:t.finder_data_timestamp?t.finder_data_timestamp.toDate():new Date,id:"latest"});try{const o=m(s,"user_data",n,"devices",e,"evidence_logs"),i=g(o,h("timestamp","desc"));(await p(i)).forEach(e=>{const s=e.data();s.photo_url&&s.photo_url!==t.finder_photo_url&&f.push({url:s.photo_url,time:s.timestamp?s.timestamp.toDate():new Date,id:e.id})}),M(),E.photoModal.classList.add("active")}catch(o){console.error("Error loading photo history:",o),a("Error","Could not load history. Showing latest only.","warning"),M(),E.photoModal.classList.add("active")}}function M(){if(f.length>0){const e=f[b];E.photoImg.src=e.url,E.photoImg.classList.remove("hidden"),E.photoPlaceholder.classList.add("hidden"),E.photoTimestamp.textContent=`Captured: ${d(e.time)}`,E.photoIndexIndicator.textContent=`${b+1} / ${f.length}`,E.btnPrevPhoto.disabled=0===b,E.btnNextPhoto.disabled=b===f.length-1,E.btnPrevPhoto.style.opacity=0===b?"0":"1",E.btnNextPhoto.style.opacity=b===f.length-1?"0":"1"}else E.photoImg.classList.add("hidden"),E.photoPlaceholder.classList.remove("hidden"),E.photoTimestamp.textContent="No photos available",E.photoIndexIndicator.textContent="",E.btnPrevPhoto.disabled=!0,E.btnNextPhoto.disabled=!0}function $(e){-1===e&&b>0&&b--,1===e&&b<f.length-1&&b++,M()}async function C(){if(1!==y.size)return;const e=y.values().next().value,t=v.find(t=>t.id===e),n=window.currentUserId;w=[],x=0,t.finder_message&&w.push({text:t.finder_message,time:t.finder_data_timestamp?t.finder_data_timestamp.toDate():new Date,id:"latest"});try{const o=m(s,"user_data",n,"devices",e,"evidence_logs"),i=g(o,h("timestamp","desc"));(await p(i)).forEach(e=>{const s=e.data();if(s.message){const n=s.message;n!==t.finder_message&&w.push({text:n,time:s.timestamp?s.timestamp.toDate():new Date,id:e.id})}}),_(),E.msgModal.classList.add("active")}catch(o){console.error("Error loading messages:",o),_(),E.msgModal.classList.add("active")}}function _(){if(w.length>0){const e=w[x];E.msgText.textContent=`"${e.text}"`,E.msgText.classList.remove("hidden"),E.msgPlaceholder&&E.msgPlaceholder.classList.add("hidden"),E.msgTimestamp.textContent=`Received: ${d(e.time)}`,E.msgIndexIndicator.textContent=`${x+1} / ${w.length}`,E.btnPrevMsg.disabled=0===x,E.btnNextMsg.disabled=x===w.length-1}else E.msgText.classList.add("hidden"),E.msgPlaceholder&&E.msgPlaceholder.classList.remove("hidden"),E.msgTimestamp.textContent="No messages available",E.msgIndexIndicator.textContent=""}function T(e){-1===e&&x>0&&x--,1===e&&x<w.length-1&&x++,_()}!function(e){const t=()=>{window.currentUserId?e(window.currentUserId):requestAnimationFrame(t)};t()}(s=>{!function(){const s=document.getElementById("security-buttons-container");s&&e&&(s.innerHTML=e.map(e=>`\n            <button id="${e.id}" class="action-card ${e.type}" disabled>\n                <i class="bi ${e.icon}"></i>\n                <span>${e.label}</span>\n            </button>\n        `).join(""),E.actionButtons.ring=document.getElementById("action-ring"),E.actionButtons.viewPhotos=document.getElementById("action-view-photos"),E.actionButtons.viewMessages=document.getElementById("action-view-messages"),E.actionButtons.lost=document.getElementById("action-lost"));window.addEventListener("devicesLoaded",e=>{B(e.detail)}),t&&t.userDevices&&t.userDevices.length>0?B(t.userDevices):E.deviceListEmpty&&E.deviceListEmpty.classList.remove("hidden");L(),function(){E.selectAllCheckbox.addEventListener("change",e=>{y.clear(),e.target.checked&&v.forEach(e=>y.add(e.id)),I(),L()}),E.deviceList.addEventListener("change",e=>{if(e.target.matches(".device-checkbox")){const t=e.target.dataset.id;e.target.checked?y.add(t):y.delete(t),L()}}),E.actionButtons.ring&&E.actionButtons.ring.addEventListener("click",()=>P("ring"));E.actionButtons.lost&&E.actionButtons.lost.addEventListener("click",()=>{P(E.actionButtons.lost.dataset.currentAction||"lost")});E.actionButtons.viewPhotos&&E.actionButtons.viewPhotos.addEventListener("click",k);E.actionButtons.viewMessages&&E.actionButtons.viewMessages.addEventListener("click",C);E.btnPrevPhoto&&E.btnPrevPhoto.addEventListener("click",()=>$(-1));E.btnNextPhoto&&E.btnNextPhoto.addEventListener("click",()=>$(1));E.btnPrevMsg&&E.btnPrevMsg.addEventListener("click",()=>T(-1));E.btnNextMsg&&E.btnNextMsg.addEventListener("click",()=>T(1));E.photoCloseBtns.forEach(e=>e?.addEventListener("click",()=>E.photoModal.classList.remove("active"))),E.msgCloseBtns.forEach(e=>e?.addEventListener("click",()=>E.msgModal.classList.remove("active")))}()}()});
