import"./modulepreload-polyfill-YP0FEG5d.js";import{f as t}from"./app-shell-CtSII-jN.js";import{e,s as i,a as n,c as a}from"./shared-utils-DEXrBstL.js";import{collection as r,query as o,orderBy as s,onSnapshot as c,writeBatch as l,doc as d}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";let f=[],m=null;const u={notificationList:document.getElementById("notification-list"),notificationListEmpty:document.getElementById("notification-list-empty"),markAllReadBtn:document.getElementById("mark-all-read-btn"),clearAllBtn:document.getElementById("clear-all-btn"),notificationBadge:document.getElementById("notificationBadge")};function p(t){const e=[],i=new Map;return t.forEach(t=>{const n=y(t),a=`${t.type}|${t.title}|${t.message}`;if(i.has(a)){const t=i.get(a);if(Math.abs(n-t)<1e4)return}i.set(a,n),e.push(t)}),e}function y(t){if(t.timestamp&&"function"==typeof t.timestamp.toMillis)return t.timestamp.toMillis();if(t.time){const e=new Date(t.time);return isNaN(e.getTime())?0:e.getTime()}return 0}!function(t){const e=()=>{window.currentUserId?t(window.currentUserId):requestAnimationFrame(e)};window.currentUserId?t(window.currentUserId):requestAnimationFrame(e)}(g=>{!function(e){u.markAllReadBtn&&u.markAllReadBtn.addEventListener("click",()=>async function(e){const i=f.filter(t=>!1===t.read);if(0===i.length)return void n("Info","No unread notifications.","info");const a=l(t);i.slice(0,500).forEach(i=>{const n=d(t,"user_data",e,"notifications",i.id);a.update(n,{read:!0})});try{await a.commit(),n("Success","Marked all as read.","success")}catch(r){console.error("Batch error:",r),n("Error","Could not mark all as read.","error")}}(e));u.clearAllBtn&&u.clearAllBtn.addEventListener("click",()=>function(e){if(0===f.length)return void n("Info","Notification list is already empty.","info");a("Clear Notifications?","This will permanently delete all your notifications history.","danger",async()=>{const i=l(t);f.slice(0,500).forEach(n=>{const a=d(t,"user_data",e,"notifications",n.id);i.delete(a)});try{await i.commit(),n("Cleared","All notifications deleted.","success")}catch(a){console.error("Batch delete error:",a),n("Error","Failed to clear history.","error")}})}(e));u.notificationList&&u.notificationList.addEventListener("click",i=>{const a=i.target.closest(".btn-mark-read");if(a){!async function(e,i){const a=f.find(t=>t.id===e);if(!a)return;const r=y(a),o=f.filter(t=>{if(t.read)return!1;const e=t.title===a.title&&t.message===a.message&&t.type===a.type,i=y(t),n=Math.abs(i-r)<1e4;return e&&n}),s=l(t);o.forEach(e=>{const n=d(t,"user_data",i,"notifications",e.id);s.update(n,{read:!0})});try{await s.commit()}catch(c){console.error("Error marking read:",c),n("Error","Could not update status.","error")}}(a.dataset.id,e)}})}(g),function(n){m&&m();const a=r(t,"user_data",n,"notifications"),l=o(a,s("timestamp","desc"));m=c(l,t=>{f=t.docs.map(t=>({id:t.id,...t.data()})),function(){if(!u.notificationList)return;const t=p(f);if(u.notificationList.innerHTML="",!t||0===t.length)return void(u.notificationListEmpty&&(u.notificationList.appendChild(u.notificationListEmpty),u.notificationListEmpty.style.display="block",u.notificationListEmpty.classList.remove("hidden")));u.notificationListEmpty&&(u.notificationListEmpty.style.display="none");t.forEach((t,n)=>{const a=document.createElement("div"),r=!1===t.read;a.className="notification-list-item "+(r?"unread":""),a.style.animationDelay=50*n+"ms";const o=function(t){switch(t){case"security":return"bi-shield-lock-fill";case"geofence-enter":return"bi-box-arrow-in-right";case"geofence-exit":return"bi-box-arrow-right";case"low-battery":return"bi-battery-half";case"lost-mode":return"bi-exclamation-diamond-fill";case"success":return"bi-check-circle-fill";case"sim-alert":return"bi-sd-card-fill";case"tracking-start":return"bi-play-circle-fill";case"tracking-stop":return"bi-stop-circle-fill";case"message-received":return"bi-chat-left-text-fill";case"photo-received":return"bi-camera-fill";default:return"bi-bell-fill"}}(t.type),s=function(t){switch(t){case"security":case"lost-mode":case"sim-alert":return"var(--color-danger)";case"tracking-stop":case"low-battery":return"var(--color-warning)";case"geofence-enter":case"geofence-exit":case"info":return"var(--color-info)";case"success":case"tracking-start":case"message-received":case"photo-received":return"var(--color-success)";default:return"var(--color-primary)"}}(t.type);let c=t.timestamp||t.time,l="Just now";if(c)if("function"==typeof c.toDate)l=e(c.toDate());else if(c instanceof Date)l=e(c);else if("string"==typeof c){const t=new Date(c);isNaN(t)||(l=e(t))}a.innerHTML=`\n            ${r?'<div class="unread-dot" title="Unread"></div>':""}\n            <div class="notification-icon-wrapper" style="background-color: ${s}20; color: ${s};">\n                <i class="bi ${o}"></i>\n            </div>\n            <div class="flex-1">\n                <div class="font-semibold text-text-primary dark:text-dark-text-primary">${i(t.title||"Notification")}</div>\n                <div class="text-sm text-text-secondary dark:text-dark-text-secondary mt-1">${i(t.message||"")}</div>\n                <div class="text-xs text-text-secondary dark:text-dark-text-secondary mt-2">${l}</div>\n            </div>\n            ${r?`\n                <button class="btn btn-secondary btn-sm btn-mark-read" data-id="${t.id}" title="Mark as Read">\n                    <i class="bi bi-check-lg"></i>\n                </button>\n            `:""}\n        `,u.notificationList.appendChild(a)})}(),function(){const t=p(f).filter(t=>!1===t.read).length,e=["#notificationBadge","#sidebar-notification-count",".notification-badge",".badge-notification","[data-notification-count]"];document.querySelectorAll(e.join(",")).forEach(e=>{t>0?(e.textContent=t,e.classList.remove("hidden"),e.style.display="",e.classList.add("animate-pulse")):(e.classList.add("hidden"),e.style.display="none",e.classList.remove("animate-pulse"))}),document.title=t>0?`(${t}) Notifications - Trace'N Find`:"Notifications - Trace'N Find"}()},t=>{console.error("Error listening for notifications:",t),u.notificationList&&(u.notificationList.innerHTML='<div class="p-4 text-center text-danger">Error loading notifications.</div>')})}(g)});
