import{initializeApp as e}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import{getAuth as t,onAuthStateChanged as i,signOut as s}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import{getFirestore as o,collection as a,query as n,where as r,onSnapshot as l,doc as c,getDoc as d,orderBy as u,setDoc as m,limit as g,getDocs as p,addDoc as f,serverTimestamp as h}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import{getStorage as y}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";import{a as b,c as w,s as v}from"./shared-utils-DEXrBstL.js";const E=e({apiKey:"AIzaSyAokTU8XIKQcaFv9RBVWMs_8iGEcni6sY4",authDomain:"trace-n--find.firebaseapp.com",projectId:"trace-n--find",storageBucket:"trace-n--find.firebasestorage.app",messagingSenderId:"1000921948484",appId:"1:1000921948484:web:92d821bd2cf4f2e5a67711",measurementId:"G-6BFEZXMG57"}),L=t(E),k=o(E,"tracenfind");y(E);const C=new Audio("/public/assets/audio/kurukuru.mp3");let M=!0;window.librariesLoaded=!1;const I={isAuthenticated:!1,currentUser:null,isSidebarMini:!1,userDevices:[],previousDevices:{},isFirstLoad:!0};let B=null,U=null;const A=[{id:"action-ring",icon:"bi-bell-fill",label:"Sound Alarm",type:"info",textClass:"text-blue-500"},{id:"action-view-photos",icon:"bi-images",label:"View Photos",type:"primary",textClass:"text-indigo-500"},{id:"action-view-messages",icon:"bi-chat-quote-fill",label:"View Messages",type:"success",textClass:"text-green-500"},{id:"action-lost",icon:"bi-exclamation-diamond-fill",label:"Mark as Lost",type:"danger",textClass:"text-red-500"}],T={sidebar:document.getElementById("sidebar"),sidebarToggle:document.getElementById("sidebarToggle"),mainContentArea:document.getElementById("main-content-area"),mobileMenuToggle:document.getElementById("mobileMenuToggle"),appPreloader:document.getElementById("app-preloader"),logoutButton:document.getElementById("logoutButton"),logoutButtonUserMenu:document.getElementById("logoutButtonUserMenu"),userMenuToggle:document.getElementById("userMenuToggle"),userMenu:document.getElementById("userMenu"),userAvatarDisplay:document.querySelectorAll(".user-avatar-display"),userNameDisplay:document.querySelectorAll(".user-name-display"),userEmail:document.getElementById("userEmail"),themeToggle:document.getElementById("themeToggle"),toastContainer:document.getElementById("toastContainer"),confirmationModal:document.getElementById("confirmationModal"),modalClose:document.getElementById("modalClose"),modalTitle:document.getElementById("modalTitle"),modalMessage:document.getElementById("modalMessage"),modalConfirm:document.getElementById("modalConfirm"),modalCancel:document.getElementById("modalCancel"),sidebarDeviceCount:document.getElementById("sidebarDeviceCount"),notificationBadge:document.getElementById("notificationBadge")};let S=!1;function D(e){if(e.timestamp&&"function"==typeof e.timestamp.toMillis)return e.timestamp.toMillis();if(e.time){const t=new Date(e.time);return isNaN(t.getTime())?0:t.getTime()}return 0}function _(e){return new Promise((t,i)=>{const s=document.createElement("script");s.src=e,s.onload=()=>t(),s.onerror=()=>i(new Error(`Failed to load script: ${e}`)),document.head.appendChild(s)})}function j(e){T.userNameDisplay.forEach(t=>t.textContent=e.displayName||"User"),T.userEmail&&(T.userEmail.textContent=e.email||""),T.userAvatarDisplay.forEach(t=>t.src=e.photoURL),$(e.theme||"light")}function x(){T.sidebar?.classList.toggle("sidebar-mini"),T.mainContentArea?.classList.toggle("sidebar-mini"),I.isSidebarMini=!I.isSidebarMini;const e=T.sidebarToggle.querySelector("i");e.classList.toggle("bi-chevron-bar-left"),e.classList.toggle("bi-chevron-bar-right"),setTimeout(()=>window.dispatchEvent(new Event("appResize")),100)}function N(){T.userMenu?.classList.toggle("hidden")}function F(){w("Confirm Logout","Are you sure you want to log out?","danger",()=>{s(L).then(()=>{I.isAuthenticated=!1,I.currentUser=null,localStorage.removeItem("theme"),window.location.href="/public/auth/login.html"}).catch(e=>{b("Error","Logout failed: "+e.message,"error")})})}function $(e){if("light"!==e&&"dark"!==e&&(e="light"),document.documentElement.setAttribute("data-theme",e),document.documentElement.classList.toggle("dark","dark"===e),T.themeToggle){const t=T.themeToggle.querySelector("i");t&&(t.className="dark"===e?"bi bi-sun-fill":"bi bi-moon-fill")}localStorage.setItem("theme",e),window.dispatchEvent(new CustomEvent("themeChanged",{detail:{theme:e}}))}async function P(){const e="dark"===document.documentElement.getAttribute("data-theme")?"light":"dark";if($(e),I.currentUser)try{const t=c(k,"user_data",I.currentUser.uid,"profile","settings");await m(t,{theme:e},{merge:!0})}catch(t){console.warn("Could not save theme to profile:",t)}}function R(){T.appPreloader&&(T.appPreloader.style.opacity="0",setTimeout(()=>{T.appPreloader&&(T.appPreloader.style.display="none")},300))}async function q(e,t,i){const s=v(t.name);let o,r,l,c;switch(i){case"tracking-start":o="Tracking Started",r=`${s} is now online and tracking.`,l="tracking-start",c="success";break;case"tracking-stop":o="Tracking Stopped",r=`${s} has gone offline.`,l="tracking-stop",c="warning";break;case"device-lost":o="Lost Mode Active",r=`${s} is now in Lost Mode.`,l="lost-mode",c="error";break;case"sim-alert":o="SIM Security Alert",r=`Critical: ${t.security.sim_status} detected on ${s}!`,l="sim-alert",c="error";break;case"finder-message":o="New Message from Finder",r=`Message received from ${s}: "${v(t.finder_message)}"`,l="message-received",c="info";break;case"finder-photo":o="New Photo from Finder",r=`A new photo was captured from ${s}.`,l="photo-received",c="info";break;default:return}b(o,r,c);try{const t=a(k,"user_data",e,"notifications"),i=n(t,u("timestamp","desc"),g(3)),s=await p(i);if(s.docs.some(e=>{const t=e.data(),i=(new Date-(t.timestamp?t.timestamp.toDate():new Date))/1e3;return t.title===o&&t.message===r&&i<10}))return;await f(t,{title:o,message:r,type:l,read:!1,timestamp:h()})}catch(d){console.error("Error managing notifications:",d)}}i(L,e=>{S=!0,e?(I.isAuthenticated=!0,I.currentUser={uid:e.uid,displayName:e.displayName||"User",email:e.email,photoURL:e.photoURL||"https://ui-avatars.com/api/?name="+(e.displayName||"User")+"&background=4361ee&color=fff"},window.currentUserId=e.uid,async function(e){const t={fullName:I.currentUser.displayName||"User",email:I.currentUser.email||"",theme:"dark",role:"user",plan:"free",userId:e};try{const i=c(k,"user_data",e,"profile","settings"),s=await d(i);let o={};s.exists()&&(o={...s.data()}),Object.keys(o).length>0?(o.displayName=o.fullName||I.currentUser.displayName,I.currentUser={...I.currentUser,...o},j(I.currentUser)):(console.warn("User profile document not found in Firestore. Using fallback data."),I.currentUser={...I.currentUser,...t},j(I.currentUser),b("Warning","Profile incomplete. Loading defaults.","warning"))}catch(i){console.error("CRITICAL ERROR: Failed to fetch profile data. Check network/rules.",i),I.currentUser={...I.currentUser,...t},j(I.currentUser),b("Error","Profile fetch failed. Loading defaults.","error")}R()}(e.uid),function(e){B&&(B(),B=null);const t=a(k,"user_data",e,"devices"),i=n(t,u("name","asc"));B=l(i,t=>{if(I.userDevices=t.docs.map(e=>({id:e.id,...e.data()})),T.sidebarDeviceCount){const e=I.userDevices.length;T.sidebarDeviceCount.textContent=e,T.sidebarDeviceCount.classList.toggle("hidden",0===e)}window.dispatchEvent(new CustomEvent("devicesLoaded",{detail:I.userDevices})),function(e,t){if(I.isFirstLoad)return t.forEach(e=>{I.previousDevices[e.id]={...e}}),void(I.isFirstLoad=!1);t.forEach(t=>{const i=I.previousDevices[t.id];i?("online"!==i.status&&"online"===t.status&&q(e,t,"tracking-start"),"offline"!==i.status&&"offline"===t.status&&q(e,t,"tracking-stop"),"lost"!==i.status&&"lost"===t.status&&q(e,t,"device-lost"),i.security?.sim_status&&t.security?.sim_status&&i.security.sim_status!==t.security.sim_status&&t.security.sim_status.includes("ðŸš¨")&&q(e,t,"sim-alert"),!t.finder_message||i&&i.finder_message===t.finder_message||q(e,t,"finder-message"),!t.finder_photo_url||i&&i.finder_photo_url===t.finder_photo_url||q(e,t,"finder-photo"),I.previousDevices[t.id]={...t}):I.previousDevices[t.id]={...t}})}(e,I.userDevices)},e=>{console.error("Error listening for user devices:",e)})}(e.uid),function(e){U&&(U(),U=null);const t=a(k,"user_data",e,"notifications"),i=n(t,r("read","==",!1));U=l(i,e=>{const t=e.docs.map(e=>({id:e.id,...e.data()}));t.sort((e,t)=>D(t)-D(e));!function(e){const t=["#notificationBadge","#sidebar-notification-count",".notification-badge",".badge-notification","[data-notification-count]"];document.querySelectorAll(t.join(",")).forEach(t=>{e>0?(t.textContent=e>99?"99+":e,t.classList.remove("hidden"),t.style.display="",t.classList.add("animate-pulse")):(t.classList.add("hidden"),t.style.display="none",t.classList.remove("animate-pulse"))}),document.title=e>0?`(${e}) ${document.title.replace(/^\(\d+\)\s/,"")}`:document.title.replace(/^\(\d+\)\s/,"")}(function(e){const t=[],i=new Map;return e.forEach(e=>{const s=D(e),o=`${e.type}|${e.title}|${e.message}`;if(i.has(o)){const e=i.get(o);if(Math.abs(s-e)<1e4)return}i.set(o,s),t.push(e)}),t}(t).length),M?M=!1:e.docChanges().forEach(e=>{if("added"===e.type)try{C.currentTime=0,C.play().catch(e=>console.warn("Audio autoplay blocked:",e))}catch(t){console.warn("Could not play notification sound",t)}})},e=>{console.error("Error listening for global notifications:",e)})}(e.uid),async function(){const e=window.location.pathname,t=[];(e.includes("/dashboard")||e.includes("/map-view")||e.includes("/geofencing")||e.includes("/location-history")||e.includes("/device-details"))&&("undefined"!=typeof google&&void 0!==google.maps||(console.log("AppShell: Loading Google Maps..."),t.push(_("https://maps.googleapis.com/maps/api/js?key=AIzaSyAz4BSg4UhLy-ulJScq2g5SGCBsIlLx0ZU&libraries=marker,geometry,drawing")),t.push(_("https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"))));(e.includes("/dashboard")||e.includes("/device-details"))&&(console.log("AppShell: Loading Chart.js..."),t.push(_("https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js")));try{await Promise.all(t),console.log("AppShell: All page-specific libraries loaded."),window.librariesLoaded=!0,window.dispatchEvent(new CustomEvent("librariesLoaded"))}catch(i){console.error("AppShell: Failed to load critical libraries.",i),b("Error","Failed to load page resources. Please refresh.","error")}}()):(I.isAuthenticated=!1,I.currentUser=null,B&&(B(),B=null),U&&(U(),U=null),window.location.pathname.startsWith("/app/")?(console.log("Auth state is null on app page. Redirecting to login."),window.location.href="/public/auth/login.html"):R())}),setTimeout(()=>{!S&&window.location.pathname.startsWith("/app/")?(console.warn("Auth initialization timeout. Forcing redirect."),window.location.href="/public/auth/login.html"):S||R()},2500),document.addEventListener("DOMContentLoaded",()=>{$(localStorage.getItem("theme")||"light"),T.sidebarToggle?.addEventListener("click",x),T.mobileMenuToggle?.addEventListener("click",()=>{T.sidebar?.classList.toggle("-translate-x-full"),T.sidebar?.classList.toggle("open")}),T.themeToggle?.addEventListener("click",P),T.logoutButton?.addEventListener("click",F),T.logoutButtonUserMenu?.addEventListener("click",F),T.userMenuToggle?.addEventListener("click",N),document.addEventListener("click",e=>{!T.userMenu||T.userMenu.contains(e.target)||T.userMenuToggle.contains(e.target)||T.userMenu.classList.add("hidden")}),window.addEventListener("resize",()=>{window.dispatchEvent(new Event("appResize"))})});export{A as S,I as a,L as b,k as f};
