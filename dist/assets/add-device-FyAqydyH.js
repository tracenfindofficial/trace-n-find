import"./modulepreload-polyfill-YP0FEG5d.js";import{f as e}from"./app-shell-CtSII-jN.js";import{a as t}from"./shared-utils-DEXrBstL.js";import{collection as r,query as a,where as d,onSnapshot as n,doc as s,getDoc as o,setDoc as i,serverTimestamp as c,addDoc as l}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";let m=!1,p=null;const u={type:null,name:"",model:"",serial:"",os:"Android",features:{tracking:!0,remoteLock:!0,dataWipe:!0}};let v=!1;const g={pageTitle:document.getElementById("page-title"),notificationBadge:document.getElementById("notificationBadge"),step1:document.getElementById("step-1"),stepCards:document.querySelectorAll(".step-card"),deviceTypeError:document.getElementById("device-type-error"),btnNextStep2:document.getElementById("btn-next-step-2"),step2:document.getElementById("step-2"),btnScanQR:document.getElementById("btn-scan-qr"),deviceName:document.getElementById("deviceName"),deviceModel:document.getElementById("deviceModel"),deviceSerial:document.getElementById("deviceSerial"),deviceOS:document.getElementById("deviceOS"),btnBackStep1:document.getElementById("btn-back-step-1"),btnNextStep3:document.getElementById("btn-next-step-3"),step3:document.getElementById("step-3"),enableTracking:document.getElementById("enableTracking"),enableRemoteLock:document.getElementById("enableRemoteLock"),enableDataWipe:document.getElementById("enableDataWipe"),btnBackStep2:document.getElementById("btn-back-step-2"),btnAddDevice:document.getElementById("btn-add-device"),btnAddDeviceText:document.querySelector("#btn-add-device .button-text"),stepDot1:document.getElementById("step-dot-1"),stepDot2:document.getElementById("step-dot-2"),stepDot3:document.getElementById("step-dot-3"),stepName1:document.getElementById("step-name-1"),stepName2:document.getElementById("step-name-2"),stepName3:document.getElementById("step-name-3"),progressBar1:document.getElementById("progress-bar-1"),progressBar2:document.getElementById("progress-bar-2")};function y(e){[g.step1,g.step2,g.step3].forEach(e=>{e&&e.classList.remove("active")});const t=document.getElementById(`step-${e}`);t&&t.classList.add("active");const r=[g.stepDot1,g.stepDot2,g.stepDot3],a=[g.stepName1,g.stepName2,g.stepName3],d=[g.progressBar1,g.progressBar2];r.forEach((t,r)=>{if(!t)return;const a=r+1;t.classList.remove("active","complete"),a<e?(t.classList.add("complete"),t.innerHTML='<i class="bi bi-check-lg"></i>'):a===e?(t.classList.add("active"),t.textContent=a):t.textContent=a}),a.forEach((t,r)=>{if(!t)return;const a=r+1;t.classList.remove("text-primary-600","dark:text-primary-400","text-text-secondary","dark:text-dark-text-secondary","font-semibold"),a===e?t.classList.add("text-primary-600","dark:text-primary-400","font-semibold"):t.classList.add("text-text-secondary","dark:text-dark-text-secondary")}),d.forEach((t,r)=>{if(!t)return;const a=r+1;t.style.width=a<e?"100%":"0%"})}function b(){g.btnNextStep2.disabled=!u.type}async function f(a){if(a.preventDefault(),v||!window.currentUserId)return;u.features.tracking=g.enableTracking.checked,u.features.remoteLock=g.enableRemoteLock.checked,u.features.dataWipe=g.enableDataWipe.checked,E(!0);const d={type:u.type,name:u.name,model:u.model,serial:u.serial||"",os:u.os,features:u.features};try{let a,n;if(m)a=s(e,"user_data",window.currentUserId,"devices",p),await i(a,d,{merge:!0}),n=`${u.name} has been updated.`;else{d.status="online",d.battery=100,d.location=null,d.createdAt=c(),d.lastSeen=c();const t=r(e,"user_data",window.currentUserId,"devices");a=await l(t,d),n=`${u.name} is now protected.`}console.log("Document written/updated with ID: ",a.id),t("Success!",n,"success"),setTimeout(()=>{window.location.href="/app/devices.html"},1500)}catch(n){console.error("Error writing document: ",n),t("Error",`Could not ${m?"update":"add"} device. Please try again.`,"error"),E(!1)}}function E(e){v=e;const t=g.btnAddDevice;if(!t)return;const r=t.querySelector(".button-text"),a=t.querySelector(".button-spinner");e?(t.disabled=!0,r&&r.classList.add("hidden"),a&&a.classList.remove("hidden")):(t.disabled=!1,r&&r.classList.remove("hidden"),a&&a.classList.add("hidden"))}!function(e){const t=()=>{window.currentUserId?e():(console.log("Add-device logic waiting for authentication..."),requestAnimationFrame(t))};window.currentUserId?e():requestAnimationFrame(t)}(function(){if(!window.currentUserId)return void console.error("User not authenticated. Add-device logic cannot run.");!function(t){const s=r(e,"user_data",t,"notifications"),o=a(s,d("read","==",!1));n(o,e=>{!function(e){const t=g.notificationBadge;if(!t)return;e>0?(t.textContent=e>99?"99+":e,t.classList.remove("hidden"),t.classList.add("animate-pulse")):(t.classList.add("hidden"),t.classList.remove("animate-pulse"))}(e.size)},e=>{console.error("Error listening for unread count:",e)})}(window.currentUserId);const i=new URLSearchParams(window.location.search);m="true"===i.get("edit"),p=i.get("id"),m&&p?async function(r,a){g.pageTitle&&(g.pageTitle.textContent="Edit Device");g.btnAddDeviceText&&(g.btnAddDeviceText.innerHTML='<i class="bi bi-save-fill mr-2"></i> Save Changes');try{const d=s(e,"user_data",r,"devices",a),n=await o(d);if(n.exists()){const e=n.data();u.type=e.type,u.name=e.name,u.model=e.model,u.serial=e.serial,u.os=e.os,u.features=e.features||{tracking:!0,remoteLock:!0,dataWipe:!0},g.stepCards.forEach(t=>{t.dataset.type===e.type&&t.classList.add("selected","border-primary-600","dark:border-primary-500","bg-primary-50","dark:bg-primary-900/30")}),g.deviceName.value=e.name,g.deviceModel.value=e.model,g.deviceSerial.value=e.serial,g.deviceOS.value=e.os,g.enableTracking.checked=u.features.tracking,g.enableRemoteLock.checked=u.features.remoteLock,g.enableDataWipe.checked=u.features.dataWipe,b()}else console.error("No such device found!"),t("Error","Device not found. Redirecting...","error"),setTimeout(()=>window.location.href="/app/devices.html",2e3)}catch(d){console.error("Error loading device for edit:",d),t("Error","Could not load device data.","error")}}(window.currentUserId,p):b(),g.stepCards.forEach(e=>{e.addEventListener("click",()=>{g.stepCards.forEach(e=>e.classList.remove("selected","border-primary-600","dark:border-primary-500","bg-primary-50","dark:bg-primary-900/30")),e.classList.add("selected","border-primary-600","dark:border-primary-500","bg-primary-50","dark:bg-primary-900/30"),u.type=e.dataset.type,g.deviceTypeError.classList.add("hidden"),b(),function(){if(m)return;const e=u.type.toLowerCase();g.deviceOS.value="phone"===e||"tablet"===e||"watch"===e?"Android":"laptop"===e?"Windows":"Other"}()})}),g.btnNextStep2.addEventListener("click",()=>{(u.type?(g.deviceTypeError.classList.add("hidden"),1):(g.deviceTypeError.classList.remove("hidden"),0))&&y(2)}),g.btnScanQR.addEventListener("click",()=>{t("Demo Feature","QR Scanner would open here.","info"),g.deviceName.value="Demo Phone",g.deviceModel.value="Pixel 8 Pro (Demo)",g.deviceSerial.value="DEMO-123456"}),g.btnBackStep1.addEventListener("click",()=>y(1)),g.btnNextStep3.addEventListener("click",()=>{(function(){let e=!0;return u.name=g.deviceName.value,u.model=g.deviceModel.value,u.serial=g.deviceSerial.value,u.os=g.deviceOS.value,u.name.trim().length<3?(t("Invalid Name","Device name must be at least 3 characters.","error"),g.deviceName.focus(),e=!1):0===u.model.trim().length&&(t("Invalid Model","Device model is required.","error"),g.deviceModel.focus(),e=!1),e})()&&y(3)}),g.btnBackStep2.addEventListener("click",()=>y(2)),document.getElementById("addDeviceForm").addEventListener("submit",f)});
