import"./modulepreload-polyfill-YP0FEG5d.js";import"./app-shell-CtSII-jN.js";import{getAuth as e,onAuthStateChanged as t,multiFactor as a,updateProfile as i,sendEmailVerification as n,RecaptchaVerifier as r,PhoneAuthProvider as o,PhoneMultiFactorGenerator as s,signOut as l}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import{getFirestore as c,doc as d,getDoc as u,setDoc as p,serverTimestamp as f}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import{getStorage as m,ref as h,uploadBytes as g,getDownloadURL as y}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";import{initializeApp as b}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"./shared-utils-DEXrBstL.js";const w=b({apiKey:"AIzaSyAokTU8XIKQcaFv9RBVWMs_8iGEcni6sY4",authDomain:"trace-n--find.firebaseapp.com",projectId:"trace-n--find",storageBucket:"trace-n--find.firebasestorage.app",messagingSenderId:"1000921948484",appId:"1:1000921948484:web:92d821bd2cf4f2e5a67711",measurementId:"G-6BFEZXMG57"}),I=e(w),v=c(w,"tracenfind"),E=m(w),B=async e=>{if("undefined"==typeof grecaptcha||void 0===grecaptcha.enterprise)return console.warn("reCAPTCHA Enterprise not loaded. Skipping bot check."),null;try{return await grecaptcha.enterprise.execute("6LdnxQcsAAAAAOQl5jTa-VhC4aek_xTzDqSTp6zI",{action:e})}catch(t){return console.warn("reCAPTCHA execution failed (Action: "+e+"):",t),null}};let M={},A=null;const L=()=>{M={profileForm:document.getElementById("profile-form"),displayNameInput:document.getElementById("profile-name"),emailInput:document.getElementById("profile-email"),phoneInput:document.getElementById("profile-phone"),bioInput:document.getElementById("profile-bio"),profileImage:document.getElementById("profile-avatar-img"),profileUpload:document.getElementById("profileUpload"),saveBtn:document.getElementById("save-profile-btn"),verifyEmailBtn:document.getElementById("verify-email-btn"),emailVerifiedBadge:document.getElementById("email-verified-badge"),emailUnverifiedBadge:document.getElementById("email-unverified-badge"),enableMfaBtn:document.getElementById("enable-mfa-btn"),disableMfaBtn:document.getElementById("disable-mfa-btn"),otpModal:document.getElementById("otpModal"),otpModalClose:document.getElementById("otpModalClose"),otpModalCancel:document.getElementById("otpModalCancel"),otpModalVerify:document.getElementById("otpModalVerify"),otpInput:document.getElementById("otpInput"),recaptchaContainer:document.getElementById("recaptcha-container-profile")},t(I,async e=>{e?(A=e,await C(e),M.profileForm&&M.profileForm.addEventListener("submit",x),M.profileUpload&&M.profileUpload.addEventListener("change",T),M.verifyEmailBtn&&M.verifyEmailBtn.addEventListener("click",S),M.enableMfaBtn&&M.enableMfaBtn.addEventListener("click",k),M.disableMfaBtn&&M.disableMfaBtn.addEventListener("click",V),M.otpModalClose&&M.otpModalClose.addEventListener("click",F),M.otpModalCancel&&M.otpModalCancel.addEventListener("click",F)):window.location.replace("/public/auth/login.html")})};async function C(e){try{M.displayNameInput&&(M.displayNameInput.value=e.displayName||""),M.emailInput&&(M.emailInput.value=e.email||""),e.photoURL&&M.profileImage&&(M.profileImage.src=e.photoURL),function(e){if(!M.emailVerifiedBadge)return;e?(M.emailVerifiedBadge.classList.remove("hidden"),M.emailUnverifiedBadge&&M.emailUnverifiedBadge.classList.add("hidden"),M.verifyEmailBtn&&M.verifyEmailBtn.classList.add("hidden")):(M.emailVerifiedBadge.classList.add("hidden"),M.emailUnverifiedBadge&&M.emailUnverifiedBadge.classList.remove("hidden"),M.verifyEmailBtn&&M.verifyEmailBtn.classList.remove("hidden"))}(e.emailVerified);const t=a(e).enrolledFactors.length>0;t?(M.enableMfaBtn&&(M.enableMfaBtn.innerHTML='<i class="bi bi-shield-check text-lg"></i> <span>Two-Factor Authentication is Active</span>',M.enableMfaBtn.className="w-full bg-emerald-500/10 text-emerald-500 border border-emerald-500/20 cursor-default font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-2",M.enableMfaBtn.disabled=!0),M.disableMfaBtn&&M.disableMfaBtn.classList.remove("hidden")):(M.enableMfaBtn&&(M.enableMfaBtn.innerHTML='<i class="bi bi-shield-lock-fill"></i> <span>Enable 2FA</span>',M.enableMfaBtn.className="w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-3 px-4 rounded-xl transition-all duration-300 flex items-center justify-center gap-2 shadow-lg shadow-primary-600/20",M.enableMfaBtn.disabled=!1),M.disableMfaBtn&&M.disableMfaBtn.classList.add("hidden"));const i=d(v,"user_data",e.uid,"profile","settings"),n=await u(i);if(n.exists()){const e=n.data();M.phoneInput&&(M.phoneInput.value=e.phone||""),M.bioInput&&(M.bioInput.value=e.bio||""),e.mfa_enabled&&!t&&await p(i,{mfa_enabled:!1},{merge:!0})}}catch(t){console.error("Error loading profile:",t)}}function F(){M.otpModal.classList.remove("active"),M.otpModalVerify.onclick=null}async function S(e){if(e.preventDefault(),!A)return;const t=M.verifyEmailBtn,a=t.textContent;t.disabled=!0,t.textContent="Sending...";try{await B("VERIFY_EMAIL"),await n(A),P("Success","Verification email sent!","success"),t.textContent="Sent!"}catch(i){console.error("Verification Email Error:",i),"auth/too-many-requests"===i.code?P("Warning","Too many requests. Try again later.","warning"):P("Error","Failed to send email.","error"),t.textContent=a,t.disabled=!1}}async function T(e){const t=e.target.files[0];if(!t)return;if(!t.type.startsWith("image/"))return void P("Error","Please select an image.","error");const a=new FileReader;a.onload=e=>{M.profileImage&&(M.profileImage.src=e.target.result)},a.readAsDataURL(t);try{P("Info","Uploading...","info");const e=h(E,`users/${A.uid}/profile_${Date.now()}.jpg`),a=await g(e,t),n=await y(a.ref);await i(A,{photoURL:n});const r=d(v,"user_data",A.uid,"profile","settings");await p(r,{photoURL:n,updatedAt:f()},{merge:!0}),P("Success","Profile picture updated!","success")}catch(n){console.error("Image Upload Error:",n),P("Error","Failed to upload.","error")}}async function x(e){if(e.preventDefault(),!A)return;U(!0);const t=M.displayNameInput?M.displayNameInput.value.trim():"",a=M.phoneInput?M.phoneInput.value.trim():"",n=M.bioInput?M.bioInput.value.trim():"";try{await B("UPDATE_PROFILE");const e=[];t&&t!==A.displayName&&e.push(i(A,{displayName:t}));const r=d(v,"user_data",A.uid,"profile","settings");e.push(p(r,{fullName:t,phone:a,bio:n,updatedAt:f()},{merge:!0})),await Promise.all(e),P("Success","Profile updated!","success")}catch(r){console.error("Save Profile Error:",r),P("Error","Failed to save: "+r.message,"error")}finally{U(!1)}}async function k(){if(!A)return;const e=M.phoneInput?M.phoneInput.value.trim():"";if(!e)return P("Error","Please enter your phone number first.","error"),void(M.phoneInput&&M.phoneInput.focus());try{if(window.recaptchaVerifier){try{window.recaptchaVerifier.clear()}catch(i){console.log("Verifier clear warning",i)}window.recaptchaVerifier=null}if(!document.getElementById("recaptcha-container-profile"))return console.error("CRITICAL: #recaptcha-container-profile missing in HTML."),void P("System Error","MFA setup container missing. Refresh page.","error");window.recaptchaVerifier=new r(I,"recaptcha-container-profile",{size:"invisible",callback:e=>{console.log("MFA reCAPTCHA Solved")},"expired-callback":()=>{P("Warning","Security check expired. Try again.","warning")}}),P("Info","Preparing security session...","info");const l=await a(A).getSession();P("Info","Sending verification code...","info");const c={phoneNumber:e,session:l};let u;try{u=await new o(I).verifyPhoneNumber(c,window.recaptchaVerifier)}catch(n){if(n.message&&n.message.includes("Invalid site key"))throw console.error("CRITICAL SITE KEY ERROR: The key loaded in HTML (script tag) does not match the key Firebase expects."),new Error("Configuration Error: reCAPTCHA Site Key mismatch. Please clear browser cache or check Firebase Console settings.");throw n}t=async e=>{try{const t=o.credential(u,e),n=s.assertion(t);await a(A).enroll(n,"My Phone Number");try{const e=d(v,"user_data",A.uid,"profile","settings");await p(e,{mfa_enabled:!0},{merge:!0})}catch(i){}P("Success","MFA Enabled Successfully!","success"),F(),await A.reload(),C(A)}catch(t){P("Error","Invalid code: "+t.message,"error")}},M.otpInput.value="",M.otpModal.classList.add("active"),setTimeout(()=>M.otpInput.focus(),100),M.otpModalVerify.onclick=()=>{const e=M.otpInput.value.trim();e?t(e):P("Error","Please enter the code.","error")}}catch(c){if(console.error("MFA Enrollment Error:",c),window.recaptchaVerifier){try{window.recaptchaVerifier.clear()}catch(i){}window.recaptchaVerifier=null}let e=c.message;if("auth/captcha-check-failed"===c.code)e="Security check failed. Please refresh.";else if("auth/invalid-phone-number"===c.code)e="Invalid phone number format. Use +60...";else if("auth/quota-exceeded"===c.code)e="SMS quota exceeded for this project.";else if(c.message.includes("400"))e="System blocked the request. If testing, ensure you are using a Test Number defined in Firebase Console.";else if("auth/requires-recent-login"===c.code)return P("Security Requirement","For security, you must re-login to enable 2FA. Redirecting...","warning"),void setTimeout(async()=>{await l(I),window.location.replace("/public/auth/login.html")},2500);P("Error","MFA Failed: "+e,"error")}var t}async function V(){if(A&&confirm("Are you sure you want to disable 2FA? This reduces account security."))try{const e=a(A).enrolledFactors;if(0===e.length)return;const t=e[0].uid;P("Info","Disabling 2FA...","info"),await a(A).unenroll(t);const i=d(v,"user_data",A.uid,"profile","settings");await p(i,{mfa_enabled:!1},{merge:!0}),P("Success","2FA has been disabled.","success"),await A.reload(),C(A)}catch(e){console.error("Disable MFA Error:",e),P("Error","Failed to disable 2FA.","error")}}function U(e){const t=M.saveBtn;if(!t)return;const a=t.querySelector(".button-spinner"),i=t.querySelector(".button-text");e?(t.disabled=!0,a&&a.classList.remove("hidden"),i&&(i.textContent="Saving...")):(t.disabled=!1,a&&a.classList.add("hidden"),i&&(i.textContent="Save Changes"))}function P(e,t,a="info"){if("function"==typeof window.showToast)window.showToast(e,t,a);else{const i=document.getElementById("toastContainer");if(i){const n=document.createElement("div");n.className=`toast toast-${a} show`,n.innerHTML=`<div><b>${e}</b><br>${t}</div>`,i.appendChild(n),setTimeout(()=>n.remove(),3e3)}else alert(`${e}: ${t}`)}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",L):L();
