import"./modulepreload-polyfill-YP0FEG5d.js";import{f as t}from"./app-shell-CtSII-jN.js";import{m as e}from"./map-tiles-D1fw3GxV.js";import{a as n,g as i,d as a,e as s,s as o,i as r}from"./shared-utils-DEXrBstL.js";import{collection as c,query as d,where as l,onSnapshot as m,doc as u,orderBy as g,limit as p}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";let f=null,x=null,y=null,v=null,b=null;const h={loader:document.getElementById("skeleton-loader"),content:document.getElementById("device-content"),notificationBadge:document.getElementById("notificationBadge"),headerName:document.getElementById("header-device-name"),deviceName:document.getElementById("device-name"),deviceIcon:document.getElementById("device-icon"),deviceModel:document.getElementById("device-model"),deviceStatus:document.getElementById("device-status-badge"),deviceLastSeen:document.getElementById("device-last-seen"),liveIndicator:document.getElementById("live-indicator"),statBattery:document.getElementById("battery-level-text"),statStorage:document.getElementById("storage-text"),statNetwork:document.getElementById("network-type-text"),statSignal:document.getElementById("signal-strength-text"),mapContainer:document.getElementById("map"),activityList:document.getElementById("activity-timeline"),infoOS:document.getElementById("device-os"),infoCarrierStatus:document.getElementById("device-carrier-status"),infoIP:document.getElementById("device-ip"),infoCarrier:document.getElementById("device-carrier"),infoMAC:document.getElementById("device-mac"),batteryChart:document.getElementById("battery-chart"),networkChart:document.getElementById("network-chart"),storageChart:document.getElementById("storage-chart"),signalChart:document.getElementById("signal-chart")};function w(t){if(t.timestamp&&"function"==typeof t.timestamp.toMillis)return t.timestamp.toMillis();if(t.time){const e=new Date(t.time);return isNaN(e.getTime())?0:e.getTime()}return 0}function k(t){h.activityList&&(h.activityList.innerHTML="",t&&0!==t.length?t.forEach(t=>{const e=document.createElement("div");e.className="flex gap-4 p-4 rounded-xl hover:bg-bg-primary dark:hover:bg-dark-bg-primary transition-colors border border-transparent hover:border-border-color dark:hover:border-dark-border-color animation-fade-in";let n="bi-info-circle-fill",i="bg-primary-100 text-primary-600 dark:bg-primary-900/30 dark:text-primary-400";const a=(t.type||"info").toLowerCase();a.includes("security")||a.includes("alert")||a.includes("danger")?(n="bi-shield-exclamation",i="bg-danger-100 text-danger-600 dark:bg-danger-900/30 dark:text-danger-400"):a.includes("warning")||a.includes("battery")?(n="bi-exclamation-triangle-fill",i="bg-warning-100 text-warning-700 dark:bg-warning-900/30 dark:text-warning-400"):a.includes("lost")||a.includes("location")?(n="bi-geo-alt-fill",i="bg-info-100 text-info-600 dark:bg-info-900/30 dark:text-info-400"):(a.includes("success")||a.includes("found"))&&(n="bi-check-circle-fill",i="bg-success-100 text-success-600 dark:bg-success-900/30 dark:text-success-400");let r=t.timestamp||t.time,c="Just now";if(r)if("function"==typeof r.toDate)c=s(r.toDate());else if(r instanceof Date)c=s(r);else if("string"==typeof r){const t=new Date(r);isNaN(t)||(c=s(t))}else"number"==typeof r&&(c=s(new Date(r)));e.innerHTML=`\n            <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ${i}">\n                <i class="bi ${n} text-lg"></i>\n            </div>\n            <div class="flex-1 min-w-0">\n                <p class="font-semibold text-sm text-text-primary dark:text-dark-text-primary truncate">\n                    ${o(t.title||"Notification")}\n                </p>\n                <p class="text-sm text-text-secondary dark:text-dark-text-secondary line-clamp-2">\n                    ${o(t.message||t.body||"No details provided.")}\n                </p>\n                <p class="text-xs text-text-secondary dark:text-dark-text-secondary mt-1 opacity-70">\n                    <i class="bi bi-clock"></i> ${c}\n                </p>\n            </div>\n        `,h.activityList.appendChild(e)}):h.activityList.innerHTML='\n            <div id="activity-empty" class="text-center p-6 animation-fade-in">\n                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary-50 dark:bg-primary-900/20 mb-4">\n                    <i class="bi bi-clock-history text-3xl text-text-secondary dark:text-dark-text-secondary opacity-70"></i>\n                </div>\n                <h3 class="text-base font-medium text-text-primary dark:text-dark-text-primary">No recent activity</h3>\n                <p class="mt-1 text-sm text-text-secondary dark:text-dark-text-secondary">Notifications for this device will appear here.</p>\n            </div>\n        ')}!function(t){const n=()=>{window.currentUserId&&window.librariesLoaded&&"undefined"!=typeof google&&e?t(window.currentUserId):requestAnimationFrame(n)};n()}(C=>{const I=new URLSearchParams(window.location.search);f=I.get("id"),f?(console.log(`Initializing details for device: ${f}`),function(l,f){(function(){if(!h.mapContainer)return;const t="dark"===document.documentElement.getAttribute("data-theme")?e.dark:e.light,n={lat:2.9436,lng:101.7949};y=new google.maps.Map(h.mapContainer,{center:n,zoom:13,disableDefaultUI:!0,zoomControl:!0,styles:t,mapTypeId:"roadmap"}),new google.maps.LatLngBounds,b=new google.maps.InfoWindow,window.addEventListener("themeChanged",t=>{if(y&&e){const n="dark"===t.detail.theme?e.dark:e.light;y.setOptions({styles:n})}})})(),function(e,c){const d=u(t,"user_data",e,"devices",c);m(d,t=>{t.exists()?(x={id:t.id,...t.data()},function(t){const e=t.info||{},n=t.sim||{},c=t.security||{};t.location;const d=t.name||t.model||"Unknown Device";h.headerName.textContent=d,h.deviceName.textContent=d,h.deviceModel.textContent=t.model||e.model||"Unknown Model";const l=i(t.status);h.deviceIcon.style.backgroundColor=`${l}20`,h.deviceIcon.style.color=l,h.deviceIcon.innerHTML=`<i class="bi ${a(t.type||e.type)}"></i>`,h.deviceStatus.textContent=t.status||"Offline",h.deviceStatus.style.borderColor=l,h.deviceStatus.style.color=l,h.deviceStatus.className=`text-sm font-semibold uppercase px-3 py-1 rounded-full border border-current bg-[${l}10]`;const m=s(t.lastSeen||t.last_updated);h.deviceLastSeen.textContent=m;const u="online"===t.status||"active"===t.status,g=m.includes("Just now")||m.includes("sec")||m.includes("min")&&parseInt(m)<5;u&&g&&h.liveIndicator?(h.liveIndicator.classList.remove("hidden"),h.liveIndicator.classList.add("flex")):h.liveIndicator&&(h.liveIndicator.classList.add("hidden"),h.liveIndicator.classList.remove("flex"));const p=t.battery??t.battery_level??0;h.statBattery.textContent=`${p}%`,h.statBattery.className=p<20?"font-bold text-xl text-danger-500":p<50?"font-bold text-xl text-warning-500":"font-bold text-xl text-success-500";h.statStorage.textContent=t.storage||"N/A",h.statNetwork.textContent=t.network_display||t.network||"N/A";const f=t.signal_strength??t.signal??t.signal_level;if(null!=f){const t=String(f).replace(/\s?dBm/gi,"").trim();h.statSignal.textContent=`${t} dBm`}else h.statSignal.textContent="N/A";h.infoOS.textContent=t.os_version||t.os||e.os||"N/A",h.infoIP.textContent=t.ip_address||t.ip||e.ip||"N/A",h.infoMAC&&(h.infoMAC.textContent=t.mac_address||t.mac||e.mac||"N/A");const x=n.carrier||t.carrier||"Unknown Carrier";h.infoCarrier.textContent=x;const w=t.sim_status||c.sim_status||n.status||"Unknown";h.infoCarrierStatus.textContent=w,h.infoCarrierStatus.className="font-medium";const k=String(w).toLowerCase();["active","online","ready","inserted"].includes(k)?h.infoCarrierStatus.classList.add("text-success-500"):["inactive","blocked","missing","removed","absent","ejected"].includes(k)&&h.infoCarrierStatus.classList.add("text-danger-500");h.loader&&(h.loader.style.display="none");h.content&&(h.content.classList.remove("hidden"),h.content.classList.add("animate-fade-in"));!function(t){if(!y)return;let e,n;t.location&&(void 0!==t.location.lat?e=parseFloat(t.location.lat):void 0!==t.location.latitude&&(e=parseFloat(t.location.latitude)),void 0!==t.location.lng?n=parseFloat(t.location.lng):void 0!==t.location.longitude&&(n=parseFloat(t.location.longitude)));if("number"!=typeof e||isNaN(e)||"number"!=typeof n||isNaN(n))return;const i={lat:e,lng:n},a={online:"#10b981",found:"#10b981",active:"#10b981",offline:"#64748b",inactive:"#64748b",warning:"#f59e0b",lost:"#ef4444",stolen:"#ef4444"}[t.status?.toLowerCase()]||"#4361ee",c=`\n        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 80 80">\n            ${"online"===t.status||"active"===t.status||"lost"===t.status?`\n            <circle cx="40" cy="40" r="18" fill="${a}" fill-opacity="0.3">\n                <animate attributeName="r" from="18" to="40" dur="1.5s" repeatCount="indefinite" />\n                <animate attributeName="opacity" from="0.6" to="0" dur="1.5s" repeatCount="indefinite" />\n            </circle>\n            `:""}\n            <circle cx="40" cy="40" r="18" fill="${a}" stroke="white" stroke-width="3" />\n            \x3c!-- Smartphone Icon Center --\x3e\n            <g transform="translate(28, 28) scale(0.9)">\n                 <path fill="white" d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/>\n            </g>\n        </svg>`,d={url:"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(c),scaledSize:new google.maps.Size(48,48),anchor:new google.maps.Point(24,24)};if(v){if(v.setIcon(d),r(v,i),b.getMap()){const e=`\n                <div class="text-gray-800 p-1">\n                    <h3 class="font-bold text-sm">${o(t.name)}</h3>\n                    <p class="text-xs mt-1">Status: <span style="color:${a}" class="font-semibold uppercase">${t.status}</span></p>\n                    <p class="text-xs text-gray-500 mt-1">Last seen: ${s(t.lastSeen||t.last_updated)}</p>\n                </div>\n            `;b.setContent(e)}}else v=new google.maps.Marker({position:i,map:y,title:t.name,icon:d,optimized:!1}),y.panTo(i),v.addListener("click",()=>{const e=`\n                <div class="text-gray-800 p-1">\n                    <h3 class="font-bold text-sm">${o(t.name)}</h3>\n                    <p class="text-xs mt-1">Status: <span style="color:${a}" class="font-semibold uppercase">${t.status}</span></p>\n                    <p class="text-xs text-gray-500 mt-1">Last seen: ${s(t.lastSeen||t.last_updated)}</p>\n                </div>\n            `;b.setContent(e),b.open(y,v)})}(t)}(x)):(n("Error","Device not found.","error"),setTimeout(()=>window.location.href="/app/devices.html",2e3))})}(l,f),function(e,n){const i=c(t,"user_data",e,"notifications"),a=d(i,g("timestamp","desc"),p(50));m(a,t=>{const e=t.docs.map(t=>({id:t.id,...t.data()})).filter(t=>{const e=t.deviceId||t.device_id;return e&&String(e)===String(n)});e.sort((t,e)=>w(e)-w(t)),k(e)},t=>{console.warn("Error listening for activity:",t),k([])})}(l,f)}(C,f),function(e){const n=c(t,"user_data",e,"notifications"),i=d(n,l("read","==",!1));m(i,t=>{const e=t.docs.map(t=>({id:t.id,...t.data()}));e.sort((t,e)=>w(e)-w(t));!function(t){const e=h.notificationBadge;if(!e)return;t>0?(e.textContent=t>99?"99+":t,e.classList.remove("hidden"),e.classList.add("animate-pulse"),document.title=`(${t}) ${h.deviceName.textContent} - Trace'N Find`):(e.classList.add("hidden"),e.classList.remove("animate-pulse"),document.title=`${h.deviceName.textContent||"Device Details"} - Trace'N Find`)}(function(t){const e=[],n=new Map;return t.forEach(t=>{const i=w(t),a=`${t.type}|${t.title}|${t.message}`;if(n.has(a)){const t=n.get(a);if(Math.abs(i-t)<1e4)return}n.set(a,i),e.push(t)}),e}(e).length)},t=>{console.error("Error listening for unread count:",t)})}(C)):window.location.href="/app/devices.html"});
