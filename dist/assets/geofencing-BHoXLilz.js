import"./modulepreload-polyfill-YP0FEG5d.js";import{f as e}from"./app-shell-CtSII-jN.js";import{m as t}from"./map-tiles-D1fw3GxV.js";import{a as n,s as o,e as a,h as i,g as s,c as l}from"./shared-utils-DEXrBstL.js";import{collection as r,query as d,orderBy as c,onSnapshot as m,addDoc as g,serverTimestamp as f,doc as u,setDoc as p,deleteDoc as h}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";let y=null,v=[],b={},w={},L=[],E={},x=new Map,k=null,C=!1,$=null,A=null,B=null;const I={mapContainer:document.getElementById("map"),mapClickPrompt:document.getElementById("map-click-prompt"),geofenceList:document.getElementById("geofence-list"),geofenceListEmpty:document.getElementById("geofence-list-empty"),addGeofenceBtn:document.getElementById("add-geofence-btn"),formPanel:document.getElementById("geofence-form-panel"),panelTitle:document.getElementById("geofence-panel-title"),modalCancelBtn:document.getElementById("geofence-modal-cancel"),modalSaveBtn:document.getElementById("geofence-modal-save"),modalSpinner:document.querySelector("#geofence-modal-save .button-spinner"),modalSaveText:document.querySelector("#geofence-modal-save .button-text"),form:document.getElementById("geofence-form"),formLat:document.getElementById("geofence-lat"),formLng:document.getElementById("geofence-lng"),formName:document.getElementById("geofence-name"),formAddress:document.getElementById("geofence-address"),formRadius:document.getElementById("geofence-radius"),formAlertEntry:document.getElementById("alert-entry"),formAlertExit:document.getElementById("alert-exit")};function S(){y&&google.maps.geometry&&0!==L.length&&0!==v.length&&L.forEach(e=>{if(!e.location)return;let t=e.location.lat??e.location.latitude,n=e.location.lng??e.location.longitude;if(void 0===t||void 0===n)return;const o=new google.maps.LatLng(parseFloat(t),parseFloat(n));x.has(e.id)||x.set(e.id,new Map);const a=x.get(e.id);v.forEach(t=>{const n=new google.maps.LatLng(t.lat,t.lng),i=google.maps.geometry.spherical.computeDistanceBetween(o,n)<=t.radius?"inside":"outside",s=a.get(t.id);s?i!==s&&(a.set(t.id,i),"outside"===i&&t.alertOnExit?M("Geofence Alert",`${e.name} has left the safe zone: ${t.name}`,"geofence-exit",e.id):"inside"===i&&t.alertOnEntry&&M("Geofence Entry",`${e.name} has arrived at: ${t.name}`,"geofence-enter",e.id)):a.set(t.id,i)})})}async function M(t,o,a,i){const s=window.currentUserId;if(s)try{const l=r(e,"user_data",s,"notifications");if(await g(l,{title:t,message:o,type:a,read:!1,timestamp:f()}),i){const t=r(e,"user_data",s,"devices",i,"activity");await g(t,{type:"geofence-exit"===a?"warning":"info",message:o,timestamp:f()})}n(t,o,"geofence-exit"===a?"warning":"success")}catch(l){console.error("Error creating geofence notification:",l)}}function G(e){if(I.formPanel.classList.contains("hidden"))return;const t=e.latLng.lat(),n=e.latLng.lng();I.formLat.value=t,I.formLng.value=n,I.formAddress.value=`Coords: ${t.toFixed(5)}, ${n.toFixed(5)}`,B?B.setPosition(e.latLng):(B=new google.maps.Marker({position:e.latLng,map:y,draggable:!0,title:"New Geofence Location"}),B.addListener("dragend",e=>{const t=e.latLng.lat(),n=e.latLng.lng();I.formLat.value=t,I.formLng.value=n,I.formAddress.value=`Coords: ${t.toFixed(5)}, ${n.toFixed(5)}`})),I.formAddress.style.transition="none",I.formAddress.style.backgroundColor="rgba(var(--color-primary-rgb), 0.2)",setTimeout(()=>{I.formAddress.style.transition="background-color 0.5s ease",I.formAddress.style.backgroundColor=""},100)}function T(e){if(I.form.reset(),I.mapClickPrompt.classList.remove("hidden"),I.geofenceList.classList.add("hidden"),I.geofenceListEmpty.style.display="none",I.addGeofenceBtn.classList.add("hidden"),I.formPanel.classList.remove("hidden"),e){C=!0,k=e.id,I.panelTitle.textContent="Edit Geofence",I.modalSaveText.textContent="Save Changes",I.formName.value=e.name,I.formAddress.value=e.address||`Coords: ${e.lat}, ${e.lng}`,I.formLat.value=e.lat,I.formLng.value=e.lng,I.formRadius.value=e.radius,I.formAlertEntry.checked=e.alertOnEntry,I.formAlertExit.checked=e.alertOnExit;const t={lat:e.lat,lng:e.lng};B&&B.setMap(null),B=new google.maps.Marker({position:t,map:y,draggable:!0}),B.addListener("dragend",e=>{const t=e.latLng.lat(),n=e.latLng.lng();I.formLat.value=t,I.formLng.value=n,I.formAddress.value=`Coords: ${t.toFixed(5)}, ${n.toFixed(5)}`}),y.panTo(t),y.setZoom(15)}else C=!1,k=null,I.panelTitle.textContent="Add New Geofence",I.modalSaveText.textContent="Save Geofence"}function j(){I.formPanel.classList.add("hidden"),I.geofenceList.classList.remove("hidden"),I.addGeofenceBtn.classList.remove("hidden"),I.panelTitle.textContent="My Geofences",0===v.length&&(I.geofenceListEmpty.style.display="block"),I.mapClickPrompt.classList.add("hidden"),B&&(B.setMap(null),B=null),I.form.reset()}function F(e){const t=v.find(t=>t.id===e);if(!t)return;k=e,y.panTo({lat:t.lat,lng:t.lng}),y.setZoom(16),document.querySelectorAll(".geofence-item").forEach(t=>{t.classList.toggle("active",t.dataset.id===e)});const n=b[e];n&&(Object.values(b).forEach(e=>e.setAnimation(null)),n.setAnimation(google.maps.Animation.BOUNCE),setTimeout(()=>n.setAnimation(null),2e3))}function O(e){e?(I.modalSaveBtn.disabled=!0,I.modalSaveText.classList.add("hidden"),I.modalSpinner.classList.remove("hidden")):(I.modalSaveBtn.disabled=!1,I.modalSaveText.classList.remove("hidden"),I.modalSpinner.classList.add("hidden"))}!function(e){const n=()=>{window.currentUserId&&window.librariesLoaded&&"undefined"!=typeof google&&t?(console.log("Geofencing: Auth, libraries (Google Maps), and styles are ready."),e(window.currentUserId)):window.currentUserId?window.librariesLoaded?requestAnimationFrame(n):window.addEventListener("librariesLoaded",()=>n(),{once:!0}):requestAnimationFrame(n)};window.currentUserId&&window.librariesLoaded&&"undefined"!=typeof google&&t?e(window.currentUserId):requestAnimationFrame(n)}(x=>{!function(){if(!I.mapContainer)return;const e="dark"===document.documentElement.getAttribute("data-theme")?t.dark:t.light;y=new google.maps.Map(I.mapContainer,{center:{lat:2.9436,lng:101.7949},zoom:12,disableDefaultUI:!0,zoomControl:!0,styles:e}),y.addListener("click",G),window.addEventListener("themeChanged",e=>{if(y&&t){const n="dark"===e.detail.theme?t.dark:t.light;y.setOptions({styles:n})}})}(),function(t){I.addGeofenceBtn.addEventListener("click",()=>T(null)),I.modalCancelBtn.addEventListener("click",j),I.form.addEventListener("submit",a=>async function(t,a){if(t.preventDefault(),!I.formLat.value||!I.formLng.value)return void n("Location Required","Please click on the map to set a location.","warning");O(!0);const i={name:I.formName.value,address:I.formAddress.value,lat:parseFloat(I.formLat.value),lng:parseFloat(I.formLng.value),radius:parseInt(I.formRadius.value,10),alertOnEntry:I.formAlertEntry.checked,alertOnExit:I.formAlertExit.checked,icon:"bi-pin-map-fill",updatedAt:f()};try{const t=r(e,"user_data",a,"geofences");if(C){const e=u(t,k);await p(e,i,{merge:!0}),n("Success",`Geofence "${o(i.name)}" has been updated.`,"success")}else i.createdAt=f(),await g(t,i),n("Success",`Geofence "${o(i.name)}" has been created.`,"success");j()}catch(s){console.error("Error saving geofence:",s),n("Error","Could not save geofence. Please try again.","error")}finally{O(!1)}}(a,t)),I.geofenceList.addEventListener("click",t=>{const a=t.target.closest(".geofence-item"),i=t.target.closest(".action-btn-sm.edit"),s=t.target.closest(".action-btn-sm.delete");if(s)t.stopPropagation(),function(t){const a=v.find(e=>e.id===t);if(!a)return;l("Delete Geofence?",`Are you sure you want to delete <strong>${o(a.name)}</strong>? This action cannot be undone.`,"danger",async()=>{try{const i=u(e,"user_data",window.currentUserId,"geofences",t);await h(i),n("Deleted",`Geofence "${o(a.name)}" has been deleted.`,"success")}catch(i){console.error("Error deleting geofence:",i),n("Error","Could not delete geofence.","error")}},null,{isHTML:!0})}(s.dataset.id);else if(i){t.stopPropagation();T(v.find(e=>e.id===i.dataset.id))}else a&&F(a.dataset.id)})}(x),function(t){$&&$();const a=r(e,"user_data",t,"geofences"),i=d(a,c("name","asc"));$=m(i,e=>{v=e.docs.map(e=>({id:e.id,...e.data()})),function(){if(I.geofenceList.innerHTML="",!v||0===v.length)return void(I.geofenceListEmpty.style.display="block");I.geofenceListEmpty.style.display="none",v.forEach((e,t)=>{const n=document.createElement("div");n.className="geofence-item",e.id===k&&n.classList.add("active"),n.setAttribute("data-id",e.id),n.style.animationDelay=50*t+"ms";const a=e.icon||"bi-pin-map-fill",i=e.radius?`${e.radius}m`:"N/A",s=[];e.alertOnEntry&&s.push("Entry"),e.alertOnExit&&s.push("Exit");const l=s.length>0?`Alerts: ${s.join(", ")}`:"No Alerts";n.innerHTML=`\n            <div class="geofence-item-icon">\n                <i class="bi ${a}"></i>\n            </div>\n            <div class="geofence-item-info">\n                <div class="geofence-item-name">${o(e.name)}</div>\n                <div class="geofence-item-details">${i} &bull; ${l}</div>\n            </div>\n            <div class="geofence-item-actions">\n                <button class="action-btn-sm edit" data-id="${e.id}" aria-label="Edit geofence">\n                    <i class="bi bi-pencil-fill"></i>\n                </button>\n                <button class="action-btn-sm delete" data-id="${e.id}" aria-label="Delete geofence">\n                    <i class="bi bi-trash-fill"></i>\n                </button>\n            </div>\n        `,I.geofenceList.appendChild(n)})}(),function(){if(!y)return;Object.values(b).forEach(e=>e.setMap(null)),Object.values(w).forEach(e=>e.setMap(null)),b={},w={};const e="#4361ee";v.forEach(t=>{const n={lat:t.lat,lng:t.lng},a=new google.maps.Marker({position:n,map:y,title:t.name,icon:{path:google.maps.SymbolPath.CIRCLE,scale:5,fillColor:e,fillOpacity:1,strokeWeight:2,strokeColor:"white"}}),i=new google.maps.InfoWindow({content:`\n                <div style="color:black">\n                    <b>${o(t.name)}</b><br>\n                    Geofence Center<br>\n                    Radius: ${t.radius}m\n                </div>\n            `});a.addListener("click",()=>{i.open(y,a),F(t.id)}),b[t.id]=a;const s=new google.maps.Circle({strokeColor:e,strokeOpacity:.8,strokeWeight:2,fillColor:e,fillOpacity:.2,map:y,center:n,radius:t.radius});w[t.id]=s})}(),S()},e=>{console.error("Error listening for geofences:",e),n("Error","Could not load geofences.","error")})}(x),function(t){A&&A();const n=r(e,"user_data",t,"devices"),l=d(n);A=m(l,e=>{L=e.docs.map(e=>({id:e.id,...e.data()})),function(){if(!y)return;Object.values(E).forEach(e=>e.setMap(null)),E={},L.forEach(e=>{let t,n;if(e.location&&(t=e.location.lat??e.location.latitude,n=e.location.lng??e.location.longitude),void 0===t||void 0===n)return;const l={lat:parseFloat(t),lng:parseFloat(n)},r={online:"#10b981",found:"#10b981",offline:"#ef4444",lost:"#ef4444",warning:"#f59e0b"}[e.status]||"#64748b",d=`\n            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 80 80">\n                ${"offline"!==e.status?'\n                <circle cx="40" cy="40" r="18" fill="#4361ee" stroke="#4361ee" stroke-width="2" opacity="0.6">\n                    <animate attributeName="r" from="18" to="40" dur="1.5s" repeatCount="indefinite" />\n                    <animate attributeName="opacity" from="0.8" to="0" dur="1.5s" repeatCount="indefinite" />\n                </circle>\n                ':""}\n                <circle cx="40" cy="40" r="18" fill="${r}" stroke="white" stroke-width="3" />\n                <g transform="translate(28, 28)">\n                    <path fill="white" d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/>\n                </g>\n            </svg>`,c="data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(d),m=new google.maps.Marker({position:l,map:y,title:`Device: ${e.name}`,icon:{url:c,scaledSize:new google.maps.Size(48,48),anchor:new google.maps.Point(24,24)},optimized:!1}),g=e.lastSeen?a(e.lastSeen):"Unknown",f=e.battery||0,u=new google.maps.InfoWindow({content:`\n                <div class="device-popup-map" style="min-width: 200px; padding: 5px; color: #333;">\n                    <h5 style="margin:0 0 5px; font-size: 16px; font-weight:bold;">${o(e.name||"Unnamed Device")}</h5>\n                    <p style="margin:2px 0;"><i class="bi bi-info-circle"></i> <strong>Model:</strong> ${o(e.model||"N/A")}</p>\n                    <p style="margin:2px 0;"><i class="bi ${i(f)}"></i> <strong>Battery:</strong> ${f}%</p>\n                    <p style="margin:2px 0;"><i class="bi bi-clock"></i> <strong>Last Seen:</strong> ${g}</p>\n                    <p style="margin:2px 0;"><i class="bi bi-shield-check"></i> <strong>Status:</strong> <span style="color: ${s(e.status)}; font-weight:500; text-transform:capitalize;">${e.status}</span></p>\n                    <a href="/app/device-details.html?id=${e.id}" class="btn" style="display:block; text-align:center; background:#4361ee; color:white; padding:5px; text-decoration:none; border-radius:4px; margin-top:8px;">\n                        <i class="bi bi-search mr-1"></i> View Details\n                    </a>\n                </div>\n            `});m.addListener("click",()=>{u.open(y,m)}),E[e.id]=m})}(),S()},e=>{console.error("Error listening for devices in geofencing:",e)})}(x)});
