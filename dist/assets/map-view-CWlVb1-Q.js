import"./modulepreload-polyfill-YP0FEG5d.js";import{f as e}from"./app-shell-CtSII-jN.js";import{m as t}from"./map-tiles-D1fw3GxV.js";import{a as n,e as o,g as i,d as a,s,h as r,i as l}from"./shared-utils-DEXrBstL.js";import{collection as d,query as c,orderBy as m,onSnapshot as p}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";let g=null,u={},f=null,w=null,v=[],b=null,h=null;const y={mapContainer:document.getElementById("map"),deviceListContainer:document.getElementById("deviceListContainer"),deviceListEmpty:document.getElementById("device-list-empty"),mapSidebarPanel:document.getElementById("mapSidebarPanel"),toggleDeviceListBtn:document.getElementById("toggleDeviceListBtn"),closeMapSidebarBtn:document.getElementById("closeMapSidebarBtn"),locateMeBtn:document.getElementById("locateMeBtn"),zoomInBtn:document.getElementById("zoomInBtn"),zoomOutBtn:document.getElementById("zoomOutBtn"),toggleFullscreenBtn:document.getElementById("toggleFullscreenBtn")};function L(e){y.deviceListContainer&&(y.deviceListContainer.innerHTML="",e&&0!==e.length?(y.deviceListEmpty&&y.deviceListEmpty.classList.add("hidden"),e.forEach(e=>{const t=w===e.id,n=document.createElement("div");n.className="device-item-map "+(t?"active":""),n.setAttribute("data-device-id",e.id);const l=e.lastSeen&&"function"==typeof e.lastSeen.toDate?e.lastSeen.toDate():null,d=l?o(l):"Never",c=e.battery||0,m=e.status||"offline",p=m.charAt(0).toUpperCase()+m.slice(1);n.innerHTML=`\n            <div class="device-item-icon" style="background-color: ${i(m)}">\n                <i class="bi ${a(e.type)}"></i>\n            </div>\n            <div class="device-item-info">\n                <div class="device-item-name">${s(e.name||"Unnamed Device")}</div>\n                <div class="device-item-status">\n                    <span class="font-medium" style="color: ${i(m)}">${p}</span>\n                    <span class="device-item-battery ml-2">\n                        <i class="bi ${r(c)}"></i>\n                        ${c}%\n                    </span>\n                </div>\n                <div class="text-xs text-text-secondary dark:text-dark-text-secondary">${d}</div>\n            </div>\n        `,y.deviceListContainer.appendChild(n)})):y.deviceListEmpty&&y.deviceListEmpty.classList.remove("hidden"))}function B(e,t=!0){w=e,L(v);const n=u[e];n&&t&&(g.panTo(n.getPosition()),g.setZoom(16),new google.maps.event.trigger(n,"click")),window.innerWidth<1023&&(y.mapSidebarPanel.classList.remove("open"),y.mapSidebarPanel.classList.add("-translate-x-full"))}function E(){navigator.geolocation?(n("Locating","Getting your current location...","info"),navigator.geolocation.getCurrentPosition(e=>{const t={lat:e.coords.latitude,lng:e.coords.longitude};h&&h.setMap(null),h=new google.maps.Marker({position:t,map:g,title:"You are here",icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:"#4285F4",fillOpacity:1,strokeWeight:2,strokeColor:"white"}});const o=new google.maps.InfoWindow({content:"<b>You are here</b>"});h.addListener("click",()=>{o.open(g,h)}),g.setCenter(t),g.setZoom(15),n("Location Found","Showing your current location.","success")},e=>{console.error("Geolocation failed:",e),n("Error","Could not find your location.","error")})):n("Geolocation Error","Geolocation is not supported by your browser","error")}function k(){const e=document.querySelector(".map-main-panel"),t=y.toggleFullscreenBtn?.querySelector("i");e&&(document.fullscreenElement?(document.exitFullscreen&&document.exitFullscreen(),t&&(t.className="bi bi-fullscreen")):(e.requestFullscreen().catch(e=>{n("Error",`Could not enable full-screen: ${e.message}`,"error")}),t&&(t.className="bi bi-fullscreen-exit")))}!function(e){const n=()=>{window.currentUserId&&window.librariesLoaded&&"undefined"!=typeof google&&t?(console.log("Map logic: Auth, libraries (Google Maps), and styles are ready."),e(window.currentUserId)):window.currentUserId?window.librariesLoaded?requestAnimationFrame(n):(console.log("Map logic waiting for libraries..."),window.addEventListener("librariesLoaded",()=>n(),{once:!0})):(console.log("Map logic waiting for authentication..."),requestAnimationFrame(n))};window.currentUserId&&window.librariesLoaded&&"undefined"!=typeof google&&t?e(window.currentUserId):requestAnimationFrame(n)}(i=>{!function(){if(!y.mapContainer)return;const e="dark"===document.documentElement.getAttribute("data-theme")?t.dark:t.light;g=new google.maps.Map(y.mapContainer,{center:{lat:2.9436,lng:101.7949},zoom:12,disableDefaultUI:!0,styles:e,mapTypeId:"roadmap"}),"undefined"!=typeof markerClusterer?f=new markerClusterer.MarkerClusterer({map:g,markers:[]}):console.warn("MarkerClusterer library not loaded.");const n=()=>{g&&google.maps.event.trigger(g,"resize")};window.addEventListener("resize",n),window.addEventListener("appResize",n),window.addEventListener("themeChanged",e=>{if(g&&t){const n="dark"===e.detail.theme?t.dark:t.light;g.setOptions({styles:n})}})}(),function(){y.locateMeBtn&&y.locateMeBtn.addEventListener("click",E);y.zoomInBtn&&y.zoomInBtn.addEventListener("click",()=>g.setZoom(g.getZoom()+1));y.zoomOutBtn&&y.zoomOutBtn.addEventListener("click",()=>g.setZoom(g.getZoom()-1));y.toggleFullscreenBtn&&y.toggleFullscreenBtn.addEventListener("click",k);y.toggleDeviceListBtn&&y.toggleDeviceListBtn.addEventListener("click",()=>{y.mapSidebarPanel.classList.toggle("open"),y.mapSidebarPanel.classList.toggle("-translate-x-full")});y.closeMapSidebarBtn&&y.closeMapSidebarBtn.addEventListener("click",()=>{y.mapSidebarPanel.classList.remove("open"),y.mapSidebarPanel.classList.add("-translate-x-full")});y.deviceListContainer&&y.deviceListContainer.addEventListener("click",e=>{const t=e.target.closest(".device-item-map");t&&B(t.dataset.deviceId)})}(),function(t){b&&b();const i=d(e,"user_data",t,"devices"),a=c(i,m("lastSeen","desc"));b=p(a,e=>{v=e.docs.map(e=>({id:e.id,...e.data()})),L(v),function(e){if(!g||!f)return;const t=new Set,n=new google.maps.LatLngBounds;let i=!1;e.forEach(e=>{t.add(e.id);let a=e.location?.lat??e.location?.latitude,r=e.location?.lng??e.location?.longitude;if(a=parseFloat(a),r=parseFloat(r),isNaN(a)||isNaN(r))return;const d={lat:a,lng:r};i=!0,n.extend(d);const c={online:"#10b981",found:"#10b981",offline:"#ef4444",lost:"#ef4444",warning:"#f59e0b"}[e.status]||"#64748b",m=`\n            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 80 80">\n                ${"offline"!==e.status?'\n                <circle cx="40" cy="40" r="18" fill="#4361ee" stroke="#4361ee" stroke-width="2" opacity="0.6">\n                    <animate attributeName="r" from="18" to="40" dur="1.5s" repeatCount="indefinite" />\n                    <animate attributeName="opacity" from="0.8" to="0" dur="1.5s" repeatCount="indefinite" />\n                </circle>':""}\n                <circle cx="40" cy="40" r="18" fill="${c}" stroke="white" stroke-width="3" />\n                <g transform="translate(28, 28)">\n                    <path fill="white" d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/>\n                </g>\n            </svg>`,p={url:"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(m),scaledSize:new google.maps.Size(48,48),anchor:new google.maps.Point(24,24)};if(u[e.id]){const t=u[e.id];t.setIcon(p),l(t,d)}else{const t=new google.maps.Marker({position:d,title:e.name,icon:p,optimized:!1}),n=new google.maps.InfoWindow({content:`\n                    <div class="device-popup-map" style="min-width: 200px; padding: 5px; color: #333;">\n                        <h5 style="margin:0 0 5px; font-size: 16px; font-weight:bold;">${s(e.name||"Unnamed Device")}</h5>\n                        <p style="margin:2px 0;"><i class="bi bi-clock"></i> <strong>Last Seen:</strong> ${o(e.lastSeen)}</p>\n                        <a href="/app/device-details.html?id=${e.id}" class="btn" style="display:block; text-align:center; background:#4361ee; color:white; padding:5px; text-decoration:none; border-radius:4px; margin-top:8px;">\n                            View Details\n                        </a>\n                    </div>\n                `});t.addListener("click",()=>{n.open(g,t),B(e.id,!1)}),f.addMarker(t),u[e.id]=t}}),Object.keys(u).forEach(e=>{if(!t.has(e)){const t=u[e];f.removeMarker(t),t.setMap(null),delete u[e]}}),f.repaint(),!i||w||window.mapBoundsInitialized||(g.fitBounds(n),window.mapBoundsInitialized=!0)}(v)},e=>{console.error("Error listening for devices:",e),n("Error","Could not load real-time device data.","error")})}(i)});
