import"./modulepreload-polyfill-YP0FEG5d.js";import{f as e}from"./app-shell-CtSII-jN.js";import{a as t,b as a,c as o}from"./shared-utils-DEXrBstL.js";import{collection as n,getDocs as r,query as s,orderBy as c,onSnapshot as i,serverTimestamp as d,doc as l,getDoc as u,addDoc as p,setDoc as f,writeBatch as b,deleteDoc as m}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";let y=[],k=null;const v={createBackupBtn:document.getElementById("create-backup-btn"),uploadBackupLabel:document.getElementById("upload-backup-label"),uploadBackupInput:document.getElementById("upload-backup-input"),backupList:document.getElementById("backup-list"),backupListEmpty:document.getElementById("backup-list-empty"),backupScopeSelect:document.getElementById("backupScope"),deviceOptionsGroup:document.getElementById("deviceOptions")};function g(n,r,s=null,c="full",i=""){let d=n.profile||null,u=[],p=n.geofences||[];Array.isArray(n.devices)?u=n.devices:n.devices&&"object"==typeof n.devices&&n.devices[r]&&n.devices[r].backup&&n.devices[r].backup.contacts&&(d=n.devices[r].backup.contacts);let f="Restore Data?",m="Are you sure you want to restore this data?";"contact_only"===c?(f="Restore Contact Info?",m="Are you sure you want to restore your <strong>Contact Information</strong>?"):"single_device"===c?(f=`Restore ${i}?`,m=`Are you sure you want to restore data for <strong>${i}</strong>? <br>Current data for this specific device will be overwritten.`):(f="Restore Full Account?",m=`This will overwrite <strong>${u.length} devices</strong> and <strong>${p.length} geofences</strong>. <br><span class="text-warning">Warning: Current data will be replaced.</span>`),o(f,m,"warning",async()=>{s&&a(s,!0),t("Restoring...","Applying data...","info");try{const a=b(e);let o=0;if(d){const t=l(e,"user_data",r,"profile","settings");a.set(t,d,{merge:!0}),o++}u.length>0&&u.forEach(t=>{if(t.id){const n=l(e,"user_data",r,"devices",t.id);a.set(n,t),o++}}),p.length>0&&p.forEach(t=>{if(t.id){const n=l(e,"user_data",r,"geofences",t.id);a.set(n,t),o++}}),o>0?(await a.commit(),t("Success","Data restored successfully.","success")):t("Info","No data found in backup to restore.","info")}catch(o){console.error("Error restoring data:",o),t("Error","Could not restore data.","error")}finally{s&&a(s,!1)}},()=>{s&&a(s,!1)})}!function(e){const t=()=>{window.currentUserId?e(window.currentUserId):requestAnimationFrame(t)};window.currentUserId?e(window.currentUserId):requestAnimationFrame(t)}(b=>{!function(s){v.createBackupBtn&&v.createBackupBtn.addEventListener("click",()=>async function(o){a(v.createBackupBtn,!0);const s=v.backupScopeSelect.value;try{let a={},c={createdAt:d(),type:"full",deviceCount:0,geofenceCount:0,hasProfile:!1,deviceName:null,data:""};if("full"===s||"contacts"===s){const t=l(e,"user_data",o,"profile","settings"),n=await u(t);n.exists()&&(a.profile=n.data(),c.hasProfile=!0)}if("full"!==s&&"contacts"!==s){const t=s,n=l(e,"user_data",o,"devices",t),r=await u(n);if(!r.exists())throw new Error("Selected device not found.");const i={id:r.id,...r.data()};a.devices=[i],c.type="single_device",c.deviceCount=1,c.deviceName=i.nickname||i.model||t}if("full"===s){const t=n(e,"user_data",o,"devices"),s=await r(t);a.devices=s.docs.map(e=>({id:e.id,...e.data()})),c.deviceCount=a.devices.length;const i=n(e,"user_data",o,"geofences"),d=await r(i);a.geofences=d.docs.map(e=>({id:e.id,...e.data()})),c.geofenceCount=a.geofences.length}"contacts"===s&&(c.type="contact_only",a.devices||(a.devices={})),c.data=JSON.stringify(a);const i=n(e,"user_data",o,"backups");await p(i,c);const b=l(e,"user_data",o,"profile","settings");await f(b,{pending_action:"backup_complete",last_backup:d()},{merge:!0}),t("Success","Backup snapshot created successfully.","success")}catch(c){console.error("Error creating backup:",c),t("Error","Could not create backup. "+c.message,"error")}finally{a(v.createBackupBtn,!1)}}(s));v.uploadBackupInput&&v.uploadBackupInput.addEventListener("change",e=>function(e,o){const n=e.target.files[0];if(!n)return;if("application/json"!==n.type)return void t("Error","Invalid file type. Please upload a .json file.","error");a(v.uploadBackupLabel,!0);const r=new FileReader;r.onload=e=>{try{const t=JSON.parse(e.target.result);let a=!1;if((t.profile||t.devices&&Array.isArray(t.devices))&&(a=!0),t.devices&&"object"==typeof t.devices&&!Array.isArray(t.devices)&&(a=!0),!a)throw new Error("Invalid backup file format.");g(t,o,v.uploadBackupLabel)}catch(n){console.error("Error parsing backup file:",n),t("Error","Invalid or corrupt backup file.","error"),a(v.uploadBackupLabel,!1)}},r.readAsText(n),e.target.value=null}(e,s));v.backupList&&v.backupList.addEventListener("click",a=>{const n=a.target.closest("button");if(!n)return;const r=n.dataset.id;n.matches(".btn-restore")?function(e,a){const o=y.find(t=>t.id===e);if(!o)return void t("Error","Backup not found.","error");try{g(JSON.parse(o.data),a,null,o.type,o.deviceName)}catch(n){console.error("Error parsing backup data:",n),t("Error","Corrupt backup data.","error")}}(r,s):n.matches(".btn-download")?function(e){const a=y.find(t=>t.id===e);if(!a||!a.data)return void t("Error","Backup data not found.","error");try{const e=a.createdAt?.toDate()?a.createdAt.toDate().toISOString().split("T")[0]:"backup";let o="full";"contact_only"===a.type&&(o="contact"),"single_device"===a.type&&(o="device");const n=`tracenfind_${o}_backup_${e}.json`,r=new Blob([a.data],{type:"application/json"}),s=URL.createObjectURL(r),c=document.createElement("a");c.href=s,c.download=n,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(s),t("Downloading","Backup file downloading.","success")}catch(o){console.error("Error creating download:",o),t("Error","Could not prepare download.","error")}}(r):n.matches(".btn-delete")&&function(a,n){o("Delete Snapshot?","Are you sure you want to delete this backup snapshot? This action cannot be undone.","danger",async()=>{try{const o=l(e,"user_data",n,"backups",a);await m(o),t("Success","Backup snapshot deleted.","success")}catch(o){console.error("Error deleting backup:",o),t("Error","Could not delete backup.","error")}})}(r,s)})}(b),function(a){k&&k();const o=n(e,"user_data",a,"backups"),r=s(o,c("createdAt","desc"));k=i(r,e=>{y=e.docs.map(e=>({id:e.id,...e.data()})),function(){if(!v.backupList)return;if(v.backupList.innerHTML="",!y||0===y.length)return v.backupList.appendChild(v.backupListEmpty),void(v.backupListEmpty.style.display="block");v.backupListEmpty.style.display="none",y.forEach((e,t)=>{const a=document.createElement("div");a.className="backup-list-item",a.style.animationDelay=30*t+"ms";const o=e.createdAt?.toDate()?e.createdAt.toDate().toLocaleString():"Just now",n=e.hasProfile,r=e.type||"full";let s="",c="bi-hdd-network";if("contact_only"===r)s='<span class="text-success font-medium"><i class="bi bi-person-check-fill"></i> Contact Information Only</span>',c="bi-person-rolodex";else if("single_device"===r){s=`<span class="text-primary font-medium"><i class="bi bi-phone"></i> ${e.deviceName||"Unknown Device"}</span>`,c="bi-phone"}else{s=`<span class="text-text-secondary">${e.deviceCount||0} devices, ${e.geofenceCount||0} geofences</span>`,n&&(s+=' <span class="text-success text-xs mx-1">â€¢ Profile</span>')}a.innerHTML=`\n            <div class="backup-icon-wrapper">\n                <i class="bi ${c}"></i>\n            </div>\n            <div class="flex-1">\n                <div class="font-semibold text-text-primary dark:text-dark-text-primary">Snapshot - ${o}</div>\n                <div class="text-sm text-text-secondary dark:text-dark-text-secondary mt-0.5">${s}</div>\n            </div>\n            <div class="flex flex-col sm:flex-row gap-2">\n                <button class="btn btn-sm btn-secondary btn-restore" data-id="${e.id}" title="Restore">\n                    <i class="bi bi-arrow-counterclockwise mr-1"></i> Restore\n                </button>\n                <button class="btn btn-sm btn-secondary btn-download" data-id="${e.id}" title="Download">\n                    <i class="bi bi-download mr-1"></i> JSON\n                </button>\n                <button class="btn btn-sm btn-secondary btn-delete" data-id="${e.id}" title="Delete">\n                    <i class="bi bi-trash-fill text-danger"></i>\n                </button>\n            </div>\n        `,v.backupList.appendChild(a)})}()},e=>{console.error("Error listening for backups:",e),t("Error","Could not load backup history.","error"),v.backupListEmpty&&(v.backupListEmpty.style.display="block")})}(b),async function(t){if(!v.deviceOptionsGroup)return;try{const a=n(e,"user_data",t,"devices"),o=await r(a);if(v.deviceOptionsGroup.innerHTML="",o.empty){const e=document.createElement("option");return e.disabled=!0,e.textContent="No devices found",void v.deviceOptionsGroup.appendChild(e)}o.forEach(e=>{const t=e.data(),a=document.createElement("option");a.value=e.id;const o=t.nickname||t.model||`Device ${e.id.substring(0,6)}`;a.textContent=o,v.deviceOptionsGroup.appendChild(a)})}catch(a){console.error("Error loading devices for backup options:",a),v.deviceOptionsGroup.innerHTML="<option disabled>Error loading devices</option>"}}(b)});
