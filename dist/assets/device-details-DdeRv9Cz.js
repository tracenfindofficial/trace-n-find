import"./modulepreload-polyfill-YP0FEG5d.js";import{f as e}from"./app-shell-CtSII-jN.js";import{m as t}from"./map-tiles-D1fw3GxV.js";import{a as n,g as i,d as a,e as s,s as o,i as r}from"./shared-utils-DEXrBstL.js";import{collection as c,query as d,where as l,onSnapshot as m,doc as u,orderBy as p,limit as g}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";let f=null,x=null,y=null,v=null,b=null;const h={loader:document.getElementById("skeleton-loader"),content:document.getElementById("device-content"),notificationBadge:document.getElementById("notificationBadge"),headerName:document.getElementById("header-device-name"),deviceName:document.getElementById("device-name"),deviceIcon:document.getElementById("device-icon"),deviceModel:document.getElementById("device-model"),deviceStatus:document.getElementById("device-status-badge"),deviceLastSeen:document.getElementById("device-last-seen"),liveIndicator:document.getElementById("live-indicator"),statBattery:document.getElementById("battery-level-text"),statStorage:document.getElementById("storage-text"),statNetwork:document.getElementById("network-type-text"),statSignal:document.getElementById("signal-strength-text"),mapContainer:document.getElementById("map"),activityList:document.getElementById("activity-timeline"),infoOS:document.getElementById("device-os"),infoCarrierStatus:document.getElementById("device-carrier-status"),infoIP:document.getElementById("device-ip"),infoCarrier:document.getElementById("device-carrier"),infoMAC:document.getElementById("device-mac"),batteryChart:document.getElementById("battery-chart"),networkChart:document.getElementById("network-chart"),storageChart:document.getElementById("storage-chart"),signalChart:document.getElementById("signal-chart")};function w(e){if(e.timestamp&&"function"==typeof e.timestamp.toMillis)return e.timestamp.toMillis();if(e.time){const t=new Date(e.time);return isNaN(t.getTime())?0:t.getTime()}return 0}function k(e){h.activityList&&(h.activityList.innerHTML="",e&&0!==e.length?e.forEach(e=>{const t=document.createElement("div");t.className="flex gap-4 p-4 rounded-xl hover:bg-bg-primary dark:hover:bg-dark-bg-primary transition-colors border border-transparent hover:border-border-color dark:hover:border-dark-border-color animation-fade-in";let n="bi-info-circle-fill",i="bg-primary-100 text-primary-600 dark:bg-primary-900/30 dark:text-primary-400";const a=(e.type||"info").toLowerCase();a.includes("security")||a.includes("alert")||a.includes("danger")?(n="bi-shield-exclamation",i="bg-danger-100 text-danger-600 dark:bg-danger-900/30 dark:text-danger-400"):a.includes("warning")||a.includes("battery")?(n="bi-exclamation-triangle-fill",i="bg-warning-100 text-warning-700 dark:bg-warning-900/30 dark:text-warning-400"):a.includes("lost")||a.includes("location")?(n="bi-geo-alt-fill",i="bg-info-100 text-info-600 dark:bg-info-900/30 dark:text-info-400"):(a.includes("success")||a.includes("found"))&&(n="bi-check-circle-fill",i="bg-success-100 text-success-600 dark:bg-success-900/30 dark:text-success-400");let r=e.timestamp||e.time,c="Just now";if(r)if("function"==typeof r.toDate)c=s(r.toDate());else if(r instanceof Date)c=s(r);else if("string"==typeof r){const e=new Date(r);isNaN(e)||(c=s(e))}else"number"==typeof r&&(c=s(new Date(r)));t.innerHTML=`\n            <div class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ${i}">\n                <i class="bi ${n} text-lg"></i>\n            </div>\n            <div class="flex-1 min-w-0">\n                <p class="font-semibold text-sm text-text-primary dark:text-dark-text-primary truncate">\n                    ${o(e.title||"Notification")}\n                </p>\n                <p class="text-sm text-text-secondary dark:text-dark-text-secondary line-clamp-2">\n                    ${o(e.message||e.body||"No details provided.")}\n                </p>\n                <p class="text-xs text-text-secondary dark:text-dark-text-secondary mt-1 opacity-70">\n                    <i class="bi bi-clock"></i> ${c}\n                </p>\n            </div>\n        `,h.activityList.appendChild(t)}):h.activityList.innerHTML='\n            <div id="activity-empty" class="text-center p-6 animation-fade-in">\n                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary-50 dark:bg-primary-900/20 mb-4">\n                    <i class="bi bi-clock-history text-3xl text-text-secondary dark:text-dark-text-secondary opacity-70"></i>\n                </div>\n                <h3 class="text-base font-medium text-text-primary dark:text-dark-text-primary">No recent activity</h3>\n                <p class="mt-1 text-sm text-text-secondary dark:text-dark-text-secondary">Notifications for this device will appear here.</p>\n            </div>\n        ')}!function(e){const n=()=>{window.currentUserId&&window.librariesLoaded&&"undefined"!=typeof google&&t?e(window.currentUserId):requestAnimationFrame(n)};n()}(C=>{const I=new URLSearchParams(window.location.search);f=I.get("id"),f?(console.log(`Initializing details for device: ${f}`),function(f,w){(function(){if(!h.mapContainer)return;const e="dark"===document.documentElement.getAttribute("data-theme")?t.dark:t.light,n={lat:2.9436,lng:101.7949};y=new google.maps.Map(h.mapContainer,{center:n,zoom:13,disableDefaultUI:!0,zoomControl:!0,styles:e,mapTypeId:"roadmap"}),new google.maps.LatLngBounds,b=new google.maps.InfoWindow,window.addEventListener("themeChanged",e=>{if(y&&t){const n="dark"===e.detail.theme?t.dark:t.light;y.setOptions({styles:n})}})})(),function(t,c){const d=u(e,"user_data",t,"devices",c);m(d,e=>{e.exists()?(x={id:e.id,...e.data()},function(e){const t=e.info||{},n=e.sim||{},c=e.security||{},d=e.name||e.model||"Unknown Device";h.headerName.textContent=d,h.deviceName.textContent=d,h.deviceModel.textContent=e.model||t.model||"Unknown Model";const l=i(e.status);h.deviceIcon.style.backgroundColor=`${l}20`,h.deviceIcon.style.color=l,h.deviceIcon.innerHTML=`<i class="bi ${a(e.type||t.type)}"></i>`,h.deviceStatus.textContent=e.status||"Offline",h.deviceStatus.style.borderColor=l,h.deviceStatus.style.color=l,h.deviceStatus.className=`text-sm font-semibold uppercase px-3 py-1 rounded-full border border-current bg-[${l}10]`;const m=s(e.lastSeen||e.last_updated);h.deviceLastSeen.textContent=m;const u="online"===e.status||"active"===e.status,p=m.includes("Just now")||m.includes("sec")||m.includes("min")&&parseInt(m)<5;u&&p&&h.liveIndicator?(h.liveIndicator.classList.remove("hidden"),h.liveIndicator.classList.add("flex")):h.liveIndicator&&(h.liveIndicator.classList.add("hidden"),h.liveIndicator.classList.remove("flex"));const g=e.battery??e.battery_level??0;h.statBattery.textContent=`${g}%`,h.statBattery.className=g<20?"font-bold text-xl text-danger-500":g<50?"font-bold text-xl text-warning-500":"font-bold text-xl text-success-500";h.statStorage.textContent=e.storage||"N/A",h.statNetwork.textContent=e.network_display||e.network||"N/A";const f=e.signal_strength??e.signal??e.signal_level;if(null!=f){const e=String(f).replace(/\s?dBm/gi,"").trim();h.statSignal.textContent=`${e} dBm`}else h.statSignal.textContent="N/A";h.infoOS.textContent=e.os_version||e.os||t.os||"N/A",h.infoIP.textContent=e.ip_address||e.ip||t.ip||"N/A",h.infoMAC&&(h.infoMAC.textContent=e.mac_address||e.mac||t.mac||"N/A");const x=n.carrier||e.carrier||"Unknown Carrier";h.infoCarrier.textContent=x;const w=e.sim_status||c.sim_status||n.status||"Unknown";h.infoCarrierStatus.textContent=w,h.infoCarrierStatus.className="font-medium";const k=String(w).toLowerCase();["active","online","ready","inserted"].includes(k)?h.infoCarrierStatus.classList.add("text-success-500"):["inactive","blocked","missing","removed","absent","ejected"].includes(k)&&h.infoCarrierStatus.classList.add("text-danger-500");h.loader&&(h.loader.style.display="none");h.content&&(h.content.classList.remove("hidden"),h.content.classList.add("animate-fade-in"));!function(e){if(!y)return;let t,n;e.location&&(void 0!==e.location.lat?t=parseFloat(e.location.lat):void 0!==e.location.latitude&&(t=parseFloat(e.location.latitude)),void 0!==e.location.lng?n=parseFloat(e.location.lng):void 0!==e.location.longitude&&(n=parseFloat(e.location.longitude)));if("number"!=typeof t||isNaN(t)||"number"!=typeof n||isNaN(n))return;const i={lat:t,lng:n},a={online:"#10b981",found:"#10b981",active:"#10b981",offline:"#64748b",inactive:"#64748b",warning:"#f59e0b",lost:"#ef4444",stolen:"#ef4444"}[e.status?.toLowerCase()]||"#4361ee",c=`\n        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 80 80">\n            ${"online"===e.status||"active"===e.status||"lost"===e.status?`\n            <circle cx="40" cy="40" r="18" fill="${a}" fill-opacity="0.3">\n                <animate attributeName="r" from="18" to="40" dur="1.5s" repeatCount="indefinite" />\n                <animate attributeName="opacity" from="0.6" to="0" dur="1.5s" repeatCount="indefinite" />\n            </circle>\n            `:""}\n            <circle cx="40" cy="40" r="18" fill="${a}" stroke="white" stroke-width="3" />\n            \x3c!-- Smartphone Icon Center --\x3e\n            <g transform="translate(28, 28) scale(0.9)">\n                 <path fill="white" d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/>\n            </g>\n        </svg>`,d={url:"data:image/svg+xml;charset=UTF-8,"+encodeURIComponent(c),scaledSize:new google.maps.Size(48,48),anchor:new google.maps.Point(24,24)};if(v){if(v.setIcon(d),r(v,i),b.getMap()){const t=`\n                <div class="text-gray-800 p-1">\n                    <h3 class="font-bold text-sm">${o(e.name)}</h3>\n                    <p class="text-xs mt-1">Status: <span style="color:${a}" class="font-semibold uppercase">${e.status}</span></p>\n                    <p class="text-xs text-gray-500 mt-1">Last seen: ${s(e.lastSeen||e.last_updated)}</p>\n                </div>\n            `;b.setContent(t)}}else v=new google.maps.Marker({position:i,map:y,title:e.name,icon:d,optimized:!1}),y.panTo(i),v.addListener("click",()=>{const t=`\n                <div class="text-gray-800 p-1">\n                    <h3 class="font-bold text-sm">${o(e.name)}</h3>\n                    <p class="text-xs mt-1">Status: <span style="color:${a}" class="font-semibold uppercase">${e.status}</span></p>\n                    <p class="text-xs text-gray-500 mt-1">Last seen: ${s(e.lastSeen||e.last_updated)}</p>\n                </div>\n            `;b.setContent(t),b.open(y,v)})}(e)}(x)):(n("Error","Device not found.","error"),setTimeout(()=>window.location.href="/app/devices.html",2e3))})}(f,w),function(t,n){const i=c(e,"user_data",t,"notifications"),a=d(i,l("deviceId","==",n),p("timestamp","desc"),g(50));m(a,e=>{k(e.docs.map(e=>({id:e.id,...e.data()})))},e=>{console.warn("Activity Query Error:",e),console.log("ðŸ‘‰ NOTE: If you see 'The query requires an index', click the link in the error above!"),k([])})}(f,w)}(C,f),function(t){const n=c(e,"user_data",t,"notifications"),i=d(n,l("read","==",!1));m(i,e=>{const t=e.docs.map(e=>({id:e.id,...e.data()}));t.sort((e,t)=>w(t)-w(e));!function(e){const t=h.notificationBadge;if(!t)return;e>0?(t.textContent=e>99?"99+":e,t.classList.remove("hidden"),t.classList.add("animate-pulse"),document.title=`(${e}) ${h.deviceName.textContent} - Trace'N Find`):(t.classList.add("hidden"),t.classList.remove("animate-pulse"),document.title=`${h.deviceName.textContent||"Device Details"} - Trace'N Find`)}(function(e){const t=[],n=new Map;return e.forEach(e=>{const i=w(e),a=`${e.type}|${e.title}|${e.message}`;if(n.has(a)){const e=n.get(a);if(Math.abs(i-e)<1e4)return}n.set(a,i),t.push(e)}),t}(t).length)},e=>{console.error("Error listening for unread count:",e)})}(C)):window.location.href="/app/devices.html"});
