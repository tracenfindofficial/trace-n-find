import"./modulepreload-polyfill-YP0FEG5d.js";import{f as t}from"./app-shell-CtSII-jN.js";import{a as e,b as o,c as n}from"./shared-utils-DEXrBstL.js";import{collection as s,getDocs as a,query as c,orderBy as r,onSnapshot as i,serverTimestamp as d,doc as l,getDoc as u,addDoc as p,setDoc as f,writeBatch as b,deleteDoc as m}from"https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";import"https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";let g=[],y=null;const k={createBackupBtn:document.getElementById("create-backup-btn"),backupList:document.getElementById("backup-list"),backupListEmpty:document.getElementById("backup-list-empty"),backupScopeSelect:document.getElementById("backupScope"),deviceOptionsGroup:document.getElementById("deviceOptions")};!function(t){const e=()=>{window.currentUserId?t(window.currentUserId):requestAnimationFrame(e)};window.currentUserId?t(window.currentUserId):requestAnimationFrame(e)}(v=>{!function(c){k.createBackupBtn&&k.createBackupBtn.addEventListener("click",()=>async function(n){o(k.createBackupBtn,!0);const c=k.backupScopeSelect.value;try{let o={},r={createdAt:d(),type:"full",deviceCount:0,geofenceCount:0,contactCount:0,hasProfile:!1,deviceName:null,data:""};if("full"===c||"contacts"===c){const e=l(t,"user_data",n,"profile","settings"),c=await u(e);c.exists()&&(o.profile=c.data(),r.hasProfile=!0);const i=s(t,"user_data",n,"contacts"),d=await a(i);d.empty||(o.contactsList=d.docs.map(t=>({id:t.id,...t.data()})),r.contactCount=o.contactsList.length)}if("full"!==c&&"contacts"!==c){const e=c,s=l(t,"user_data",n,"devices",e),a=await u(s);if(!a.exists())throw new Error("Selected device not found.");const i={id:a.id,...a.data()};o.devices=[i],r.type="single_device",r.deviceCount=1,r.deviceName=i.nickname||i.model||e}if("full"===c){const e=s(t,"user_data",n,"devices"),c=await a(e);o.devices=c.docs.map(t=>({id:t.id,...t.data()})),r.deviceCount=o.devices.length;const i=s(t,"user_data",n,"geofences"),d=await a(i);o.geofences=d.docs.map(t=>({id:t.id,...t.data()})),r.geofenceCount=o.geofences.length}"contacts"===c&&(r.type="contact_only"),r.data=JSON.stringify(o);const i=s(t,"user_data",n,"backups");await p(i,r);const b=l(t,"user_data",n,"profile","settings");await f(b,{pending_action:"backup_complete",last_backup:d()},{merge:!0}),e("Success","Backup snapshot created successfully.","success")}catch(r){console.error("Error creating backup:",r),e("Error","Could not create backup. "+r.message,"error")}finally{o(k.createBackupBtn,!1)}}(c));k.backupList&&k.backupList.addEventListener("click",s=>{const a=s.target.closest("button");if(!a)return;const r=a.dataset.id;a.matches(".btn-restore")?function(s,a){const c=g.find(t=>t.id===s);if(!c)return void e("Error","Backup not found.","error");try{!function(s,a,c=null,r="full",i=""){let d=s.profile||null,u=s.contactsList||[],p=s.devices||[],f=s.geofences||[];!Array.isArray(p)&&s.devices&&"object"==typeof s.devices&&s.devices[a]?.backup?.contacts&&(d=s.devices[a].backup.contacts);let m="Restore Data?",g="Are you sure you want to restore this data?";"contact_only"===r?(m="Restore Contacts?",g=`Are you sure you want to restore <strong>${u.length} contacts</strong> and profile settings?`):"single_device"===r?(m=`Restore ${i}?`,g=`Are you sure you want to restore data for <strong>${i}</strong>? <br>Current data for this specific device will be overwritten.`):(m="Restore Full Account?",g=`This will overwrite <strong>${p.length} devices</strong>, <strong>${f.length} geofences</strong>, and <strong>${u.length} contacts</strong>.`);n(m,g,"warning",async()=>{c&&o(c,!0),e("Restoring...","Applying data...","info");try{const o=b(t);let n=0;if(d){const e=l(t,"user_data",a,"profile","settings");o.set(e,d,{merge:!0}),n++}u.length>0&&u.forEach(e=>{if(e.id){const s=l(t,"user_data",a,"contacts",e.id);o.set(s,e),n++}}),p.length>0&&p.forEach(e=>{if(e.id){const s=l(t,"user_data",a,"devices",e.id);o.set(s,e),n++}}),f.length>0&&f.forEach(e=>{if(e.id){const s=l(t,"user_data",a,"geofences",e.id);o.set(s,e),n++}}),n>0?(await o.commit(),e("Success","Data restored successfully.","success")):e("Info","No data found in backup to restore.","info")}catch(n){console.error("Error restoring data:",n),e("Error","Could not restore data.","error")}finally{c&&o(c,!1)}},()=>{c&&o(c,!1)})}(JSON.parse(c.data),a,null,c.type,c.deviceName)}catch(r){console.error("Error parsing backup data:",r),e("Error","Corrupt backup data.","error")}}(r,c):a.matches(".btn-download")?function(t){const o=g.find(e=>e.id===t);if(!o||!o.data)return void e("Error","Backup data not found.","error");try{const t=o.createdAt?.toDate()?o.createdAt.toDate().toISOString().split("T")[0]:"backup";let n="full";"contact_only"===o.type&&(n="contact"),"single_device"===o.type&&(n="device");const s=`tracenfind_${n}_backup_${t}.json`,a=new Blob([o.data],{type:"application/json"}),c=URL.createObjectURL(a),r=document.createElement("a");r.href=c,r.download=s,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(c),e("Downloading","Backup file downloading.","success")}catch(n){console.error("Error creating download:",n),e("Error","Could not prepare download.","error")}}(r):a.matches(".btn-delete")&&function(o,s){n("Delete Snapshot?","Are you sure you want to delete this backup snapshot? This action cannot be undone.","danger",async()=>{try{const n=l(t,"user_data",s,"backups",o);await m(n),e("Success","Backup snapshot deleted.","success")}catch(n){console.error("Error deleting backup:",n),e("Error","Could not delete backup.","error")}})}(r,c)})}(v),function(o){y&&y();const n=s(t,"user_data",o,"backups"),a=c(n,r("createdAt","desc"));y=i(a,t=>{g=t.docs.map(t=>({id:t.id,...t.data()})),function(){if(!k.backupList)return;if(k.backupList.innerHTML="",!g||0===g.length)return k.backupList.appendChild(k.backupListEmpty),void(k.backupListEmpty.style.display="block");k.backupListEmpty.style.display="none",g.forEach((t,e)=>{const o=document.createElement("div");o.className="backup-list-item",o.style.animationDelay=30*e+"ms";const n=t.createdAt?.toDate()?t.createdAt.toDate().toLocaleString():"Just now",s=t.hasProfile,a=t.contactCount||0,c=t.type||"full";let r="",i="bi-hdd-network";if("contact_only"===c)r=`<span class="text-success font-medium"><i class="bi bi-person-lines-fill"></i> ${a} Contacts & Profile</span>`,i="bi-person-rolodex";else if("single_device"===c){r=`<span class="text-primary font-medium"><i class="bi bi-phone"></i> ${t.deviceName||"Unknown Device"}</span>`,i="bi-phone"}else{r=`<span class="text-text-secondary">${t.deviceCount||0} devices, ${t.geofenceCount||0} geofences, ${a} contacts</span>`,s&&(r+=' <span class="text-success text-xs mx-1">â€¢ Profile</span>')}o.innerHTML=`\n            <div class="backup-icon-wrapper">\n                <i class="bi ${i}"></i>\n            </div>\n            <div class="flex-1">\n                <div class="font-semibold text-text-primary dark:text-dark-text-primary">Snapshot - ${n}</div>\n                <div class="text-sm text-text-secondary dark:text-dark-text-secondary mt-0.5">${r}</div>\n            </div>\n            <div class="flex flex-col sm:flex-row gap-2">\n                <button class="btn btn-sm btn-secondary btn-restore" data-id="${t.id}" title="Restore">\n                    <i class="bi bi-arrow-counterclockwise mr-1"></i> Restore\n                </button>\n                <button class="btn btn-sm btn-secondary btn-download" data-id="${t.id}" title="Download">\n                    <i class="bi bi-download mr-1"></i> JSON\n                </button>\n                <button class="btn btn-sm btn-secondary btn-delete" data-id="${t.id}" title="Delete">\n                    <i class="bi bi-trash-fill text-danger"></i>\n                </button>\n            </div>\n        `,k.backupList.appendChild(o)})}()},t=>{console.error("Error listening for backups:",t),e("Error","Could not load backup history.","error"),k.backupListEmpty&&(k.backupListEmpty.style.display="block")})}(v),async function(e){if(!k.deviceOptionsGroup)return;try{const o=s(t,"user_data",e,"devices"),n=await a(o);if(k.deviceOptionsGroup.innerHTML="",n.empty){const t=document.createElement("option");return t.disabled=!0,t.textContent="No devices found",void k.deviceOptionsGroup.appendChild(t)}n.forEach(t=>{const e=t.data(),o=document.createElement("option");o.value=t.id;const n=e.nickname||e.model||`Device ${t.id.substring(0,6)}`;o.textContent=n,k.deviceOptionsGroup.appendChild(o)})}catch(o){console.error("Error loading devices for backup options:",o),k.deviceOptionsGroup.innerHTML="<option disabled>Error loading devices</option>"}}(v)});
